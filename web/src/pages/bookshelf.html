<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>我的书架 - 百变书屋</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="../css/output.css">
  <style>
    /* 自定义样式 - 让书籍卡片靠左排列，更紧凑 */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
    }
    
    /* 导航栏样式 - 使用!important确保样式不被覆盖 */
    header {
      background-color: white !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
      z-index: 9999 !important;
      width: 100% !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      height: auto !important;
      overflow: visible !important;
    }
    
    nav {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    .nav-item {
      color: #4b5563 !important;
      transition: color 0.2s !important;
      display: inline-block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    .nav-item:hover {
      color: #3b82f6 !important;
    }
    
    .nav-item.active {
      color: #3b82f6 !important;
      font-weight: 600 !important;
    }
    
    .nav-menu {
      z-index: 9999 !important;
    }
    
    /* 确保导航栏中的元素可见 */
    header * {
      visibility: visible !important;
    }
    
    /* 确保导航栏中的flex元素正确显示 */
    header .flex {
      display: flex !important;
    }
    
    /* 确保导航栏中的inline-block元素正确显示 */
    header .nav-item,
    header button,
    header i {
      display: inline-block !important;
    }
    
    /* 确保导航栏中的图标正确显示 */
    header i {
      display: inline-block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    .book-card {
      width: 100%;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .book-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* 移出书架按钮样式 */
    .remove-from-shelf-btn {
      color: #ef4444;
      transition: all 0.2s;
      border: 1px solid #fee2e2;
      background-color: #fff1f1;
    }
    
    .remove-from-shelf-btn:hover {
      background-color: #fee2e2;
      transform: scale(1.05);
    }
    
    /* 详情按钮样式 */
    .book-card a {
      transition: all 0.2s;
      border: 1px solid #e6f0fd;
      background-color: #f0f7ff;
    }
    
    .book-card a:hover {
      background-color: #e6f0fd;
      transform: scale(1.05);
    }
    
    /* 筛选和排序下拉菜单样式 */
    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 0.5rem;
      width: 200px;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 9999;
      border: 1px solid #e5e7eb;
      padding: 0.5rem 0;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    
    .dropdown-menu.show {
      display: block !important; /* 使用!important确保显示 */
      opacity: 1;
      visibility: visible;
    }
    
    /* 搜索框和按钮布局 */
    @media (max-width: 768px) {
      .flex-col.md\:flex-row {
        gap: 1rem;
      }
    }
    
    /* 确保相对定位正确 */
    .relative {
      position: relative !important;
    }
    
    /* 移动设备适配 */
    @media (max-width: 768px) {
      .flex.space-x-2 {
        margin-top: 0.5rem;
        justify-content: space-between;
        width: 100%;
      }
      
      #filter-btn, #sort-btn, #add-book-btn {
        padding: 0.5rem;
        font-size: 0.875rem;
      }
      
      #filter-btn span, #sort-btn span, #add-book-btn span {
        display: none;
      }
      
      #filter-btn i, #sort-btn i, #add-book-btn i {
        margin-right: 0;
      }
      
      .dropdown-menu {
        width: 180px;
        right: auto;
        left: 0;
      }
    }
    
    /* 按钮悬停效果 */
    #filter-btn:hover, #sort-btn:hover {
      background-color: #f9fafb;
      border-color: #d1d5db;
    }
    
    #add-book-btn:hover {
      background-color: #3b82f6;
    }
    
    /* 三点菜单样式 */
    .dropdown-container {
      position: relative !important;
      z-index: 20;
    }
    
    .card-menu-btn {
      cursor: pointer;
      z-index: 30;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .dropdown-menu {
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      overflow: hidden;
      min-width: 150px;
      padding: 0.5rem 0;
      display: none; /* 确保初始状态是隐藏的 */
    }
    
    .dropdown-menu a, 
    .dropdown-menu button {
      transition: all 0.2s;
      text-align: left;
      display: flex;
      align-items: center;
    }
    
    /* 改进的书籍卡片样式 */
    .book-card {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 380px;
    }
    
    .book-card .book-cover {
      transition: transform 0.3s;
    }
    
    .book-card:hover .book-cover {
      transform: scale(1.03);
    }
    
    /* 确保菜单按钮可点击 */
    .card-menu-btn {
      cursor: pointer;
      z-index: 30;
    }
    
    /* 确保下拉菜单在显示时位于顶层 */
    .dropdown-menu:not(.hidden) {
      z-index: 50;
      display: block !important;
      position: absolute;
      right: 0;
      top: 28px !important; /* 固定距离，与按钮靠在一起 */
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      min-width: 150px;
      padding: 0.5rem 0;
      opacity: 1;
      visibility: visible;
    }
    
    /* 修复搜索结果中的菜单显示问题 */
    .book-card .dropdown-container {
      position: relative !important;
      z-index: 20;
    }
    
    .book-card .dropdown-menu {
      position: absolute !important;
      right: auto !important; /* 不要固定在右侧 */
      left: 0 !important; /* 从左侧开始 */
      top: 28px !important; /* 固定距离，与按钮靠在一起 */
      z-index: 100 !important;
      display: none; /* 确保初始状态是隐藏的 */
    }
    
    .book-card .dropdown-menu:not(.hidden) {
      display: block !important;
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    /* 确保所有下拉菜单在页面加载时都是隐藏的 */
    .hidden {
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
    }
  </style>
</head>
<body>
  <!-- 导航栏 -->
  <header class="w-full bg-white shadow-md fixed top-0 left-0 right-0 z-50" style="display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important; overflow: visible !important;">
    <nav class="container mx-auto px-4 py-3 flex justify-between items-center" style="display: flex !important; visibility: visible !important; opacity: 1 !important;">
      <div class="flex items-center" style="display: flex !important; visibility: visible !important;">
        <img src="../images/logo.svg" alt="百变书屋" class="h-10" style="display: inline-block !important; visibility: visible !important;">
        <span class="ml-2 text-lg font-bold" style="display: inline !important; visibility: visible !important;">百变书屋</span>
      </div>
      
      <div class="hidden md:flex items-center space-x-6" style="display: flex !important; visibility: visible !important; opacity: 1 !important;">
        <a href="/" class="nav-item font-medium" style="display: inline-block !important; visibility: visible !important;">首页</a>
        <a href="search.html" class="nav-item font-medium" style="display: inline-block !important; visibility: visible !important;">智能搜索</a>
        <a href="bookshelf.html" class="nav-item active font-medium" style="display: inline-block !important; visibility: visible !important;">我的书架</a>
        <a href="community.html" class="nav-item font-medium" style="display: inline-block !important; visibility: visible !important;">阅读社区</a>
      </div>
      
      <div class="flex items-center space-x-4" style="display: flex !important; visibility: visible !important;">
        <a href="#" class="profile-button w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white" style="display: flex !important; visibility: visible !important;">
          <i class="fas fa-user" style="display: inline-block !important; visibility: visible !important;"></i>
        </a>
        <button class="menu-button md:hidden text-gray-600" style="display: inline-block !important; visibility: visible !important;">
          <i class="fas fa-bars text-xl" style="display: inline-block !important; visibility: visible !important;"></i>
        </button>
      </div>
    </nav>
    
    <!-- 移动端菜单 -->
    <div class="nav-menu hidden md:hidden mt-2 bg-white shadow-lg rounded-lg absolute right-4 left-4 p-4 z-50">
      <div class="flex flex-col space-y-3">
        <a href="home.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">首页</a>
        <a href="search.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">智能搜索</a>
        <a href="bookshelf.html" class="nav-item active py-2 px-4 rounded hover:bg-gray-100">我的书架</a>
        <a href="community.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">社区</a>
      </div>
    </div>
  </header>
  
  <!-- 添加一个占位符，确保内容不被固定导航栏遮挡 -->
  <div class="h-16"></div>
  
  <!-- 主要内容 -->
  <main class="page-container py-6 bookshelf-container">
    <!-- 书架标题和统计 -->
    <section class="mb-8">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
        <div>
          <h1 class="text-3xl font-bold mb-2">我的书架</h1>
          <p class="text-gray-600">管理您收藏的书籍，追踪阅读进度，添加笔记和标记。</p>
        </div>
        <div class="mt-4 md:mt-0 flex items-center">
          <div class="bg-white rounded-lg shadow-sm px-4 py-3 flex items-center">
            <div class="mr-6">
              <div class="text-gray-500 text-sm">收藏书籍</div>
              <div class="font-bold text-xl" id="total-books">0</div>
            </div>
            <div class="mr-6">
              <div class="text-gray-500 text-sm">已读完</div>
              <div class="font-bold text-xl" id="finished-books">0</div>
            </div>
            <div>
              <div class="text-gray-500 text-sm">阅读中</div>
              <div class="font-bold text-xl" id="reading-books">0</div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- 搜索栏和操作按钮 -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
      <!-- 搜索栏 -->
      <div class="relative md:w-1/2 lg:w-2/5 w-full">
        <input type="text" id="search-input" class="search-input w-full px-4 py-2 pr-16 border rounded-lg" placeholder="搜索书籍名称、作者或简介..." onkeypress="if(event.key === 'Enter') { event.preventDefault(); if(window.performBookshelfSearch) window.performBookshelfSearch(this.value.trim()); }">
        <button id="search-button" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700" onclick="if(window.performBookshelfSearch) window.performBookshelfSearch(document.getElementById('search-input').value.trim());">
          <i class="fas fa-search"></i>
        </button>
      </div>
      
      <!-- 筛选和排序按钮 -->
      <div class="flex space-x-2 flex-shrink-0">
        <div class="relative">
          <button id="sort-btn" class="bg-white border border-gray-300 rounded-lg px-4 py-2 flex items-center text-gray-700">
            <i class="fas fa-sort mr-2"></i>
            <span>排序</span>
            <i class="fas fa-chevron-down ml-2 text-xs"></i>
          </button>
          <!-- 排序下拉菜单 -->
          <div id="sort-menu" class="dropdown-menu hidden" style="display: none;">
            <div class="p-3">
              <div class="font-medium mb-2">排序方式</div>
              <div class="space-y-2">
                <a href="#" class="sort-option block py-1 hover:text-blue-500" data-sort="date-desc">
                  <i class="fas fa-check mr-2 text-blue-500 invisible"></i>最近添加
                </a>
                <a href="#" class="sort-option block py-1 hover:text-blue-500" data-sort="title-asc">
                  <i class="fas fa-check mr-2 text-blue-500 invisible"></i>书名 A-Z
                </a>
                <a href="#" class="sort-option block py-1 hover:text-blue-500" data-sort="title-desc">
                  <i class="fas fa-check mr-2 text-blue-500 invisible"></i>书名 Z-A
                </a>
                <a href="#" class="sort-option block py-1 hover:text-blue-500" data-sort="progress">
                  <i class="fas fa-check mr-2 text-blue-500 invisible"></i>阅读进度
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <button id="add-book-btn" class="bg-blue-500 hover:bg-blue-600 text-white rounded-lg px-4 py-2 flex items-center" onclick="window.location.href='search.html'">
          <i class="fas fa-plus mr-2"></i>
          <span>添加书籍</span>
        </button>
      </div>
    </div>
    
    <!-- 分类标签 -->
    <div class="mb-6 border-b">
      <div class="flex space-x-6">
        <a href="#" class="category-tab active border-b-2 border-blue-500 text-blue-500 py-2 font-medium" data-category="all">全部</a>
        <a href="#" class="category-tab border-b-2 border-transparent text-gray-500 py-2 font-medium" data-category="reading">阅读中</a>
        <a href="#" class="category-tab border-b-2 border-transparent text-gray-500 py-2 font-medium" data-category="completed">已读完</a>
        <a href="#" class="category-tab border-b-2 border-transparent text-gray-500 py-2 font-medium" data-category="toRead">未读</a>
      </div>
    </div>
    
    <!-- 书架内容 -->
    <section class="mb-8">
      <!-- 全部书籍 -->
      <div class="category-content" data-category="all">
        <div class="grid">
          <!-- 书籍将通过JavaScript动态加载 -->
        </div>
      </div>
      
      <!-- 阅读中 -->
      <div class="category-content hidden" data-category="reading">
        <div class="grid">
          <!-- 书籍将通过JavaScript动态加载 -->
        </div>
      </div>
      
      <!-- 已读完 -->
      <div class="category-content hidden" data-category="completed">
        <div class="grid">
          <!-- 书籍将通过JavaScript动态加载 -->
        </div>
      </div>
      
      <!-- 未读 -->
      <div class="category-content hidden" data-category="toRead">
        <div class="grid">
          <!-- 书籍将通过JavaScript动态加载 -->
        </div>
      </div>
    </section>
    
    <!-- 空状态 -->
    <div id="empty-state" class="hidden text-center py-12">
      <img src="../images/empty-bookshelf.svg" alt="空书架" class="mx-auto w-40 h-40 mb-4">
      <h3 class="text-xl font-bold mb-2">您的书架还是空的</h3>
      <p class="text-gray-600 mb-4">开始添加书籍到您的书架，追踪您的阅读进度。</p>
      <button id="add-first-book-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg" onclick="window.location.href='search.html'">
        <i class="fas fa-plus mr-2"></i>添加第一本书
      </button>
    </div>
  </main>
  
  <!-- 页脚 -->
  <footer class="bg-gray-800 text-white py-8 mt-12">
    <div class="page-container">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <h3 class="text-lg font-bold mb-4">百变书屋</h3>
          <p class="text-gray-400">您的私人智能图书馆，为您提供个性化的阅读体验。</p>
        </div>
        
        <div>
          <h3 class="text-lg font-bold mb-4">功能</h3>
          <ul class="space-y-2 text-gray-400">
            <li><a href="home.html" class="hover:text-white">首页</a></li>
            <li><a href="search.html" class="hover:text-white">智能搜索</a></li>
            <li><a href="bookshelf.html" class="hover:text-white">我的书架</a></li>
            <li><a href="community.html" class="hover:text-white">社区</a></li>
          </ul>
        </div>
        
        <div>
          <h3 class="text-lg font-bold mb-4">关于我们</h3>
          <ul class="space-y-2 text-gray-400">
            <li><a href="#" class="hover:text-white">关于百变书屋</a></li>
            <li><a href="#" class="hover:text-white">联系我们</a></li>
            <li><a href="#" class="hover:text-white">隐私政策</a></li>
            <li><a href="#" class="hover:text-white">使用条款</a></li>
          </ul>
        </div>
        
        <div>
          <h3 class="text-lg font-bold mb-4">关注我们</h3>
          <div class="flex space-x-4 text-gray-400">
            <a href="#" class="hover:text-white text-xl"><i class="fab fa-weixin"></i></a>
            <a href="#" class="hover:text-white text-xl"><i class="fab fa-weibo"></i></a>
            <a href="#" class="hover:text-white text-xl"><i class="fab fa-qq"></i></a>
            <a href="#" class="hover:text-white text-xl"><i class="fab fa-github"></i></a>
          </div>
        </div>
      </div>
      
      <div class="mt-8 pt-6 border-t border-gray-700 text-center text-gray-400 text-sm">
        <p>© 2023 百变书屋 - 私人智能图书馆. 保留所有权利.</p>
      </div>
    </div>
  </footer>
  
  <!-- 先加载main.js，再加载bookshelf.js，确保bookshelf.js中的函数可以覆盖main.js中的函数 -->
  <script type="module" src="../js/main.js"></script>
  <script type="module" src="../js/bookshelf.js"></script>
  <script type="module" src="../js/profile-button.js"></script>
  
  <!-- 添加一个立即执行的内联脚本，确保所有下拉菜单在页面加载时都是隐藏的 -->
  <script>
    // 页面加载时立即执行
    (function() {
      // 确保所有下拉菜单在页面加载时都是隐藏的
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.classList.add('hidden');
        menu.style.display = 'none';
      });
    })();
    
    // 页面完全加载后执行
    window.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded: 确保所有下拉菜单在页面加载时都是隐藏的');
      
      // 确保所有下拉菜单在页面加载时都是隐藏的
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.classList.add('hidden');
        menu.style.display = 'none';
      });
      
      // 初始化排序按钮点击事件
      const sortBtn = document.getElementById('sort-btn');
      const sortMenu = document.getElementById('sort-menu');
      
      if (sortBtn && sortMenu) {
        console.log('找到排序按钮和菜单，添加点击事件');
        
        sortBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          console.log('排序按钮被点击');
          
          // 获取当前菜单的显示状态
          const isHidden = sortMenu.classList.contains('hidden');
          
          // 先关闭所有菜单
          document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.add('hidden');
            menu.style.display = 'none';
          });
          
          // 如果当前菜单是隐藏的，则显示它
          if (isHidden) {
            sortMenu.classList.remove('hidden');
            sortMenu.style.display = 'block';
            sortMenu.style.opacity = '1';
            sortMenu.style.visibility = 'visible';
            
            // 确保菜单在视口内
            const rect = sortMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
              sortMenu.style.right = '0';
              sortMenu.style.left = 'auto';
            }
          }
        });
        
        // 添加排序选项点击事件
        const sortOptions = sortMenu.querySelectorAll('.sort-option');
        sortOptions.forEach(option => {
          option.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const sortBy = this.getAttribute('data-sort');
            console.log('选择排序方式:', sortBy);
            
            // 更新选中状态
            sortOptions.forEach(opt => {
              opt.querySelector('i').classList.add('invisible');
            });
            this.querySelector('i').classList.remove('invisible');
            
            // 应用排序
            if (window.applySortingFunction) {
              window.applySortingFunction(sortBy);
            } else if (typeof applySortingFunction === 'function') {
              applySortingFunction(sortBy);
            }
            
            // 隐藏菜单
            sortMenu.classList.add('hidden');
            sortMenu.style.display = 'none';
          });
        });
      }
    });
  </script>
  
  <!-- 添加一个立即执行的内联脚本，确保关键函数被正确导出 -->
  <script>
    // 检查模块脚本是否已加载完成
    function checkFunctionsExported() {
      console.log('检查关键函数是否已导出:');
      console.log('- performBookshelfSearch:', typeof window.performBookshelfSearch === 'function');
      console.log('- updateBookshelfDisplay:', typeof window.updateBookshelfDisplay === 'function');
      console.log('- generateBookshelfCard:', typeof window.generateBookshelfCard === 'function');
      console.log('- addBookshelfCardListeners:', typeof window.addBookshelfCardListeners === 'function');
      
      // 如果关键函数未导出，尝试手动导出
      if (typeof window.updateBookshelfDisplay !== 'function') {
        console.warn('updateBookshelfDisplay 未找到，将在DOMContentLoaded事件中再次检查');
      }
    }
    
    // 页面加载后立即检查
    window.addEventListener('load', function() {
      console.log('页面完全加载完成，检查函数导出状态');
      setTimeout(checkFunctionsExported, 100);
      
      // 确保所有下拉菜单在页面加载时处于关闭状态
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.classList.remove('show');
        menu.style.display = 'none';
      });
      
      // 添加全局点击事件，确保点击页面其他地方时关闭所有菜单
      document.addEventListener('click', function(e) {
        // 如果点击的不是排序按钮或其下拉菜单，也不是书籍卡片的下拉菜单容器，则关闭所有菜单
        if (!e.target.closest('#sort-btn') && 
            !e.target.closest('#sort-menu') && 
            !e.target.closest('.dropdown-container') &&
            !e.target.closest('header') && 
            !e.target.closest('nav') && 
            !e.target.closest('.nav-menu')) {
          
          // 关闭所有下拉菜单，但不影响导航栏
          document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.add('hidden');
            menu.style.display = 'none';
          });
        }
        
        // 如果点击的不是书籍卡片的下拉菜单容器，则关闭所有书籍卡片的下拉菜单
        if (!e.target.closest('.dropdown-container')) {
          document.querySelectorAll('.book-card .dropdown-menu').forEach(menu => {
            menu.classList.add('hidden');
            menu.style.display = 'none';
          });
        }
        
        // 如果点击的不是排序按钮或其下拉菜单，则关闭排序下拉菜单
        if (!e.target.closest('#sort-btn') && !e.target.closest('#sort-menu')) {
          const sortMenu = document.getElementById('sort-menu');
          if (sortMenu) {
            sortMenu.classList.add('hidden');
            sortMenu.style.display = 'none';
          }
        }
      });
    });
  </script>
  
  <!-- 添加一个新的内联脚本，确保在页面加载完成后调用addBookshelfCardListeners函数 -->
  <script>
    window.addEventListener('load', function() {
      // 确保在页面加载完成后调用addBookshelfCardListeners函数
      setTimeout(function() {
        console.log('尝试调用addBookshelfCardListeners函数');
        // 检查函数是否存在，并且不是循环引用
        if (typeof window.addBookshelfCardListeners === 'function') {
          console.log('调用addBookshelfCardListeners函数');
          try {
            window.addBookshelfCardListeners();
          } catch (error) {
            console.error('调用addBookshelfCardListeners函数时出错:', error);
          }
        } else {
          console.warn('addBookshelfCardListeners函数未找到');
        }
        
        // 确保三点菜单按钮可点击
        const menuButtons = document.querySelectorAll('.card-menu-btn');
        console.log('找到', menuButtons.length, '个菜单按钮');
        
        menuButtons.forEach(btn => {
          // 移除可能存在的旧事件监听器
          const newBtn = btn.cloneNode(true);
          if (btn.parentNode) {
            btn.parentNode.replaceChild(newBtn, btn);
          }
          
          const dropdownMenu = newBtn.nextElementSibling;
          if (!dropdownMenu) {
            console.error('未找到下拉菜单元素');
            return;
          }
          
          // 确保所有下拉菜单初始状态是隐藏的
          dropdownMenu.classList.add('hidden');
          dropdownMenu.style.display = 'none';
          
          newBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
            
            console.log('菜单按钮被点击');
            
            // 获取当前菜单的显示状态
            const isHidden = dropdownMenu.classList.contains('hidden');
            
            // 先关闭所有菜单
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
              menu.classList.add('hidden');
              menu.style.display = 'none';
            });
            
            // 如果当前菜单是隐藏的，则显示它
            if (isHidden) {
              dropdownMenu.classList.remove('hidden');
              
              // 强制设置菜单样式
              dropdownMenu.style.position = 'absolute';
              dropdownMenu.style.right = 'auto';
              dropdownMenu.style.left = '0';
              dropdownMenu.style.top = '28px'; // 直接设置固定距离，与按钮靠在一起
              dropdownMenu.style.zIndex = '100';
              dropdownMenu.style.backgroundColor = 'white';
              dropdownMenu.style.borderRadius = '0.5rem';
              dropdownMenu.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
              dropdownMenu.style.minWidth = '150px';
              dropdownMenu.style.display = 'block';
              dropdownMenu.style.opacity = '1';
              dropdownMenu.style.visibility = 'visible';
              
              // 确保菜单在视口内
              const rect = dropdownMenu.getBoundingClientRect();
              if (rect.right > window.innerWidth) {
                dropdownMenu.style.left = 'auto';
                dropdownMenu.style.right = '0';
              }
            }
            
            console.log('菜单状态:', dropdownMenu.classList.contains('hidden') ? '隐藏' : '显示');
          });
        });
      }, 500);
    });
  </script>
  
  <!-- 修改搜索函数，确保在已筛选的状态下进行搜索时能正确获取书籍卡片 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('内联脚本: DOMContentLoaded 事件触发');
      
      // 等待一小段时间，确保模块脚本已加载完成
      setTimeout(function() {
        // 检查搜索函数是否已加载
        if (!window.performBookshelfSearch) {
          console.error('performBookshelfSearch 函数未找到，尝试重新初始化');
          
          // 如果搜索函数未加载，尝试重新初始化
          const searchInput = document.getElementById('search-input');
          const searchButton = document.getElementById('search-button');
          
          if (searchInput && searchButton) {
            console.log('找到搜索元素，添加事件监听器');
            
            // 定义一个改进的搜索函数
            window.performBookshelfSearch = function(query) {
              console.log('执行搜索:', query);
              
              // 保存当前搜索查询
              window.currentSearchQuery = query;
              
              if (!query) {
                console.log('搜索内容为空，刷新页面');
                // 清除当前搜索查询
                window.currentSearchQuery = '';
                
                // 重新加载书架数据
                const bookshelfContent = document.querySelector('.category-content[data-category="all"]');
                if (bookshelfContent) {
                  bookshelfContent.innerHTML = `
                    <div class="text-center py-8">
                      <i class="fas fa-spinner fa-spin mr-2"></i> 刷新中...
                    </div>
                  `;
                  
                  // 延迟一下，显示加载状态
                  setTimeout(function() {
                    // 刷新页面
                    window.location.reload();
                  }, 500);
                }
                return;
              }
              
              // 显示加载状态
              const activeContent = document.querySelector('.category-content:not(.hidden)');
              if (!activeContent) return;
              
              const gridContainer = activeContent.querySelector('.grid');
              if (!gridContainer) return;
              
              gridContainer.innerHTML = `
                <div class="text-center py-8 col-span-full">
                  <i class="fas fa-spinner fa-spin mr-2"></i> 搜索中...
                </div>
              `;
              
              // 获取当前活跃的分类
              const category = activeContent.getAttribute('data-category');
              console.log('当前活跃分类:', category);
              
              // 使用模拟数据或window.currentBookshelfData
              const allBooks = window.currentBookshelfData || [];
              
              // 首先根据分类筛选书籍
              let categoryFilteredBooks = [];
              
              if (category === 'all') {
                // 显示所有书籍
                categoryFilteredBooks = [...allBooks];
              } else if (category === 'reading') {
                // 筛选阅读中的书籍
                categoryFilteredBooks = allBooks.filter(book => {
                  const status = book.status || (book.Book && book.Book.status) || 'toRead';
                  return status === 'reading';
                });
              } else if (category === 'completed') {
                // 筛选已读完的书籍
                categoryFilteredBooks = allBooks.filter(book => {
                  const status = book.status || (book.Book && book.Book.status) || 'toRead';
                  return status === 'completed' || status === 'finished';
                });
              } else if (category === 'toRead') {
                // 筛选未读的书籍
                categoryFilteredBooks = allBooks.filter(book => {
                  const status = book.status || (book.Book && book.Book.status) || 'toRead';
                  return status === 'toRead' || status === 'unread';
                });
              }
              
              console.log('分类筛选结果:', categoryFilteredBooks.length, '本书');
              
              // 然后根据搜索查询进一步筛选
              const searchQuery = query.toLowerCase();
              const searchResults = categoryFilteredBooks.filter(book => {
                const bookInfo = book.Book || book;
                const title = (bookInfo.title || '').toLowerCase();
                const author = (bookInfo.author || '').toLowerCase();
                const description = (bookInfo.description || '').toLowerCase();
                
                return title.includes(searchQuery) || 
                       author.includes(searchQuery) || 
                       description.includes(searchQuery);
              });
              
              console.log('搜索筛选结果:', searchResults.length, '本书');
              
              // 显示搜索结果
              gridContainer.innerHTML = '';
              
              if (searchResults.length === 0) {
                gridContainer.innerHTML = `
                  <div class="col-span-full text-center py-8">
                    <div class="text-gray-500 mb-4">
                      <i class="fas fa-search fa-3x mb-3"></i>
                      <p class="text-xl font-medium">没有找到匹配 "${query}" ${category !== 'all' ? `且${getCategoryName(category)}` : ''} 的书籍</p>
                    </div>
                    <button class="bg-blue-500 text-white px-4 py-2 rounded-lg" onclick="window.clearSearch()">
                      <i class="fas fa-times mr-2"></i>清除搜索
                    </button>
                  </div>
                `;
                return;
              }
              
              // 添加搜索结果标题和清除搜索按钮
              const searchResultHeader = document.createElement('div');
              searchResultHeader.className = 'mb-4 flex items-center justify-between col-span-full';
              searchResultHeader.innerHTML = `
                <div class="text-gray-700">
                  找到 <span class="font-medium">${searchResults.length}</span> 本匹配 "${query}" ${category !== 'all' ? `且${getCategoryName(category)}` : ''} 的书籍
                </div>
                <button class="text-blue-500 hover:text-blue-700 flex items-center" onclick="window.clearSearch()">
                  <i class="fas fa-times mr-1"></i>清除搜索
                </button>
              `;
              
              gridContainer.appendChild(searchResultHeader);
              
              // 添加书籍卡片
              searchResults.forEach(book => {
                if (window.generateBookshelfCard) {
                  const bookCardHtml = window.generateBookshelfCard(book);
                  const tempDiv = document.createElement('div');
                  tempDiv.innerHTML = bookCardHtml;
                  const bookCard = tempDiv.firstElementChild;
                  gridContainer.appendChild(bookCard);
                } else {
                  // 如果generateBookshelfCard函数未找到，使用简单的卡片
                  const bookInfo = book.Book || book;
                  const bookId = bookInfo.id || book.bookId || '';
                  const title = bookInfo.title || '未知标题';
                  const author = bookInfo.author || '未知作者';
                  const cover = bookInfo.coverUrl || bookInfo.cover || '../images/default-cover.jpg';
                  const progress = book.progress || 0;
                  const status = book.status || 'toRead';
                  
                  // 根据状态设置标签
                  let statusLabel = '';
                  let statusClass = '';
                  
                  if (status === 'reading') {
                    statusLabel = '阅读中';
                    statusClass = 'bg-blue-100 text-blue-800';
                  } else if (status === 'completed' || status === 'finished') {
                    statusLabel = '已完成';
                    statusClass = 'bg-green-100 text-green-800';
                  } else {
                    statusLabel = '未读';
                    statusClass = 'bg-yellow-100 text-yellow-800';
                  }
                  
                  const bookCard = document.createElement('div');
                  bookCard.className = 'book-card bg-white p-4 relative rounded-lg';
                  bookCard.dataset.bookId = bookId;
                  bookCard.innerHTML = `
                    <div class="absolute top-2 left-2 dropdown-container">
                      <button class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100 card-menu-btn">
                        <i class="fas fa-ellipsis-v"></i>
                      </button>
                      <div class="dropdown-menu hidden" style="position: absolute; left: 0; top: 28px; z-index: 100; background-color: white; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 150px; padding: 0.5rem 0; display: none;">
                        <a href="book-detail.html?id=${bookId}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                          <i class="fas fa-info-circle mr-2"></i>查看详情
                        </a>
                        <button class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-gray-100 remove-from-shelf-btn">
                          <i class="fas fa-times mr-2"></i>移出书架
                        </button>
                      </div>
                    </div>
                    
                    <div class="flex flex-col items-center">
                      <img src="${cover}" alt="${title}" class="book-cover w-32 h-48 mb-3 object-cover rounded">
                      <div class="text-center mb-4">
                        <h3 class="font-bold">${title}</h3>
                        <p class="text-gray-600 text-sm">${author}</p>
                      </div>
                    </div>
                    
                    <div class="mt-auto pt-3 border-t border-gray-100">
                      <div class="flex justify-between text-sm text-gray-500 mb-1">
                        <span>阅读进度</span>
                        <span>${progress}%</span>
                      </div>
                      <div class="bg-gray-200 rounded-full h-2 overflow-hidden mb-3">
                        <div class="bg-blue-500 h-full" style="width: ${progress}%"></div>
                      </div>
                      
                      <div class="flex justify-between items-center mt-3">
                        <span class="inline-block ${statusClass} text-xs px-2 py-1 rounded-full">${statusLabel}</span>
                        <button class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded continue-reading-btn">
                          ${status === 'reading' ? '继续阅读' : status === 'completed' ? '重新阅读' : '开始阅读'}
                        </button>
                      </div>
                    </div>
                  `;
                  gridContainer.appendChild(bookCard);
                }
              });
              
              // 添加事件监听器
              setTimeout(() => {
                if (typeof window.addBookshelfCardListeners === 'function') {
                  window.addBookshelfCardListeners();
                } else {
                  // 如果函数不存在，手动添加事件监听器
                  addCardListeners();
                }
              }, 200);
            };
            
            // 添加搜索按钮点击事件
            searchButton.addEventListener('click', function() {
              const query = searchInput.value.trim();
              window.performBookshelfSearch(query);
            });
            
            // 添加输入框回车事件
            searchInput.addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                const query = searchInput.value.trim();
                window.performBookshelfSearch(query);
              }
            });
          }
        } else {
          console.log('performBookshelfSearch 函数已加载');
          
          // 重新定义performBookshelfSearch函数，确保它保存搜索查询并在当前分类下搜索
          const originalPerformBookshelfSearch = window.performBookshelfSearch;
          window.performBookshelfSearch = function(query) {
            // 保存当前搜索查询
            window.currentSearchQuery = query || '';
            
            if (!query) {
              // 如果查询为空，清除搜索并刷新页面
              window.clearSearch();
              return;
            }
            
            // 获取当前活跃的分类
            const activeContent = document.querySelector('.category-content:not(.hidden)');
            if (!activeContent) return;
            
            const category = activeContent.getAttribute('data-category');
            console.log('当前活跃分类:', category);
            
            // 显示加载状态
            const gridContainer = activeContent.querySelector('.grid');
            if (gridContainer) {
              gridContainer.innerHTML = `
                <div class="text-center py-8 col-span-full">
                  <i class="fas fa-spinner fa-spin mr-2"></i> 搜索中...
                </div>
              `;
            }
            
            // 使用模拟数据或window.currentBookshelfData
            const allBooks = window.currentBookshelfData || [];
            
            // 首先根据分类筛选书籍
            let categoryFilteredBooks = [];
            
            if (category === 'all') {
              // 显示所有书籍
              categoryFilteredBooks = [...allBooks];
            } else if (category === 'reading') {
              // 筛选阅读中的书籍
              categoryFilteredBooks = allBooks.filter(book => {
                const status = book.status || (book.Book && book.Book.status) || 'toRead';
                return status === 'reading';
              });
            } else if (category === 'completed') {
              // 筛选已读完的书籍
              categoryFilteredBooks = allBooks.filter(book => {
                const status = book.status || (book.Book && book.Book.status) || 'toRead';
                return status === 'completed' || status === 'finished';
              });
            } else if (category === 'toRead') {
              // 筛选未读的书籍
              categoryFilteredBooks = allBooks.filter(book => {
                const status = book.status || (book.Book && book.Book.status) || 'toRead';
                return status === 'toRead' || status === 'unread';
              });
            }
            
            console.log('分类筛选结果:', categoryFilteredBooks.length, '本书');
            
            // 然后根据搜索查询进一步筛选
            const searchQuery = query.toLowerCase();
            const searchResults = categoryFilteredBooks.filter(book => {
              const bookInfo = book.Book || book;
              const title = (bookInfo.title || '').toLowerCase();
              const author = (bookInfo.author || '').toLowerCase();
              const description = (bookInfo.description || '').toLowerCase();
              
              return title.includes(searchQuery) || 
                     author.includes(searchQuery) || 
                     description.includes(searchQuery);
            });
            
            console.log('搜索筛选结果:', searchResults.length, '本书');
            
            // 显示搜索结果
            if (gridContainer) {
              gridContainer.innerHTML = '';
              
              if (searchResults.length === 0) {
                gridContainer.innerHTML = `
                  <div class="col-span-full text-center py-8">
                    <div class="text-gray-500 mb-4">
                      <i class="fas fa-search fa-3x mb-3"></i>
                      <p class="text-xl font-medium">没有找到匹配 "${query}" ${category !== 'all' ? `且${getCategoryName(category)}` : ''} 的书籍</p>
                    </div>
                    <button class="bg-blue-500 text-white px-4 py-2 rounded-lg" onclick="window.clearSearch()">
                      <i class="fas fa-times mr-2"></i>清除搜索
                    </button>
                  </div>
                `;
                return;
              }
              
              // 添加搜索结果标题和清除搜索按钮
              const searchResultHeader = document.createElement('div');
              searchResultHeader.className = 'mb-4 flex items-center justify-between col-span-full';
              searchResultHeader.innerHTML = `
                <div class="text-gray-700">
                  找到 <span class="font-medium">${searchResults.length}</span> 本匹配 "${query}" ${category !== 'all' ? `且${getCategoryName(category)}` : ''} 的书籍
                </div>
                <button class="text-blue-500 hover:text-blue-700 flex items-center" onclick="window.clearSearch()">
                  <i class="fas fa-times mr-1"></i>清除搜索
                </button>
              `;
              
              gridContainer.appendChild(searchResultHeader);
              
              // 添加书籍卡片
              searchResults.forEach(book => {
                if (window.generateBookshelfCard) {
                  const bookCardHtml = window.generateBookshelfCard(book);
                  gridContainer.innerHTML += bookCardHtml;
                }
              });
              
              // 添加事件监听器
              setTimeout(() => {
                if (typeof window.addBookshelfCardListeners === 'function') {
                  window.addBookshelfCardListeners();
                } else {
                  // 如果函数不存在，手动添加事件监听器
                  addCardListeners();
                }
              }, 200);
            }
          };
          
          // 确保搜索按钮和输入框有事件监听器
          const searchInput = document.getElementById('search-input');
          const searchButton = document.getElementById('search-button');
          
          if (searchInput && searchButton) {
            // 添加搜索按钮点击事件
            searchButton.addEventListener('click', function() {
              const query = searchInput.value.trim();
              window.performBookshelfSearch(query);
            });
            
            // 添加输入框回车事件
            searchInput.addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                const query = searchInput.value.trim();
                window.performBookshelfSearch(query);
              }
            });
          }
        }
      }, 500); // 等待500毫秒，确保模块脚本已加载
    });
    
    // 获取分类名称函数
    function getCategoryName(category) {
      switch (category) {
        case 'reading':
          return '阅读中';
        case 'completed':
          return '已读完';
        case 'toRead':
          return '未读';
        default:
          return '';
      }
    }
  </script>
  
  <!-- 添加一个新的内联脚本，确保移动端菜单按钮可以正常工作 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 移动端菜单切换
      const menuButton = document.querySelector('.menu-button');
      const navMenu = document.querySelector('.nav-menu');
      
      if (menuButton && navMenu) {
        console.log('找到移动端菜单按钮和菜单');
        
        menuButton.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          console.log('移动端菜单按钮被点击');
          
          // 切换菜单显示状态
          if (navMenu.classList.contains('hidden')) {
            navMenu.classList.remove('hidden');
            navMenu.style.display = 'block';
            navMenu.style.position = 'absolute';
            navMenu.style.top = '100%';
            navMenu.style.left = '0';
            navMenu.style.right = '0';
            navMenu.style.zIndex = '1001';
            navMenu.style.backgroundColor = 'white';
            navMenu.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            navMenu.style.borderRadius = '0.5rem';
            navMenu.style.margin = '0.5rem';
            navMenu.style.padding = '1rem';
          } else {
            navMenu.classList.add('hidden');
            navMenu.style.display = 'none';
          }
        });
      }
    });
  </script>
  
  <!-- 添加一个强制显示导航栏的JavaScript代码 -->
  <script>
    // 立即执行
    (function() {
      // 强制显示导航栏
      function forceShowNavbar() {
        console.log('强制显示导航栏');
        
        // 获取导航栏元素
        const header = document.querySelector('header');
        if (!header) {
          console.error('未找到导航栏元素');
          return;
        }
        
        // 强制显示导航栏
        header.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important; overflow: visible !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; z-index: 9999 !important; background-color: white !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;';
        
        // 强制显示导航栏内的元素
        const nav = header.querySelector('nav');
        if (nav) {
          nav.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important; justify-content: space-between !important; align-items: center !important;';
        }
        
        // 强制显示导航栏内的链接
        const navLinks = header.querySelectorAll('.nav-item');
        navLinks.forEach(link => {
          link.style.cssText = 'display: inline-block !important; visibility: visible !important; opacity: 1 !important;';
        });
        
        // 强制显示导航栏内的图标
        const icons = header.querySelectorAll('i');
        icons.forEach(icon => {
          icon.style.cssText = 'display: inline-block !important; visibility: visible !important; opacity: 1 !important;';
        });
      }
      
      // 立即执行
      forceShowNavbar();
      
      // 在DOMContentLoaded事件中再次执行
      document.addEventListener('DOMContentLoaded', forceShowNavbar);
      
      // 在load事件中再次执行
      window.addEventListener('load', forceShowNavbar);
      
      // 每隔100毫秒执行一次，确保导航栏始终可见
      let attempts = 0;
      const interval = setInterval(function() {
        forceShowNavbar();
        attempts++;
        
        // 最多尝试10次
        if (attempts >= 10) {
          clearInterval(interval);
        }
      }, 100);
    })();
  </script>
  
  <!-- 添加一个内联脚本，确保分类标签的点击事件能够正确筛选书籍 -->
  <script>
    // 保存当前搜索查询
    window.currentSearchQuery = '';
    
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化分类标签点击事件
      const categoryTabs = document.querySelectorAll('.category-tab');
      const categoryContents = document.querySelectorAll('.category-content');
      
      if (categoryTabs.length && categoryContents.length) {
        console.log('找到分类标签，添加点击事件');
        
        // 为每个标签添加点击事件
        categoryTabs.forEach(tab => {
          tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            console.log('分类标签被点击:', tab.getAttribute('data-category'));
            
            // 移除所有标签的活跃状态
            categoryTabs.forEach(t => {
              t.classList.remove('active', 'border-blue-500', 'text-blue-500');
              t.classList.add('border-transparent', 'text-gray-500');
            });
            
            // 添加当前标签的活跃状态
            tab.classList.add('active', 'border-blue-500', 'text-blue-500');
            tab.classList.remove('border-transparent', 'text-gray-500');
            
            // 获取分类
            const category = tab.getAttribute('data-category');
            
            // 隐藏所有内容
            categoryContents.forEach(content => {
              content.classList.add('hidden');
            });
            
            // 显示对应分类的内容
            const activeContent = document.querySelector(`.category-content[data-category="${category}"]`);
            if (activeContent) {
              activeContent.classList.remove('hidden');
            }
            
            // 根据分类筛选书籍，同时保留搜索结果
            filterBooksByCategory(category);
          });
        });
        
        // 根据分类筛选书籍
        function filterBooksByCategory(category) {
          console.log('筛选书籍，分类:', category, '当前搜索查询:', window.currentSearchQuery);
          
          // 获取所有书籍数据
          const allBooks = window.currentBookshelfData || [];
          
          // 首先根据搜索查询筛选书籍
          let searchFilteredBooks = allBooks;
          if (window.currentSearchQuery) {
            const searchQuery = window.currentSearchQuery.toLowerCase();
            searchFilteredBooks = allBooks.filter(book => {
              const bookInfo = book.Book || book;
              const title = (bookInfo.title || '').toLowerCase();
              const author = (bookInfo.author || '').toLowerCase();
              const description = (bookInfo.description || '').toLowerCase();
              
              return title.includes(searchQuery) || 
                     author.includes(searchQuery) || 
                     description.includes(searchQuery);
            });
            console.log('搜索筛选结果:', searchFilteredBooks.length, '本书');
          }
          
          // 然后根据分类进一步筛选
          let filteredBooks = [];
          
          if (category === 'all') {
            // 显示所有搜索结果
            filteredBooks = searchFilteredBooks;
          } else if (category === 'reading') {
            // 筛选阅读中的书籍
            filteredBooks = searchFilteredBooks.filter(book => {
              const status = book.status || (book.Book && book.Book.status) || 'toRead';
              return status === 'reading';
            });
          } else if (category === 'completed') {
            // 筛选已读完的书籍
            filteredBooks = searchFilteredBooks.filter(book => {
              const status = book.status || (book.Book && book.Book.status) || 'toRead';
              return status === 'completed' || status === 'finished';
            });
          } else if (category === 'toRead') {
            // 筛选未读的书籍
            filteredBooks = searchFilteredBooks.filter(book => {
              const status = book.status || (book.Book && book.Book.status) || 'toRead';
              return status === 'toRead' || status === 'unread';
            });
          }
          
          console.log('分类筛选结果:', filteredBooks.length, '本书');
          
          // 更新对应分类的内容
          const categoryContent = document.querySelector(`.category-content[data-category="${category}"]`);
          if (categoryContent) {
            // 清空内容
            const gridContainer = categoryContent.querySelector('.grid');
            if (gridContainer) {
              gridContainer.innerHTML = '';
              
              if (filteredBooks.length === 0) {
                // 显示空状态
                let message = '';
                if (window.currentSearchQuery) {
                  message = `没有找到匹配"${window.currentSearchQuery}"且${getCategoryName(category)}的书籍`;
                } else {
                  message = `没有找到${getCategoryName(category)}的书籍`;
                }
                
                gridContainer.innerHTML = `
                  <div class="col-span-full text-center py-8">
                    <div class="text-gray-500 mb-4">
                      <i class="fas fa-book fa-3x mb-3"></i>
                      <p class="text-xl font-medium">${message}</p>
                    </div>
                    ${window.currentSearchQuery ? `
                    <button class="bg-blue-500 text-white px-4 py-2 rounded-lg" onclick="window.clearSearch()">
                      <i class="fas fa-times mr-2"></i>清除搜索
                    </button>
                    ` : ''}
                  </div>
                `;
              } else {
                // 如果有搜索查询，显示搜索结果标题和清除搜索按钮
                if (window.currentSearchQuery) {
                  const searchResultHeader = document.createElement('div');
                  searchResultHeader.className = 'mb-4 flex items-center justify-between col-span-full';
                  searchResultHeader.innerHTML = `
                    <div class="text-gray-700">
                      找到 <span class="font-medium">${filteredBooks.length}</span> 本匹配 "${window.currentSearchQuery}" ${category !== 'all' ? `且${getCategoryName(category)}` : ''} 的书籍
                    </div>
                    <button class="text-blue-500 hover:text-blue-700 flex items-center" onclick="window.clearSearch()">
                      <i class="fas fa-times mr-1"></i>清除搜索
                    </button>
                  `;
                  gridContainer.appendChild(searchResultHeader);
                }
                
                // 生成书籍卡片
                filteredBooks.forEach(book => {
                  if (window.generateBookshelfCard) {
                    const bookCardHtml = window.generateBookshelfCard(book);
                    gridContainer.innerHTML += bookCardHtml;
                  }
                });
                
                // 添加事件监听器
                setTimeout(() => {
                  console.log('添加书籍卡片事件监听器');
                  
                  // 尝试使用window.addBookshelfCardListeners函数
                  if (typeof window.addBookshelfCardListeners === 'function') {
                    window.addBookshelfCardListeners();
                  } else {
                    // 如果函数不存在，手动添加事件监听器
                    window.addCardListeners();
                  }
                }, 200);
              }
            }
          }
        }
        
        // 手动添加卡片事件监听器
        window.addCardListeners = function() {
          // 为三点菜单按钮添加点击事件
          const menuButtons = document.querySelectorAll('.card-menu-btn');
          menuButtons.forEach(btn => {
            // 移除可能存在的旧事件监听器
            const newBtn = btn.cloneNode(true);
            if (btn.parentNode) {
              btn.parentNode.replaceChild(newBtn, btn);
            }
            
            const dropdownMenu = newBtn.nextElementSibling;
            if (!dropdownMenu) return;
            
            // 确保所有下拉菜单初始状态是隐藏的
            dropdownMenu.classList.add('hidden');
            dropdownMenu.style.display = 'none';
            
            newBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              e.preventDefault();
              
              // 获取当前菜单的显示状态
              const isHidden = dropdownMenu.classList.contains('hidden');
              
              // 先关闭所有菜单
              document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
                menu.style.display = 'none';
              });
              
              // 如果当前菜单是隐藏的，则显示它
              if (isHidden) {
                dropdownMenu.classList.remove('hidden');
                dropdownMenu.style.display = 'block';
                
                // 设置菜单样式
                dropdownMenu.style.position = 'absolute';
                dropdownMenu.style.right = 'auto';
                dropdownMenu.style.left = '0';
                dropdownMenu.style.top = '28px';
                dropdownMenu.style.zIndex = '100';
              }
            });
          });
          
          // 为移出书架按钮添加点击事件
          const removeButtons = document.querySelectorAll('.remove-from-shelf-btn');
          removeButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.preventDefault();
              
              // 获取书籍ID
              const bookCard = btn.closest('.book-card');
              if (!bookCard) return;
              
              const bookId = bookCard.getAttribute('data-book-id');
              if (!bookId) return;
              
              // 确认是否要移出书架
              if (confirm('确定要将这本书移出书架吗？')) {
                // 移出书架的逻辑
                console.log('移出书架:', bookId);
                
                // 如果有API函数，调用API
                if (window.removeFromBookshelf) {
                  window.removeFromBookshelf(bookId);
                }
              }
            });
          });
        };
      }
    });
    
    // 清除搜索函数
    window.clearSearch = function() {
      console.log('清除搜索');
      
      // 清除搜索框内容
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.value = '';
      }
      
      // 清除当前搜索查询
      window.currentSearchQuery = '';
      
      // 重新触发当前活跃标签的点击事件
      const activeTab = document.querySelector('.category-tab.active');
      if (activeTab) {
        activeTab.click();
      }
    };
    
    // 获取分类名称函数
    function getCategoryName(category) {
      switch (category) {
        case 'reading':
          return '阅读中';
        case 'completed':
          return '已读完';
        case 'toRead':
          return '未读';
        default:
          return '';
      }
    }
  </script>
  
  <!-- 添加一个内联脚本，确保在页面加载时能够正确显示所有书籍 -->
  <script>
    window.addEventListener('load', function() {
      console.log('页面加载完成，初始化书籍数据');
      
      // 确保书籍数据已加载
      setTimeout(function() {
        // 获取当前活跃的分类标签
        const activeTab = document.querySelector('.category-tab.active');
        if (activeTab) {
          const category = activeTab.getAttribute('data-category');
          console.log('当前活跃分类:', category);
          
          // 手动触发一次点击事件，确保正确筛选书籍
          activeTab.click();
          
          // 应用默认排序（最近添加）
          setTimeout(function() {
            // 获取排序函数
            if (typeof window.applySortingFunction === 'function') {
              console.log('应用默认排序: 最近添加');
              window.applySortingFunction('date-desc');
              
              // 更新排序选项的选中状态
              const sortOptions = document.querySelectorAll('.sort-option');
              sortOptions.forEach(opt => {
                opt.querySelector('i').classList.add('invisible');
              });
              
              const defaultSortOption = document.querySelector('.sort-option[data-sort="date-desc"]');
              if (defaultSortOption) {
                defaultSortOption.querySelector('i').classList.remove('invisible');
              }
            }
          }, 500);
        }
      }, 1000); // 等待1秒，确保书籍数据已加载
    });
  </script>
  
  <!-- 添加一个内联脚本，确保排序功能正确实现 -->
  <script>
    // 在全局范围内定义排序函数
    window.applySortingFunction = function(sortBy) {
      console.log('应用排序:', sortBy);
      
      // 获取当前活跃的分类内容
      const activeContent = document.querySelector('.category-content:not(.hidden)');
      if (!activeContent) return;
      
      // 获取分类
      const category = activeContent.getAttribute('data-category');
      console.log('当前分类:', category);
      
      // 获取所有书籍数据
      const allBooks = window.currentBookshelfData || [];
      if (!allBooks.length) {
        console.warn('没有找到书籍数据');
        return;
      }
      
      // 首先根据搜索查询筛选书籍
      let searchFilteredBooks = allBooks;
      if (window.currentSearchQuery) {
        const searchQuery = window.currentSearchQuery.toLowerCase();
        searchFilteredBooks = allBooks.filter(book => {
          const bookInfo = book.Book || book;
          const title = (bookInfo.title || '').toLowerCase();
          const author = (bookInfo.author || '').toLowerCase();
          const description = (bookInfo.description || '').toLowerCase();
          
          return title.includes(searchQuery) || 
                 author.includes(searchQuery) || 
                 description.includes(searchQuery);
        });
        console.log('搜索筛选结果:', searchFilteredBooks.length, '本书');
      }
      
      // 然后根据分类进一步筛选
      let filteredBooks = [];
      
      if (category === 'all') {
        // 显示所有搜索结果
        filteredBooks = [...searchFilteredBooks];
      } else if (category === 'reading') {
        // 筛选阅读中的书籍
        filteredBooks = searchFilteredBooks.filter(book => {
          const status = book.status || (book.Book && book.Book.status) || 'toRead';
          return status === 'reading';
        });
      } else if (category === 'completed') {
        // 筛选已读完的书籍
        filteredBooks = searchFilteredBooks.filter(book => {
          const status = book.status || (book.Book && book.Book.status) || 'toRead';
          return status === 'completed' || status === 'finished';
        });
      } else if (category === 'toRead') {
        // 筛选未读的书籍
        filteredBooks = searchFilteredBooks.filter(book => {
          const status = book.status || (book.Book && book.Book.status) || 'toRead';
          return status === 'toRead' || status === 'unread';
        });
      }
      
      console.log('分类筛选结果:', filteredBooks.length, '本书');
      
      // 根据排序方式排序书籍
      if (sortBy === 'date-desc') {
        // 最近添加（按添加时间降序排序）
        filteredBooks.sort((a, b) => {
          const dateA = a.addedAt || a.createdAt || (a.Book && (a.Book.addedAt || a.Book.createdAt)) || 0;
          const dateB = b.addedAt || b.createdAt || (b.Book && (b.Book.addedAt || b.Book.createdAt)) || 0;
          return new Date(dateB) - new Date(dateA);
        });
      } else if (sortBy === 'title-asc') {
        // 书名 A-Z
        filteredBooks.sort((a, b) => {
          const titleA = (a.title || (a.Book && a.Book.title) || '').toLowerCase();
          const titleB = (b.title || (b.Book && b.Book.title) || '').toLowerCase();
          return titleA.localeCompare(titleB);
        });
      } else if (sortBy === 'title-desc') {
        // 书名 Z-A
        filteredBooks.sort((a, b) => {
          const titleA = (a.title || (a.Book && a.Book.title) || '').toLowerCase();
          const titleB = (b.title || (b.Book && b.Book.title) || '').toLowerCase();
          return titleB.localeCompare(titleA);
        });
      } else if (sortBy === 'progress') {
        // 阅读进度
        filteredBooks.sort((a, b) => {
          const progressA = a.progress || 0;
          const progressB = b.progress || 0;
          return progressB - progressA;
        });
      }
      
      // 更新书架显示
      const gridContainer = activeContent.querySelector('.grid');
      if (gridContainer) {
        // 清空内容
        gridContainer.innerHTML = '';
        
        if (filteredBooks.length === 0) {
          // 显示空状态
          let message = '';
          if (window.currentSearchQuery) {
            message = `没有找到匹配"${window.currentSearchQuery}"且${getCategoryName(category)}的书籍`;
          } else {
            message = `没有找到${getCategoryName(category)}的书籍`;
          }
          
          gridContainer.innerHTML = `
            <div class="col-span-full text-center py-8">
              <div class="text-gray-500 mb-4">
                <i class="fas fa-book fa-3x mb-3"></i>
                <p class="text-xl font-medium">${message}</p>
              </div>
              ${window.currentSearchQuery ? `
              <button class="bg-blue-500 text-white px-4 py-2 rounded-lg" onclick="clearSearch()">
                <i class="fas fa-times mr-2"></i>清除搜索
              </button>
              ` : ''}
            </div>
          `;
        } else {
          // 如果有搜索查询，显示搜索结果标题和清除搜索按钮
          if (window.currentSearchQuery) {
            const searchResultHeader = document.createElement('div');
            searchResultHeader.className = 'mb-4 flex items-center justify-between col-span-full';
            searchResultHeader.innerHTML = `
              <div class="text-gray-700">
                找到 <span class="font-medium">${filteredBooks.length}</span> 本匹配 "${window.currentSearchQuery}" ${category !== 'all' ? `且${getCategoryName(category)}` : ''} 的书籍
              </div>
              <button class="text-blue-500 hover:text-blue-700 flex items-center" onclick="window.clearSearch()">
                <i class="fas fa-times mr-1"></i>清除搜索
              </button>
            `;
            gridContainer.appendChild(searchResultHeader);
          }
          
          // 生成书籍卡片
          filteredBooks.forEach(book => {
            if (window.generateBookshelfCard) {
              const bookCardHtml = window.generateBookshelfCard(book);
              gridContainer.innerHTML += bookCardHtml;
            }
          });
          
          // 添加事件监听器
          setTimeout(() => {
            if (typeof window.addBookshelfCardListeners === 'function') {
              window.addBookshelfCardListeners();
            } else {
              // 如果函数不存在，手动添加事件监听器
              addCardListeners();
            }
          }, 200);
        }
      }
    };
    
    // 获取分类名称
    function getCategoryName(category) {
      switch (category) {
        case 'reading':
          return '阅读中';
        case 'completed':
          return '已读完';
        case 'toRead':
          return '未读';
        default:
          return '';
      }
    }
    
    // 在页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
      // 获取排序选项
      const sortOptions = document.querySelectorAll('.sort-option');
      
      // 为排序选项添加点击事件
      sortOptions.forEach(option => {
        option.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // 获取排序方式
          const sortBy = this.getAttribute('data-sort');
          console.log('选择排序方式:', sortBy);
          
          // 更新选中状态
          sortOptions.forEach(opt => {
            opt.querySelector('i').classList.add('invisible');
          });
          this.querySelector('i').classList.remove('invisible');
          
          // 应用排序
          window.applySortingFunction(sortBy);
          
          // 隐藏菜单
          const sortMenu = document.getElementById('sort-menu');
          if (sortMenu) {
            sortMenu.classList.add('hidden');
            sortMenu.style.display = 'none';
          }
        });
      });
      
      // 初始化时默认选中"最近添加"选项
      const defaultSortOption = document.querySelector('.sort-option[data-sort="date-desc"]');
      if (defaultSortOption) {
        defaultSortOption.querySelector('i').classList.remove('invisible');
      }
    });
  </script>
</body>
</html> 