<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>我的书架 - 百变书屋</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="../css/output.css">
  <style>
    /* 自定义样式 - 让书籍卡片靠左排列，更紧凑 */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
    }
    
    .book-card {
      width: 100%;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .book-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* 移出书架按钮样式 */
    .remove-from-shelf-btn {
      color: #ef4444;
      transition: all 0.2s;
      border: 1px solid #fee2e2;
      background-color: #fff1f1;
    }
    
    .remove-from-shelf-btn:hover {
      background-color: #fee2e2;
      transform: scale(1.05);
    }
    
    /* 详情按钮样式 */
    .book-card a {
      transition: all 0.2s;
      border: 1px solid #e6f0fd;
      background-color: #f0f7ff;
    }
    
    .book-card a:hover {
      background-color: #e6f0fd;
      transform: scale(1.05);
    }
    
    /* 筛选和排序下拉菜单样式 */
    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 0.5rem;
      width: 200px;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 9999;
      border: 1px solid #e5e7eb;
    }
    
    .dropdown-menu.show {
      display: block !important; /* 使用!important确保显示 */
    }
    
    /* 搜索框和按钮布局 */
    @media (max-width: 768px) {
      .flex-col.md\:flex-row {
        gap: 1rem;
      }
    }
    
    /* 确保相对定位正确 */
    .relative {
      position: relative !important;
    }
    
    /* 移动设备适配 */
    @media (max-width: 768px) {
      .flex.space-x-2 {
        margin-top: 0.5rem;
        justify-content: space-between;
        width: 100%;
      }
      
      #filter-btn, #sort-btn, #add-book-btn {
        padding: 0.5rem;
        font-size: 0.875rem;
      }
      
      #filter-btn span, #sort-btn span, #add-book-btn span {
        display: none;
      }
      
      #filter-btn i, #sort-btn i, #add-book-btn i {
        margin-right: 0;
      }
      
      .dropdown-menu {
        width: 180px;
        right: auto;
        left: 0;
      }
    }
    
    /* 按钮悬停效果 */
    #filter-btn:hover, #sort-btn:hover {
      background-color: #f9fafb;
      border-color: #d1d5db;
    }
    
    #add-book-btn:hover {
      background-color: #3b82f6;
    }
    
    /* 三点菜单样式 */
    .dropdown-container {
      position: relative;
      z-index: 20;
    }
    
    .card-menu-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .dropdown-menu {
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      overflow: hidden;
      min-width: 150px;
    }
    
    .dropdown-menu a, 
    .dropdown-menu button {
      transition: all 0.2s;
      text-align: left;
      display: flex;
      align-items: center;
    }
    
    /* 改进的书籍卡片样式 */
    .book-card {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 380px;
    }
    
    .book-card .book-cover {
      transition: transform 0.3s;
    }
    
    .book-card:hover .book-cover {
      transform: scale(1.03);
    }
    
    /* 确保菜单按钮可点击 */
    .card-menu-btn {
      cursor: pointer;
      z-index: 30;
    }
    
    /* 确保下拉菜单在显示时位于顶层 */
    .dropdown-menu:not(.hidden) {
      z-index: 50;
    }
  </style>
</head>
<body>
  <!-- 导航栏 -->
  <nav class="navbar sticky top-0 z-10 px-4 py-3">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center">
        <img src="../images/logo.svg" alt="百变书屋" class="h-10">
        <span class="ml-2 text-lg font-bold">百变书屋</span>
      </div>
      
      <div class="hidden md:flex items-center space-x-6">
        <a href="/" class="nav-item font-medium">首页</a>
        <a href="search.html" class="nav-item font-medium">智能搜索</a>
        <a href="bookshelf.html" class="nav-item active font-medium">我的书架</a>
        <a href="community.html" class="nav-item font-medium">阅读社区</a>
      </div>
      
      <div class="flex items-center space-x-4">
        <a href="#" class="profile-button w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white">
          <i class="fas fa-user"></i>
        </a>
        <button class="menu-button md:hidden text-gray-600">
          <i class="fas fa-bars text-xl"></i>
        </button>
      </div>
    </div>
    
    <!-- 移动端菜单 -->
    <div class="nav-menu hidden md:hidden mt-2 bg-white shadow-lg rounded-lg absolute right-4 left-4 p-4">
      <div class="flex flex-col space-y-3">
        <a href="home.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">首页</a>
        <a href="search.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">智能搜索</a>
        <a href="bookshelf.html" class="nav-item active py-2 px-4 rounded hover:bg-gray-100">我的书架</a>
        <a href="community.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">社区</a>
      </div>
    </div>
  </nav>
  
  <!-- 主要内容 -->
  <main class="page-container py-6 bookshelf-container">
    <!-- 书架标题和统计 -->
    <section class="mb-8">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
        <div>
          <h1 class="text-3xl font-bold mb-2">我的书架</h1>
          <p class="text-gray-600">管理您收藏的书籍，追踪阅读进度，添加笔记和标记。</p>
        </div>
        <div class="mt-4 md:mt-0 flex items-center">
          <div class="bg-white rounded-lg shadow-sm px-4 py-3 flex items-center">
            <div class="mr-6">
              <div class="text-gray-500 text-sm">收藏书籍</div>
              <div class="font-bold text-xl" id="total-books">0</div>
            </div>
            <div class="mr-6">
              <div class="text-gray-500 text-sm">已读完</div>
              <div class="font-bold text-xl" id="finished-books">0</div>
            </div>
            <div>
              <div class="text-gray-500 text-sm">阅读中</div>
              <div class="font-bold text-xl" id="reading-books">0</div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- 搜索栏和操作按钮 -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
      <!-- 搜索栏 -->
      <div class="relative md:w-1/2 lg:w-2/5 w-full">
        <input type="text" id="search-input" class="search-input w-full px-4 py-2 pr-16 border rounded-lg" placeholder="搜索书籍名称、作者或简介..." onkeypress="if(event.key === 'Enter') { event.preventDefault(); if(window.performBookshelfSearch) window.performBookshelfSearch(this.value.trim()); }">
        <button id="search-button" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700" onclick="if(window.performBookshelfSearch) window.performBookshelfSearch(document.getElementById('search-input').value.trim());">
          <i class="fas fa-search"></i>
        </button>
      </div>
      
      <!-- 筛选和排序按钮 -->
      <div class="flex space-x-2 flex-shrink-0">
        <div class="relative">
          <button id="filter-btn" class="bg-white border border-gray-300 rounded-lg px-4 py-2 flex items-center text-gray-700">
            <i class="fas fa-filter mr-2"></i>
            <span>筛选</span>
            <i class="fas fa-chevron-down ml-2 text-xs"></i>
          </button>
          <!-- 筛选下拉菜单 -->
          <div id="filter-menu" class="dropdown-menu">
            <div class="p-3">
              <div class="font-medium mb-2">阅读状态</div>
              <div class="space-y-2">
                <label class="flex items-center">
                  <input type="radio" name="filter-status" value="all" checked class="mr-2">
                  <span>全部</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="filter-status" value="toRead" class="mr-2">
                  <span>未读</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="filter-status" value="reading" class="mr-2">
                  <span>阅读中</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="filter-status" value="completed" class="mr-2">
                  <span>已读完</span>
                </label>
              </div>
              <div class="mt-3 flex justify-end">
                <button id="apply-filter" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">应用</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="relative">
          <button id="sort-btn" class="bg-white border border-gray-300 rounded-lg px-4 py-2 flex items-center text-gray-700">
            <i class="fas fa-sort mr-2"></i>
            <span>排序</span>
            <i class="fas fa-chevron-down ml-2 text-xs"></i>
          </button>
          <!-- 排序下拉菜单 -->
          <div id="sort-menu" class="dropdown-menu">
            <div class="p-3">
              <div class="font-medium mb-2">排序方式</div>
              <div class="space-y-2">
                <a href="#" class="sort-option block py-1 hover:text-blue-500" data-sort="date-desc">
                  <i class="fas fa-check mr-2 text-blue-500 invisible"></i>最近添加
                </a>
                <a href="#" class="sort-option block py-1 hover:text-blue-500" data-sort="date-asc">
                  <i class="fas fa-check mr-2 text-blue-500 invisible"></i>最早添加
                </a>
                <a href="#" class="sort-option block py-1 hover:text-blue-500" data-sort="title-asc">
                  <i class="fas fa-check mr-2 text-blue-500 invisible"></i>书名 A-Z
                </a>
                <a href="#" class="sort-option block py-1 hover:text-blue-500" data-sort="title-desc">
                  <i class="fas fa-check mr-2 text-blue-500 invisible"></i>书名 Z-A
                </a>
                <a href="#" class="sort-option block py-1 hover:text-blue-500" data-sort="progress">
                  <i class="fas fa-check mr-2 text-blue-500 invisible"></i>阅读进度
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <button id="add-book-btn" class="bg-blue-500 hover:bg-blue-600 text-white rounded-lg px-4 py-2 flex items-center" onclick="window.location.href='search.html'">
          <i class="fas fa-plus mr-2"></i>
          <span>添加书籍</span>
        </button>
      </div>
    </div>
    
    <!-- 分类标签 -->
    <div class="mb-6 border-b">
      <div class="flex space-x-6">
        <a href="#" class="category-tab active border-b-2 border-blue-500 text-blue-500 py-2 font-medium" data-category="all">全部</a>
        <a href="#" class="category-tab border-b-2 border-transparent text-gray-500 py-2 font-medium" data-category="reading">阅读中</a>
        <a href="#" class="category-tab border-b-2 border-transparent text-gray-500 py-2 font-medium" data-category="completed">已读完</a>
        <a href="#" class="category-tab border-b-2 border-transparent text-gray-500 py-2 font-medium" data-category="toRead">未读</a>
      </div>
    </div>
    
    <!-- 书架内容 -->
    <section class="mb-8">
      <!-- 全部书籍 -->
      <div class="category-content" data-category="all">
        <div class="grid">
          <!-- 书籍将通过JavaScript动态加载 -->
        </div>
      </div>
      
      <!-- 阅读中 -->
      <div class="category-content hidden" data-category="reading">
        <div class="grid">
          <!-- 书籍将通过JavaScript动态加载 -->
        </div>
      </div>
      
      <!-- 已读完 -->
      <div class="category-content hidden" data-category="completed">
        <div class="grid">
          <!-- 书籍将通过JavaScript动态加载 -->
        </div>
      </div>
      
      <!-- 未读 -->
      <div class="category-content hidden" data-category="toRead">
        <div class="grid">
          <!-- 书籍将通过JavaScript动态加载 -->
        </div>
      </div>
    </section>
    
    <!-- 空状态 -->
    <div id="empty-state" class="hidden text-center py-12">
      <img src="../images/empty-bookshelf.svg" alt="空书架" class="mx-auto w-40 h-40 mb-4">
      <h3 class="text-xl font-bold mb-2">您的书架还是空的</h3>
      <p class="text-gray-600 mb-4">开始添加书籍到您的书架，追踪您的阅读进度。</p>
      <button id="add-first-book-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg" onclick="window.location.href='search.html'">
        <i class="fas fa-plus mr-2"></i>添加第一本书
      </button>
    </div>
  </main>
  
  <!-- 页脚 -->
  <footer class="bg-gray-800 text-white py-8 mt-12">
    <div class="page-container">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <h3 class="text-lg font-bold mb-4">百变书屋</h3>
          <p class="text-gray-400">您的私人智能图书馆，为您提供个性化的阅读体验。</p>
        </div>
        
        <div>
          <h3 class="text-lg font-bold mb-4">功能</h3>
          <ul class="space-y-2 text-gray-400">
            <li><a href="home.html" class="hover:text-white">首页</a></li>
            <li><a href="search.html" class="hover:text-white">智能搜索</a></li>
            <li><a href="bookshelf.html" class="hover:text-white">我的书架</a></li>
            <li><a href="community.html" class="hover:text-white">社区</a></li>
          </ul>
        </div>
        
        <div>
          <h3 class="text-lg font-bold mb-4">关于我们</h3>
          <ul class="space-y-2 text-gray-400">
            <li><a href="#" class="hover:text-white">关于百变书屋</a></li>
            <li><a href="#" class="hover:text-white">联系我们</a></li>
            <li><a href="#" class="hover:text-white">隐私政策</a></li>
            <li><a href="#" class="hover:text-white">使用条款</a></li>
          </ul>
        </div>
        
        <div>
          <h3 class="text-lg font-bold mb-4">关注我们</h3>
          <div class="flex space-x-4 text-gray-400">
            <a href="#" class="hover:text-white text-xl"><i class="fab fa-weixin"></i></a>
            <a href="#" class="hover:text-white text-xl"><i class="fab fa-weibo"></i></a>
            <a href="#" class="hover:text-white text-xl"><i class="fab fa-qq"></i></a>
            <a href="#" class="hover:text-white text-xl"><i class="fab fa-github"></i></a>
          </div>
        </div>
      </div>
      
      <div class="mt-8 pt-6 border-t border-gray-700 text-center text-gray-400 text-sm">
        <p>© 2023 百变书屋 - 私人智能图书馆. 保留所有权利.</p>
      </div>
    </div>
  </footer>
  
  <!-- 先加载bookshelf.js，再加载main.js，确保bookshelf.js中的函数不被覆盖 -->
  <script type="module" src="../js/bookshelf.js"></script>
  <script type="module" src="../js/main.js"></script>
  <script type="module" src="../js/profile-button.js"></script>
  
  <!-- 添加一个立即执行的内联脚本，确保关键函数被正确导出 -->
  <script>
    // 检查模块脚本是否已加载完成
    function checkFunctionsExported() {
      console.log('检查关键函数是否已导出:');
      console.log('- performBookshelfSearch:', typeof window.performBookshelfSearch === 'function');
      console.log('- updateBookshelfDisplay:', typeof window.updateBookshelfDisplay === 'function');
      console.log('- generateBookshelfCard:', typeof window.generateBookshelfCard === 'function');
      
      // 如果关键函数未导出，尝试手动导出
      if (typeof window.updateBookshelfDisplay !== 'function') {
        console.warn('updateBookshelfDisplay 未找到，将在DOMContentLoaded事件中再次检查');
      }
    }
    
    // 页面加载后立即检查
    window.addEventListener('load', function() {
      console.log('页面完全加载完成，检查函数导出状态');
      setTimeout(checkFunctionsExported, 100);
      
      // 添加全局点击事件，确保点击页面其他地方时关闭所有菜单
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown-container')) {
          document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.add('hidden');
          });
        }
      });
    });
  </script>
  
  <!-- 添加内联脚本，确保搜索功能可以正常工作 -->
  <script>
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
      console.log('内联脚本: DOMContentLoaded 事件触发');
      
      // 等待一小段时间，确保模块脚本已加载完成
      setTimeout(function() {
        // 检查搜索函数是否已加载
        if (!window.performBookshelfSearch) {
          console.error('performBookshelfSearch 函数未找到，尝试重新初始化');
          
          // 如果搜索函数未加载，尝试重新初始化
          const searchInput = document.getElementById('search-input');
          const searchButton = document.getElementById('search-button');
          
          if (searchInput && searchButton) {
            console.log('找到搜索元素，添加事件监听器');
            
            // 定义一个简单的搜索函数
            window.performBookshelfSearch = function(query) {
              console.log('执行搜索:', query);
              
              if (!query) {
                console.log('搜索内容为空，刷新页面');
                // 重新加载书架数据
                const bookshelfContent = document.querySelector('.category-content[data-category="all"]');
                if (bookshelfContent) {
                  bookshelfContent.innerHTML = `
                    <div class="text-center py-8">
                      <i class="fas fa-spinner fa-spin mr-2"></i> 刷新中...
                    </div>
                  `;
                  
                  // 延迟一下，显示加载状态
                  setTimeout(function() {
                    // 刷新页面
                    window.location.reload();
                  }, 500);
                }
                return;
              }
              
              // 显示加载状态
              const bookshelfContent = document.querySelector('.category-content[data-category="all"]');
              if (bookshelfContent) {
                bookshelfContent.innerHTML = `
                  <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin mr-2"></i> 搜索中...
                  </div>
                `;
                
                // 使用模拟数据或window.currentBookshelfData
                const booksToSearch = window.currentBookshelfData || [];
                
                // 过滤匹配的书籍
                const searchResults = booksToSearch.filter(book => {
                  const bookInfo = book.Book || book;
                  const title = (bookInfo.title || '').toLowerCase();
                  const author = (bookInfo.author || '').toLowerCase();
                  const description = (bookInfo.description || '').toLowerCase();
                  
                  const searchQuery = query.toLowerCase();
                  return title.includes(searchQuery) || 
                         author.includes(searchQuery) || 
                         description.includes(searchQuery);
                });
                
                // 显示搜索结果
                if (window.updateBookshelfDisplay) {
                  console.log('使用window.updateBookshelfDisplay显示搜索结果');
                  window.updateBookshelfDisplay(searchResults, query);
                } else {
                  console.error('updateBookshelfDisplay 函数未找到，使用备用方法显示搜索结果');
                  
                  // 简单显示搜索结果
                  bookshelfContent.innerHTML = '';
                  
                  if (searchResults.length === 0) {
                    bookshelfContent.innerHTML = `
                      <div class="text-center py-8">
                        <div class="text-gray-500 mb-4">
                          <i class="fas fa-search fa-3x mb-3"></i>
                          <p class="text-xl font-medium">没有找到匹配 "${query}" 的书籍</p>
                        </div>
                        <button class="bg-blue-500 text-white px-4 py-2 rounded-lg" onclick="window.location.reload()">
                          <i class="fas fa-times mr-2"></i>清除搜索
                        </button>
                      </div>
                    `;
                    return;
                  }
                  
                  // 创建书籍网格容器
                  const booksContainer = document.createElement('div');
                  booksContainer.className = 'grid';
                  bookshelfContent.appendChild(booksContainer);
                  
                  // 添加搜索结果标题
                  const searchResultHeader = document.createElement('div');
                  searchResultHeader.className = 'col-span-full mb-4';
                  searchResultHeader.innerHTML = `
                    <div class="flex items-center justify-between">
                      <div class="text-gray-700">
                        找到 <span class="font-medium">${searchResults.length}</span> 本匹配 "${query}" 的书籍
                      </div>
                      <button class="text-blue-500 hover:text-blue-700 flex items-center" onclick="window.location.reload()">
                        <i class="fas fa-times mr-1"></i>清除搜索
                      </button>
                    </div>
                  `;
                  booksContainer.appendChild(searchResultHeader);
                  
                  // 添加书籍卡片
                  searchResults.forEach(book => {
                    if (window.generateBookshelfCard) {
                      const bookCard = window.generateBookshelfCard(book);
                      booksContainer.appendChild(bookCard);
                    } else {
                      // 如果generateBookshelfCard函数未找到，使用简单的卡片
                      const bookInfo = book.Book || book;
                      const bookId = bookInfo.id || book.bookId || '';
                      const title = bookInfo.title || '未知标题';
                      const author = bookInfo.author || '未知作者';
                      const cover = bookInfo.coverUrl || bookInfo.cover || '../images/default-cover.jpg';
                      const progress = book.progress || 0;
                      const status = book.status || 'toRead';
                      
                      // 根据状态设置标签
                      let statusLabel = '';
                      let statusClass = '';
                      
                      if (status === 'reading') {
                        statusLabel = '阅读中';
                        statusClass = 'bg-blue-100 text-blue-800';
                      } else if (status === 'completed' || status === 'finished') {
                        statusLabel = '已完成';
                        statusClass = 'bg-green-100 text-green-800';
                      } else {
                        statusLabel = '未读';
                        statusClass = 'bg-yellow-100 text-yellow-800';
                      }
                      
                      const bookCard = document.createElement('div');
                      bookCard.className = 'book-card bg-white p-4 relative rounded-lg';
                      bookCard.dataset.bookId = bookId;
                      bookCard.innerHTML = `
                        <div class="absolute top-2 right-2 dropdown-container">
                          <button class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100 card-menu-btn">
                            <i class="fas fa-ellipsis-v"></i>
                          </button>
                          <div class="dropdown-menu hidden absolute right-0 mt-1 bg-white shadow-lg rounded-lg py-1 z-10 w-40">
                            <a href="book-detail.html?id=${bookId}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                              <i class="fas fa-info-circle mr-2"></i>查看详情
                            </a>
                            <button class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-gray-100" onclick="if(confirm('确定要从书架中移除这本书吗？')) window.location.reload()">
                              <i class="fas fa-times mr-2"></i>移出书架
                            </button>
                          </div>
                        </div>
                        
                        <div class="flex flex-col items-center">
                          <img src="${cover}" alt="${title}" class="book-cover w-32 h-48 mb-3 object-cover rounded">
                          <div class="text-center mb-4">
                            <h3 class="font-bold">${title}</h3>
                            <p class="text-gray-600 text-sm">${author}</p>
                          </div>
                        </div>
                        
                        <div class="mt-auto pt-3 border-t border-gray-100">
                          <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>阅读进度</span>
                            <span>${progress}%</span>
                          </div>
                          <div class="bg-gray-200 rounded-full h-2 overflow-hidden mb-3">
                            <div class="bg-blue-500 h-full" style="width: ${progress}%"></div>
                          </div>
                          
                          <div class="flex justify-between items-center mt-3">
                            <span class="inline-block ${statusClass} text-xs px-2 py-1 rounded-full">${statusLabel}</span>
                            <button class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded" onclick="window.location.href='reader.html?id=${bookId}'">
                              ${status === 'reading' ? '继续阅读' : status === 'completed' ? '重新阅读' : '开始阅读'}
                            </button>
                          </div>
                        </div>
                      `;
                      booksContainer.appendChild(bookCard);
                      
                      // 为三点菜单添加点击事件
                      const menuBtn = bookCard.querySelector('.card-menu-btn');
                      const dropdownMenu = bookCard.querySelector('.dropdown-menu');
                      if (menuBtn && dropdownMenu) {
                        menuBtn.addEventListener('click', function(e) {
                          e.stopPropagation();
                          // 关闭所有其他打开的菜单
                          document.querySelectorAll('.dropdown-menu').forEach(menu => {
                            if (menu !== dropdownMenu) {
                              menu.classList.add('hidden');
                            }
                          });
                          // 切换当前菜单的显示状态
                          dropdownMenu.classList.toggle('hidden');
                          console.log('菜单点击事件触发', dropdownMenu.classList.contains('hidden') ? '菜单已隐藏' : '菜单已显示');
                        });
                      }
                      
                      // 将卡片添加到DOM后再次确认事件绑定
                      setTimeout(() => {
                        const addedMenuBtn = bookCard.querySelector('.card-menu-btn');
                        if (addedMenuBtn) {
                          console.log('确认菜单按钮已添加到DOM');
                          // 移除旧事件，重新绑定
                          const newMenuBtn = addedMenuBtn.cloneNode(true);
                          addedMenuBtn.parentNode.replaceChild(newMenuBtn, addedMenuBtn);
                          
                          const addedDropdownMenu = bookCard.querySelector('.dropdown-menu');
                          newMenuBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            e.preventDefault();
                            // 关闭所有其他打开的菜单
                            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                              if (menu !== addedDropdownMenu) {
                                menu.classList.add('hidden');
                              }
                            });
                            // 切换当前菜单的显示状态
                            addedDropdownMenu.classList.toggle('hidden');
                            console.log('重新绑定的菜单事件触发', addedDropdownMenu.classList.contains('hidden') ? '菜单已隐藏' : '菜单已显示');
                          });
                        }
                      }, 100);
                    }
                  });
                  
                  // 添加事件监听器
                  if (window.attachBookCardEventListeners) {
                    window.attachBookCardEventListeners();
                  }
                }
              }
            };
          }
        } else {
          console.log('performBookshelfSearch 函数已加载');
        }
      }, 500); // 等待500毫秒，确保模块脚本已加载
    });
  </script>
</body>
</html> 