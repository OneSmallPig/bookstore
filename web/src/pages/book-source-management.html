<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>书源管理 - 百变书屋</title>
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- 添加通用脚本 -->
  <script src="/src/js/common.js"></script>
  <!-- 引入书源管理相关JS -->
  <script src="../js/booksource/import.js"></script>
  <style>
    .admin-only {
      background-color: #f97316;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      margin-left: 0.5rem;
    }

    .card {
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      background-color: white;
      overflow: hidden;
    }

    .card-header {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
      background-color: #f9fafb;
      font-weight: 600;
    }

    .card-body {
      padding: 1rem;
    }

    .tab-active {
      border-bottom: 2px solid #3b82f6;
      color: #3b82f6;
    }

    .source-item {
      transition: all 0.2s;
    }

    .source-item:hover {
      background-color: #f3f4f6;
    }
    
    /* 加载动画 */
    .loader {
      border: 3px solid #f3f3f3;
      border-radius: 50%;
      border-top: 3px solid #3b82f6;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 权限页面 */
    .auth-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #fff;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
    }
    
    .auth-icon {
      font-size: 4rem;
      color: #ef4444;
      margin-bottom: 1rem;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .btn-primary {
      background-color: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #2563eb;
    }
    
    .btn-outline {
      border: 1px solid #d1d5db;
      background-color: white;
    }
    
    .btn-outline:hover {
      background-color: #f9fafb;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- 管理员认证屏幕 - 默认隐藏 -->
  <div id="authScreen" class="auth-screen" style="display: none;">
    <div class="auth-icon">
      <i class="fas fa-lock"></i>
    </div>
    <h2 class="text-2xl font-bold mb-2">需要管理员权限</h2>
    <p class="mb-6 text-gray-600">抱歉，只有管理员可以访问此页面。请使用管理员账号登录。</p>
    <div class="flex space-x-4">
      <a href="login.html" class="btn btn-primary">
        <i class="fas fa-sign-in-alt mr-2"></i>登录
      </a>
      <a href="/" class="btn btn-outline">
        <i class="fas fa-home mr-2"></i>返回首页
      </a>
    </div>
  </div>

  <!-- 导航栏 -->
  <nav class="navbar sticky top-0 z-10 px-4 py-3 bg-white shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center">
        <img src="../images/logo.svg" alt="百变书屋" class="h-10">
        <span class="ml-2 text-lg font-bold">百变书屋</span>
      </div>
      
      <div class="hidden md:flex items-center space-x-6">
        <a href="/" class="nav-item font-medium">首页</a>
        <a href="search.html" class="nav-item font-medium">智能搜索</a>
        <a href="bookshelf.html" class="nav-item font-medium">我的书架</a>
        <a href="community.html" class="nav-item font-medium">阅读社区</a>
        <a href="book-source-management.html" class="nav-item active font-medium">
          书源管理
          <span class="admin-only">管理员</span>
        </a>
      </div>
      
      <div class="flex items-center space-x-4">
        <a href="profile.html" class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white">
          <i class="fas fa-user"></i>
        </a>
        <button class="menu-button md:hidden text-gray-600">
          <i class="fas fa-bars text-xl"></i>
        </button>
      </div>
    </div>
    
    <!-- 移动端菜单 -->
    <div class="nav-menu hidden md:hidden mt-2 bg-white shadow-lg rounded-lg absolute right-4 left-4 p-4 z-50">
      <div class="flex flex-col space-y-3">
        <a href="/" class="nav-item py-2 px-4 rounded hover:bg-gray-100">首页</a>
        <a href="search.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">智能搜索</a>
        <a href="bookshelf.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">我的书架</a>
        <a href="community.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">阅读社区</a>
        <a href="book-source-management.html" class="nav-item active py-2 px-4 rounded hover:bg-gray-100">
          书源管理
          <span class="admin-only">管理员</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- 主要内容容器 -->
  <main class="container mx-auto py-6 px-4">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">书源管理</h1>
      <div id="userInfo" class="text-sm text-gray-500">
        <span id="loadingStatus"><i class="fas fa-spinner fa-spin mr-2"></i>正在验证权限...</span>
      </div>
    </div>
    
    <!-- 功能选项卡 -->
    <div class="flex border-b border-gray-200 mb-6">
      <button id="tabSources" class="px-4 py-2 text-sm font-medium tab-active" data-tab="sourcesPanel">
        <i class="fas fa-list mr-2"></i>书源列表
      </button>
      <button id="tabAdd" class="px-4 py-2 text-sm font-medium text-gray-500" data-tab="addPanel">
        <i class="fas fa-plus mr-2"></i>添加书源
      </button>
      <button id="tabImport" class="px-4 py-2 text-sm font-medium text-gray-500" data-tab="importPanel">
        <i class="fas fa-file-import mr-2"></i>导入/导出
      </button>
      <button id="tabTest" class="px-4 py-2 text-sm font-medium text-gray-500" data-tab="testPanel">
        <i class="fas fa-vial mr-2"></i>测试书源
      </button>
    </div>
    
    <!-- 内容面板 - 书源列表（默认显示） -->
    <div id="sourcesPanel" class="card">
      <div class="card-header flex justify-between items-center">
        <div>书源列表</div>
        <div class="flex space-x-2">
          <input type="text" id="sourceSearchInput" placeholder="搜索书源..." class="px-3 py-1 text-sm border border-gray-300 rounded-md">
          <select id="groupFilter" class="px-3 py-1 text-sm border border-gray-300 rounded-md">
            <option value="all">所有分组</option>
          </select>
        </div>
      </div>
      <div class="card-body" id="sourceListContainer">
        <div class="flex justify-center py-8">
          <div class="loader"></div>
        </div>
      </div>
      <!-- 批量操作浮动按钮 -->
      <div id="batchOperationsBar" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white border border-gray-300 rounded-lg shadow-lg px-4 py-2 hidden z-10">
        <div class="flex items-center space-x-3">
          <span class="text-sm font-medium" id="selectedSourcesInfo">已选择 0 个书源</span>
          <div class="h-4 border-r border-gray-300"></div>
          <button id="batchEnableBtn" class="px-3 py-1 text-xs font-medium text-white bg-green-600 rounded hover:bg-green-700">
            <i class="fas fa-play mr-1"></i>批量启用
          </button>
          <button id="batchDisableBtn" class="px-3 py-1 text-xs font-medium text-white bg-yellow-600 rounded hover:bg-yellow-700">
            <i class="fas fa-pause mr-1"></i>批量停用
          </button>
          <button id="batchDeleteBtn" class="px-3 py-1 text-xs font-medium text-white bg-red-600 rounded hover:bg-red-700">
            <i class="fas fa-trash mr-1"></i>批量删除
          </button>
          <button id="batchCancelBtn" class="px-3 py-1 text-xs font-medium text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
            取消
          </button>
        </div>
      </div>
    </div>
    
    <!-- 内容面板 - 添加书源（默认隐藏） -->
    <div id="addPanel" class="card" style="display: none;">
      <div class="card-header">添加/编辑书源</div>
      <div class="card-body">
        <form id="sourceForm" class="space-y-4">
          <input type="hidden" id="editMode" value="add">
          
          <!-- 基本信息 -->
          <div class="bg-blue-50 rounded-md p-3 mb-4">
            <h3 class="text-sm font-bold text-blue-800 mb-2">基本信息</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="sourceName">
                  书源名称 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="sourceName" name="name" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="sourceUrl">
                  书源URL <span class="text-red-500">*</span>
                </label>
                <input type="url" id="sourceUrl" name="url" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="sourceGroup">
                  分组
                </label>
                <input type="text" id="sourceGroup" name="group" list="groupList"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <datalist id="groupList"></datalist>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="sourceIcon">
                  图标URL
                </label>
                <input type="url" id="sourceIcon" name="icon"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div class="flex items-center space-x-2 md:col-span-2">
                <input type="checkbox" id="sourceEnabled" name="enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                <label class="text-sm font-medium text-gray-700" for="sourceEnabled">
                  启用
                </label>
              </div>
            </div>
          </div>
          
          <!-- 搜索规则 -->
          <div class="bg-green-50 rounded-md p-3 mb-4">
            <h3 class="text-sm font-bold text-green-800 mb-2">搜索规则</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="searchUrl">
                  搜索URL <span class="text-red-500">*</span>
                  <span class="text-xs text-gray-500">（使用{keyword}作为搜索关键词占位符）</span>
                </label>
                <input type="text" id="searchUrl" name="searchUrl" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="searchList">
                  搜索结果列表选择器 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="searchList" name="searchList" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="searchName">
                    书名选择器 <span class="text-red-500">*</span>
                  </label>
                  <input type="text" id="searchName" name="searchName" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="searchAuthor">
                    作者选择器
                  </label>
                  <input type="text" id="searchAuthor" name="searchAuthor"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="searchDetail">
                    详情链接选择器 <span class="text-red-500">*</span>
                  </label>
                  <input type="text" id="searchDetail" name="searchDetail" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
              </div>
            </div>
          </div>
          
          <!-- 详情页规则 -->
          <div class="bg-purple-50 rounded-md p-3 mb-4">
            <h3 class="text-sm font-bold text-purple-800 mb-2">详情页规则</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="detailName">
                  书名选择器
                </label>
                <input type="text" id="detailName" name="detailName"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="detailAuthor">
                  作者选择器
                </label>
                <input type="text" id="detailAuthor" name="detailAuthor"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="detailCover">
                  封面图片选择器
                </label>
                <input type="text" id="detailCover" name="detailCover"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="detailIntro">
                  简介选择器
                </label>
                <input type="text" id="detailIntro" name="detailIntro"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="detailChapterUrl">
                  章节列表URL选择器 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="detailChapterUrl" name="detailChapterUrl" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>
          </div>
          
          <!-- 章节列表规则 -->
          <div class="bg-yellow-50 rounded-md p-3 mb-4">
            <h3 class="text-sm font-bold text-yellow-800 mb-2">章节列表规则</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="chapterList">
                  章节列表选择器 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="chapterList" name="chapterList" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="chapterName">
                  章节名选择器 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="chapterName" name="chapterName" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="chapterLink">
                  章节链接选择器 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="chapterLink" name="chapterLink" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>
          </div>
          
          <!-- 内容规则 -->
          <div class="bg-red-50 rounded-md p-3 mb-4">
            <h3 class="text-sm font-bold text-red-800 mb-2">内容规则</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="contentRule">
                  内容选择器 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="contentRule" name="contentRule" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="contentFilters">
                  内容过滤规则
                  <span class="text-xs text-gray-500">（多个规则用逗号分隔）</span>
                </label>
                <input type="text" id="contentFilters" name="contentFilters"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>
          </div>
          
          <!-- 提交按钮 -->
          <div class="flex space-x-3 justify-end">
            <button type="button" id="resetBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
              重置
            </button>
            <button type="submit" id="saveBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">
              保存
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- 内容面板 - 导入导出（默认隐藏） -->
    <div id="importPanel" class="card" style="display: none;">
      <div class="card-header">导入/导出书源</div>
      <div class="card-body">
        <div class="space-y-6">
          <!-- 导出部分 -->
          <div class="border-b border-gray-200 pb-5">
            <h3 class="text-lg font-medium text-gray-900 mb-3">导出书源</h3>
            <p class="text-sm text-gray-500 mb-4">将当前所有书源导出为JSON文件，方便备份和分享。</p>
            
            <div class="space-y-3">
              <div class="flex items-center space-x-2">
                <input type="checkbox" id="exportAll" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                <label for="exportAll" class="text-sm font-medium text-gray-700">导出所有书源</label>
              </div>
              
              <div class="flex items-center space-x-2">
                <input type="checkbox" id="exportEnabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="exportEnabled" class="text-sm font-medium text-gray-700">仅导出已启用的书源</label>
              </div>
              
              <div class="flex items-center space-x-2">
                <input type="checkbox" id="exportByGroup" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="exportByGroup" class="text-sm font-medium text-gray-700">按分组导出</label>
                
                <select id="exportGroup" class="ml-2 px-3 py-1 text-sm border border-gray-300 rounded-md disabled:opacity-50" disabled>
                  <option value="">选择分组...</option>
                </select>
              </div>
              
              <div class="mt-4">
                <button id="exportBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">
                  <i class="fas fa-file-export mr-2"></i>导出书源
                </button>
              </div>
            </div>
          </div>
          
          <!-- 导入部分将在下一步添加 -->
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-3">导入书源</h3>
            <p class="text-sm text-gray-500 mb-4">从JSON文件导入书源，支持批量导入。</p>
            
            <!-- 导入选项 -->
            <div class="space-y-4">
              <div class="tabs flex space-x-4 border-b border-gray-200">
                <button id="fileImportTab" class="px-4 py-2 text-sm font-medium tab-active" data-import-tab="fileImport">
                  <i class="fas fa-file mr-2"></i>从文件导入
                </button>
                <button id="textImportTab" class="px-4 py-2 text-sm font-medium text-gray-500" data-import-tab="textImport">
                  <i class="fas fa-code mr-2"></i>从文本导入
                </button>
              </div>
              
              <!-- 文件导入面板 -->
              <div id="fileImport" class="p-4 bg-gray-50 rounded-md">
                <div class="space-y-4">
                  <div class="flex items-center justify-center border-2 border-dashed border-gray-300 rounded-md py-8 px-4">
                    <div class="text-center">
                      <i class="fas fa-file-upload text-gray-400 text-3xl mb-2"></i>
                      <p class="text-sm text-gray-500 mb-2">点击选择或拖放JSON文件</p>
                      <input type="file" id="fileInput" accept=".json" class="hidden">
                      <button id="fileSelectBtn" class="px-3 py-1 text-sm font-medium text-blue-600 border border-blue-600 rounded-md hover:bg-blue-50">
                        选择文件
                      </button>
                    </div>
                  </div>
                  
                  <div id="fileInfo" class="hidden">
                    <div class="flex items-center p-3 bg-blue-50 rounded-md">
                      <i class="fas fa-file-alt text-blue-500 mr-3 text-xl"></i>
                      <div class="flex-1">
                        <p id="fileName" class="font-medium"></p>
                        <p id="fileSize" class="text-sm text-gray-500"></p>
                      </div>
                      <button id="fileClearBtn" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 文本导入面板 -->
              <div id="textImport" class="p-4 bg-gray-50 rounded-md" style="display: none;">
                <div class="space-y-4">
                  <textarea id="importText" rows="8" placeholder="粘贴JSON格式的书源数据"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    
                  <div class="text-xs text-gray-500">
                    <p>
                      <i class="fas fa-info-circle mr-1"></i>
                      支持单个书源（{"name": "..."}）或书源数组（[{"name": "..."}, ...]）格式
                    </p>
                  </div>
                </div>
              </div>
              
              <!-- 导入选项 -->
              <div class="space-y-3 mt-4">
                <div class="flex items-center space-x-2">
                  <input type="checkbox" id="importOverwrite" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                  <label for="importOverwrite" class="text-sm font-medium text-gray-700">
                    覆盖同名书源
                  </label>
                </div>
                
                <div class="flex items-center space-x-2">
                  <input type="checkbox" id="importEnable" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                  <label for="importEnable" class="text-sm font-medium text-gray-700">
                    导入后自动启用
                  </label>
                </div>
              </div>
              
              <!-- 导入按钮 -->
              <div class="mt-4">
                <button id="importBtn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 border border-transparent rounded-md hover:bg-green-700">
                  <i class="fas fa-file-import mr-2"></i>导入书源
                </button>
                <div id="importStatus" class="mt-2 text-sm"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 内容面板 - 测试书源（默认隐藏） -->
    <div id="testPanel" class="card" style="display: none;">
      <div class="card-header">测试书源</div>
      <div class="card-body">
        <div class="space-y-6">
          <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
              </svg>
              配置测试
            </h3>
            
            <div class="mb-4">
              <div class="flex justify-between items-center mb-3">
                <label class="block text-sm font-medium text-gray-700">选择书源</label>
                <div class="flex space-x-2">
                  <div class="relative w-[184px]">
                    <input 
                      type="text" 
                      id="testSourceFilter" 
                      placeholder="搜索书源..." 
                      class="w-full h-8 pl-3 pr-3 py-1 text-sm border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                    >
                  </div>
                  <div class="relative w-[102px]">
                    <select id="testSourceGroupFilter" class="w-full h-8 pl-3 pr-8 py-1 text-sm font-bold border border-gray-300 rounded-lg bg-white shadow-sm appearance-none focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                      <option value="" class="font-bold">所有分组</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="bg-white border border-gray-200 rounded-md shadow-sm overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-10">
                        <input type="checkbox" id="selectAllTestSources" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                      </th>
                      <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">书源名称</th>
                      <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">分组</th>
                    </tr>
                  </thead>
                  <tbody id="testSourcesContainer" class="bg-white divide-y divide-gray-200">
                    <tr>
                      <td colspan="3" class="px-3 py-4 text-center">
                        <div class="loader mx-auto"></div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div class="flex flex-col sm:flex-row justify-between items-center mt-3 text-sm">
                <div class="flex items-center space-x-2 mb-2 sm:mb-0">
                  <span><span id="selectedSourcesCount">0</span> 个书源已选择</span>
                  <button id="deselectAllSources" class="text-blue-500 hover:text-blue-700 ml-3">取消全选</button>
                </div>
                <div class="flex items-center space-x-2">
                  <span class="text-gray-500">每页显示:</span>
                  <select id="testSourcesPageSize" class="px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                  </select>
                  <div class="flex items-center space-x-1">
                    <button id="testSourcesPrevPage" class="px-2 py-1 border border-gray-300 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                      </svg>
                    </button>
                    <span class="px-2 py-1"><span id="testSourcesCurrentPage">1</span>/<span id="testSourcesTotalPages">1</span></span>
                    <button id="testSourcesNextPage" class="px-2 py-1 border border-gray-300 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-2" for="testKeyword">
                搜索关键词
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                  </svg>
                </div>
                <input type="text" id="testKeyword" placeholder="例如：武侠" 
                  class="block w-full pl-10 pr-4 py-3 text-base border-gray-300 bg-white rounded-lg shadow-sm transition duration-150 ease-in-out focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
            </div>
            
            <div class="mt-6 flex space-x-4">
              <button id="testSearchBtn" class="flex items-center justify-center px-5 py-3 text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-sm hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
                测试搜索
              </button>
              <button id="testClearBtn" class="flex items-center justify-center px-5 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                清除结果
              </button>
            </div>
          </div>
          
          <div id="testResults" class="space-y-4" style="display: none;">
            <div class="flex items-center border-b border-gray-200 pb-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
              <h3 class="text-md font-medium text-gray-900">测试结果</h3>
            </div>
            
            <!-- 搜索结果 -->
            <div id="searchResults" class="space-y-3">
              <h4 class="text-sm font-medium text-gray-700 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M9 9a2 2 0 114 0 2 2 0 01-4 0z" />
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a4 4 0 00-3.446 6.032l-2.261 2.26a1 1 0 101.414 1.415l2.261-2.261A4 4 0 1011 5z" clip-rule="evenodd" />
                </svg>
                搜索结果
              </h4>
              <div id="searchResultsContent" class="bg-gray-50 p-4 rounded-lg overflow-x-auto border border-gray-100 shadow-sm">
                <div class="loader"></div>
              </div>
            </div>
            
            <!-- 书籍详情 -->
            <div id="bookDetailSection" class="space-y-3" style="display: none;">
              <h4 class="text-sm font-medium text-gray-700">书籍详情</h4>
              <div id="bookDetailContent" class="bg-gray-50 p-3 rounded-md">
                <div class="loader"></div>
              </div>
            </div>
            
            <!-- 章节列表 -->
            <div id="chapterListSection" class="space-y-3" style="display: none;">
              <h4 class="text-sm font-medium text-gray-700">章节列表</h4>
              <div id="chapterListContent" class="bg-gray-50 p-3 rounded-md max-h-60 overflow-y-auto">
                <div class="loader"></div>
              </div>
            </div>
            
            <!-- 章节内容 -->
            <div id="chapterContentSection" class="space-y-3" style="display: none;">
              <h4 class="text-sm font-medium text-gray-700">章节内容</h4>
              <div id="chapterContentInfo" class="text-sm text-gray-500 mb-1"></div>
              <div id="chapterContentDisplay" class="bg-gray-50 p-3 rounded-md max-h-96 overflow-y-auto">
                <div class="loader"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 基础脚本 -->
  <script>
    // 注：不再导入auth.js，避免模块加载错误
    // 而是使用页面内部的实现
    
    // 获取认证令牌
    function getAuthToken() {
      // 首先尝试直接从token获取
      const directToken = localStorage.getItem('token');
      if (directToken) {
        return directToken;
      }
      
      // 如果没有直接的token，尝试从bookstore_auth中获取
      try {
        const authData = localStorage.getItem('bookstore_auth');
        if (authData) {
          const parsedData = JSON.parse(authData);
          if (parsedData && parsedData.token) {
            return parsedData.token;
          }
        }
      } catch (e) {
        console.error('从bookstore_auth获取token失败:', e);
      }
      
      // 尝试从cachedToken获取
      const cachedToken = localStorage.getItem('cachedToken');
      if (cachedToken) {
        return cachedToken;
      }
      
      return null;
    }
    
    // 检查当前用户是否是管理员
    function isAdmin() {
      try {
        const authData = localStorage.getItem('bookstore_auth');
        if (!authData) return false;
        
        const { user } = JSON.parse(authData);
        if (!user) return false;
        
        return user.role === 'admin' || 
               (user.roles && user.roles.includes('admin')) || 
               user.isAdmin === true;
      } catch (error) {
        console.error('检查管理员权限失败:', error);
        return false;
      }
    }
    
    // 验证管理员权限
    async function checkAdminAccess() {
      try {
        // 获取用户信息
        const authData = localStorage.getItem('bookstore_auth');
        if (!authData) {
          console.error('未找到用户认证数据');
          showAuthScreen();
          return;
        }
        
        const { user } = JSON.parse(authData);
        if (!user) {
          console.error('未找到用户数据');
          showAuthScreen();
          return;
        }
        
        // 检查用户是否为管理员
        if (!isAdmin()) {
          console.error('用户不是管理员');
          showAuthScreen();
          return;
        }
        
        console.log('已验证管理员权限:', user.username);
        
        // 隐藏认证屏幕（如果显示）
        document.getElementById('authScreen').style.display = 'none';
        
        // 显示管理员信息
        document.getElementById('loadingStatus').innerHTML = 
          `<i class="fas fa-check-circle text-green-500 mr-2"></i>管理员：${user.username}`;
          
        // 加载书源列表
        loadBookSources();
        
      } catch (error) {
        console.error('验证管理员权限失败:', error);
        showAuthScreen();
      }
    }
    
    // 显示需要管理员权限的屏幕
    function showAuthScreen() {
      document.getElementById('authScreen').style.display = 'flex';
    }
    
    // 页面初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 首先进行管理员权限验证
      checkAdminAccess();
      
      // 初始化页面数据
      init();
      
      // 添加批量操作按钮事件监听
      document.getElementById('batchEnableBtn').addEventListener('click', batchEnableSources);
      document.getElementById('batchDisableBtn').addEventListener('click', batchDisableSources);
      document.getElementById('batchDeleteBtn').addEventListener('click', batchDeleteSources);
      document.getElementById('batchCancelBtn').addEventListener('click', () => {
        // 取消所有选择
        document.getElementById('selectAllCheckbox').checked = false;
        document.querySelectorAll('.source-checkbox').forEach(checkbox => {
          checkbox.checked = false;
          const row = checkbox.closest('.source-item');
          if (row) {
            row.classList.remove('bg-blue-50');
          }
        });
        
        // 隐藏批量操作栏
        document.getElementById('batchOperationsBar').classList.add('hidden');
      });
      
      // 初始隐藏批量操作栏
      document.getElementById('batchOperationsBar').classList.add('hidden');
    });
    
    async function init() {
      // 移动端菜单切换
      const menuButton = document.querySelector('.menu-button');
      const sidebar = document.querySelector('.sidebar');
      
      if (menuButton && sidebar) {
        menuButton.addEventListener('click', function() {
          sidebar.classList.toggle('hidden');
        });
      }
      
      // 设置选项卡切换功能
      setupTabFunctions();
      
      // 初始化导入面板
      setupImportFunctions();
      
      // 设置添加/编辑面板功能
      setupEditFunctions();
      
      // 初始化测试面板功能
      setupTestFunctions();
      
      // 加载书源分组
      await loadSourceGroups();
      
      // 初始化搜索和过滤功能
      setupSearchAndFilter();
    }
    
    // 设置选项卡切换功能
    function setupTabFunctions() {
      const tabs = document.querySelectorAll('[data-tab]');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // 重置所有选项卡样式
          tabs.forEach(t => {
            t.classList.remove('tab-active');
            t.classList.add('text-gray-500');
          });
          
          // 激活当前选项卡
          this.classList.add('tab-active');
          this.classList.remove('text-gray-500');
          
          // 隐藏所有面板
          const panels = document.querySelectorAll('.card');
          panels.forEach(panel => {
            panel.style.display = 'none';
          });
          
          // 显示对应面板
          const panelId = this.getAttribute('data-tab');
          const panel = document.getElementById(panelId);
          if (panel) {
            panel.style.display = 'block';
            
            // 如果切换到测试面板，加载已启用的书源到测试选择列表
            if (panelId === 'testPanel') {
              // 检查是否已经加载了测试书源
              if (!testSourcePagination.allSources || testSourcePagination.allSources.length === 0) {
                // 使用已加载的书源数据而不是重新请求
                if (sourcePagination && sourcePagination.allSources && sourcePagination.allSources.length > 0) {
                  console.log('使用已加载的书源数据...');
                  loadTestSources(sourcePagination.allSources);
                } else {
                  // 如果没有源数据，则尝试重新加载
                  console.log('重新加载书源数据...');
                  loadBookSources().then(sources => {
                    if (sources && sources.data) {
                      loadTestSources(sources.data);
                    }
                  });
                }
              }
            }
          }
        });
      });
    }
    
    // 设置搜索和过滤功能
    function setupSearchAndFilter() {
      const searchInput = document.getElementById('sourceSearchInput');
      const groupFilter = document.getElementById('groupFilter');
      
      if (searchInput) {
        searchInput.addEventListener('keyup', debounce(function(e) {
          if (e.key === 'Enter' || this.value.trim() === '') {
            loadBookSources();
          }
        }, 300));
      }
      
      if (groupFilter) {
        groupFilter.addEventListener('change', function() {
          loadBookSources();
        });
      }
      
      // 添加搜索按钮事件
      const searchButton = document.getElementById('sourceSearchButton');
      if (searchButton) {
        searchButton.addEventListener('click', function() {
          loadBookSources();
        });
      }
    }
    
    // 设置导入面板功能
    function setupImportFunctions() {
      // 导入选项卡切换
      const importTabs = document.querySelectorAll('[data-import-tab]');
      importTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // 重置所有选项卡
          importTabs.forEach(t => {
            t.classList.remove('tab-active');
            t.classList.add('text-gray-500');
          });
          
          // 激活当前选项卡
          this.classList.add('tab-active');
          this.classList.remove('text-gray-500');
          
          // 显示对应面板
          const tabId = this.dataset.importTab;
          document.getElementById('fileImport').style.display = tabId === 'fileImport' ? 'block' : 'none';
          document.getElementById('textImport').style.display = tabId === 'textImport' ? 'block' : 'none';
        });
      });
      
      // 文件选择处理
      const fileInput = document.getElementById('fileInput');
      const fileInfo = document.getElementById('fileInfo');
      const fileName = document.getElementById('fileName');
      const fileSize = document.getElementById('fileSize');
      const fileSelectBtn = document.getElementById('fileSelectBtn');
      
      // 绑定文件选择按钮点击事件
      if (fileSelectBtn && fileInput) {
        fileSelectBtn.addEventListener('click', function() {
          fileInput.click();
        });
      }
      
      if (fileInput) {
        fileInput.addEventListener('change', function() {
          if (this.files.length) {
            const file = this.files[0];
            fileInfo.classList.remove('hidden');
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
          } else {
            fileInfo.classList.add('hidden');
          }
        });
      }
      
      // 清除文件按钮
      const fileClearBtn = document.getElementById('fileClearBtn');
      if (fileClearBtn) {
        fileClearBtn.addEventListener('click', function() {
          fileInput.value = '';
          fileInfo.classList.add('hidden');
        });
      }
      
      // 导入按钮点击事件
      document.getElementById('importBtn').addEventListener('click', function() {
        importBookSources();
      });
    }
    
    // 设置测试面板功能
    function setupTestFunctions() {
      // 测试搜索按钮
      const testSearchBtn = document.getElementById('testSearchBtn');
      if (testSearchBtn) {
        testSearchBtn.addEventListener('click', function() {
          const selectedSources = getSelectedTestSources();
          const keyword = document.getElementById('testKeyword').value;
          
          if (selectedSources.length === 0) {
            alert('请至少选择一个书源进行测试');
            return;
          }
          
          if (!keyword) {
            alert('请输入搜索关键词');
            return;
          }
          
          testMultipleSearch(selectedSources, keyword);
        });
      }
      
      // 清除结果按钮
      const testClearBtn = document.getElementById('testClearBtn');
      if (testClearBtn) {
        testClearBtn.addEventListener('click', function() {
          document.getElementById('testResults').style.display = 'none';
          document.getElementById('searchResultsContent').innerHTML = '<div class="loader"></div>';
          document.getElementById('bookDetailSection').style.display = 'none';
          document.getElementById('chapterListSection').style.display = 'none';
          document.getElementById('chapterContentSection').style.display = 'none';
        });
      }
      
      // 设置书源过滤器
      const sourceFilter = document.getElementById('testSourceFilter');
      if (sourceFilter) {
        sourceFilter.addEventListener('input', function() {
          // 重置分页到第一页
          testSourcePagination.currentPage = 1;
          filterTestSources();
        });
      }
      
      // 设置分组过滤器
      const groupFilter = document.getElementById('testSourceGroupFilter');
      if (groupFilter) {
        groupFilter.addEventListener('change', function() {
          // 重置分页到第一页
          testSourcePagination.currentPage = 1;
          filterTestSources();
        });
      }
      
      // 全选复选框
      const selectAllCheckbox = document.getElementById('selectAllTestSources');
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
          if (this.checked) {
            selectAllTestSources();
          } else {
            deselectAllTestSources();
          }
        });
      }
      
      // 取消全选按钮
      const deselectAllBtn = document.getElementById('deselectAllSources');
      if (deselectAllBtn) {
        deselectAllBtn.addEventListener('click', function() {
          deselectAllTestSources();
        });
      }
      
      // 设置每页显示数量
      const pageSizeSelect = document.getElementById('testSourcesPageSize');
      if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', function() {
          const pageSize = parseInt(this.value);
          testSourcePagination.pageSize = pageSize;
          testSourcePagination.currentPage = 1; // 重置到第一页
          renderTestSourcePage();
        });
      }
      
      // 上一页按钮
      const prevPageBtn = document.getElementById('testSourcesPrevPage');
      if (prevPageBtn) {
        prevPageBtn.addEventListener('click', function() {
          if (testSourcePagination.currentPage > 1) {
            testSourcePagination.currentPage--;
            renderTestSourcePage();
          }
        });
      }
      
      // 下一页按钮
      const nextPageBtn = document.getElementById('testSourcesNextPage');
      if (nextPageBtn) {
        nextPageBtn.addEventListener('click', function() {
          if (testSourcePagination.currentPage < testSourcePagination.totalPages) {
            testSourcePagination.currentPage++;
            renderTestSourcePage();
          }
        });
      }
    }
    
    // 分页状态对象
    const sourcePagination = {
      pageSize: 20,
      currentPage: 1,
      totalPages: 1,
      allSources: [],
      filteredSources: []
    };
    
    // 分页状态对象
    const testSourcePagination = {
      pageSize: 20,
      currentPage: 1,
      totalPages: 1,
      allSources: [],
      filteredSources: []
    };
    
    // 加载测试书源选择界面
    function loadTestSources(sources) {
      // 保存所有书源
      testSourcePagination.allSources = sources.filter(source => source.enabled);
      
      const groupFilterSelect = document.getElementById('testSourceGroupFilter');
      if (groupFilterSelect) {
        // 清空并重新填充分组过滤器
        groupFilterSelect.innerHTML = '<option value="">所有分组</option>';
        
        // 提取所有分组
        const groups = new Set();
        sources.forEach(source => {
          if (source.group) {
            groups.add(source.group);
          }
        });
        
        // 添加分组选项
        groups.forEach(group => {
          const option = document.createElement('option');
          option.value = group;
          option.textContent = group;
          groupFilterSelect.appendChild(option);
        });
      }
      
      // 过滤书源并显示第一页
      filterTestSources();
    }
    
    // 根据过滤条件筛选测试书源
    function filterTestSources() {
      const filterText = document.getElementById('testSourceFilter').value.toLowerCase();
      const selectedGroup = document.getElementById('testSourceGroupFilter').value;
      
      // 过滤书源
      testSourcePagination.filteredSources = testSourcePagination.allSources.filter(source => {
        const nameMatch = source.name.toLowerCase().includes(filterText);
        const groupMatch = !selectedGroup || source.group === selectedGroup;
        return nameMatch && groupMatch;
      });
      
      // 计算总页数
      testSourcePagination.totalPages = Math.max(1, Math.ceil(testSourcePagination.filteredSources.length / testSourcePagination.pageSize));
      
      // 确保当前页有效
      if (testSourcePagination.currentPage > testSourcePagination.totalPages) {
        testSourcePagination.currentPage = testSourcePagination.totalPages;
      }
      
      // 显示当前页
      renderTestSourcePage();
      
      // 更新分页信息
      updatePaginationInfo();
    }
    
    // 渲染当前页的书源
    function renderTestSourcePage() {
      const container = document.getElementById('testSourcesContainer');
      if (!container) return;
      
      // 计算当前页的书源
      const startIndex = (testSourcePagination.currentPage - 1) * testSourcePagination.pageSize;
      const endIndex = Math.min(startIndex + testSourcePagination.pageSize, testSourcePagination.filteredSources.length);
      const currentPageSources = testSourcePagination.filteredSources.slice(startIndex, endIndex);
      
      if (currentPageSources.length === 0) {
        container.innerHTML = `
          <tr>
            <td colspan="3" class="px-3 py-4 text-center text-gray-500">
              没有找到匹配的书源
            </td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      
      currentPageSources.forEach(source => {
        html += `
          <tr class="test-source-item hover:bg-gray-50" data-name="${source.name}" data-group="${source.group || ''}" data-selected="false">
            <td class="px-3 py-2">
              <input type="checkbox" class="test-source-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            </td>
            <td class="px-3 py-2">
              <div class="font-medium text-sm">${source.name}</div>
            </td>
            <td class="px-3 py-2 hidden md:table-cell text-sm text-gray-500">
              ${source.group || '-'}
            </td>
          </tr>
        `;
      });
      
      container.innerHTML = html;
      
      // 添加复选框事件监听
      const checkboxes = container.querySelectorAll('.test-source-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const row = this.closest('.test-source-item');
          if (row) {
            row.setAttribute('data-selected', this.checked);
            if (this.checked) {
              row.classList.add('bg-blue-50');
            } else {
              row.classList.remove('bg-blue-50');
            }
          }
          updateSelectedSourcesCount();
        });
      });
      
      // 添加行点击事件（点击行也可以选中/取消选中）
      const rows = container.querySelectorAll('.test-source-item');
      rows.forEach(row => {
        row.addEventListener('click', function(e) {
          // 防止点击复选框时触发行点击事件
          if (e.target.type === 'checkbox') return;
          
          const checkbox = this.querySelector('.test-source-checkbox');
          if (checkbox) {
            checkbox.checked = !checkbox.checked;
            this.setAttribute('data-selected', checkbox.checked);
            if (checkbox.checked) {
              this.classList.add('bg-blue-50');
            } else {
              this.classList.remove('bg-blue-50');
            }
            
            // 触发change事件
            const event = new Event('change');
            checkbox.dispatchEvent(event);
          }
        });
      });
      
      // 更新已选择的数量
      updateSelectedSourcesCount();
      
      // 更新分页信息
      updatePaginationInfo();
    }
    
    // 更新分页信息
    function updatePaginationInfo() {
      const currentPageEl = document.getElementById('testSourcesCurrentPage');
      const totalPagesEl = document.getElementById('testSourcesTotalPages');
      const prevBtn = document.getElementById('testSourcesPrevPage');
      const nextBtn = document.getElementById('testSourcesNextPage');
      
      if (currentPageEl) {
        currentPageEl.textContent = testSourcePagination.currentPage;
      }
      
      if (totalPagesEl) {
        totalPagesEl.textContent = testSourcePagination.totalPages;
      }
      
      if (prevBtn) {
        prevBtn.disabled = testSourcePagination.currentPage <= 1;
      }
      
      if (nextBtn) {
        nextBtn.disabled = testSourcePagination.currentPage >= testSourcePagination.totalPages;
      }
    }
    
    // 更新选中的源数量
    function updateSelectedSourcesCount() {
      const selectedItems = document.querySelectorAll('.test-source-item[data-selected="true"], .test-source-checkbox:checked');
      const countElement = document.getElementById('selectedSourcesCount');
      if (countElement) {
        countElement.textContent = selectedItems.length;
      }
      
      // 更新全选复选框状态
      const allCheckbox = document.getElementById('selectAllTestSources');
      const checkboxes = document.querySelectorAll('.test-source-checkbox');
      
      if (allCheckbox && checkboxes.length > 0) {
        allCheckbox.checked = selectedItems.length > 0 && selectedItems.length === checkboxes.length;
        allCheckbox.indeterminate = selectedItems.length > 0 && selectedItems.length < checkboxes.length;
      }
    }
    
    // 获取当前选中的测试书源
    function getSelectedTestSources() {
      const selectedSources = [];
      const items = document.querySelectorAll('.test-source-item');
      
      items.forEach(item => {
        const checkbox = item.querySelector('.test-source-checkbox');
        if (checkbox && checkbox.checked) {
          selectedSources.push(item.dataset.name);
        }
      });
      
      return selectedSources;
    }
    
    // 全选测试书源
    function selectAllTestSources() {
      const checkboxes = document.querySelectorAll('.test-source-checkbox:not(:checked)');
      checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        const row = checkbox.closest('.test-source-item');
        if (row) {
          row.setAttribute('data-selected', 'true');
          row.classList.add('bg-blue-50');
        }
      });
      updateSelectedSourcesCount();
    }
    
    // 取消全选测试书源
    function deselectAllTestSources() {
      const checkboxes = document.querySelectorAll('.test-source-checkbox:checked');
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        const row = checkbox.closest('.test-source-item');
        if (row) {
          row.setAttribute('data-selected', 'false');
          row.classList.remove('bg-blue-50');
        }
      });
      updateSelectedSourcesCount();
    }
    
    // 测试多个书源
    async function testMultipleSearch(sourceNames, keyword) {
      try {
        // 显示测试结果区域
        document.getElementById('testResults').style.display = 'block';
        document.getElementById('searchResultsContent').innerHTML = '<div class="loader"></div>';
        
        // 隐藏其他结果区域
        document.getElementById('bookDetailSection').style.display = 'none';
        document.getElementById('chapterListSection').style.display = 'none';
        document.getElementById('chapterContentSection').style.display = 'none';
        
        // 获取认证令牌
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        
        // 创建所有测试搜索的Promise
        const searchPromises = sourceNames.map(sourceName => 
          fetch(`/api/booksource/sources/test`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              sourceName,
              keyword,
              type: 'search'  // 显式指定测试类型为搜索
            })
          }).then(response => {
            if (!response.ok) {
              return { 
                sourceName, 
                success: false, 
                error: '请求失败' 
              };
            }
            return response.json().then(data => ({
              sourceName,
              ...data
            }));
          }).catch(error => ({
            sourceName,
            success: false,
            error: error.message
          }))
        );
        
        // 等待所有搜索完成
        const results = await Promise.all(searchPromises);
        
        // 显示搜索结果
        renderMultipleSearchResults(results);
        
      } catch (error) {
        console.error('测试搜索失败:', error);
        document.getElementById('searchResultsContent').innerHTML = 
          `<div class="text-red-500 py-2">
            <i class="fas fa-exclamation-circle mr-2"></i>${error.message}
          </div>`;
      }
    }
    
    // 渲染多个书源的搜索结果
    function renderMultipleSearchResults(results) {
      const container = document.getElementById('searchResultsContent');
      
      let html = `<div class="space-y-5">`;
      
      // 处理每个书源的结果
      results.forEach(result => {
        const sourceName = result.sourceName;
        
        html += `
          <div class="border-t border-gray-200 pt-4 first:border-t-0 first:pt-0">
            <h5 class="text-sm font-medium mb-2 flex items-center">
              <span class="inline-block w-4 h-4 mr-2 rounded-full ${result.success ? 'bg-green-500' : 'bg-red-500'}"></span>
              ${sourceName}
            </h5>
        `;
        
        if (!result.success) {
          html += `
            <div class="text-red-500 text-sm ml-6">
              <i class="fas fa-exclamation-circle mr-1"></i>${result.message || result.error || '未知错误'}
            </div>
          </div>
          `;
          return;
        }
        
        const books = result.data;
        
        if (!books || books.length === 0) {
          html += `
            <div class="text-gray-500 text-sm ml-6">
              <i class="fas fa-info-circle mr-1"></i>没有找到相关书籍
            </div>
          </div>
          `;
          return;
        }
        
        html += `
          <div class="ml-6">
            <p class="text-xs text-gray-500 mb-2">找到 ${books.length} 本相关书籍</p>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">书名</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">作者</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
          `;
        
        books.slice(0, 5).forEach((book, index) => {
          html += `
            <tr>
              <td class="px-3 py-2 whitespace-nowrap">
                <div class="font-medium text-gray-900">${book.name || '未知'}</div>
              </td>
              <td class="px-3 py-2 whitespace-nowrap">
                <span class="text-sm text-gray-500">${book.author || '未知'}</span>
              </td>
              <td class="px-3 py-2 whitespace-nowrap">
                <button class="px-2 py-1 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700"
                  onclick="testBookDetail('${sourceName}', '${encodeURIComponent(book.url)}')">
                  查看详情
                </button>
              </td>
            </tr>
          `;
        });
        
        if (books.length > 5) {
          html += `
            <tr>
              <td colspan="3" class="px-3 py-2 text-center text-xs text-gray-500">
                显示前 5 条结果，共 ${books.length} 条
              </td>
            </tr>
          `;
        }
        
        html += `
                </tbody>
              </table>
            </div>
          </div>
        </div>
        `;
      });
      
      html += `</div>`;
      container.innerHTML = html;
    }
    
    // 设置添加/编辑面板功能
    function setupEditFunctions() {
      // 书源表单提交
      const sourceForm = document.getElementById('sourceForm');
      if (sourceForm) {
        sourceForm.addEventListener('submit', function(e) {
          e.preventDefault();
          saveBookSource();
        });
      }
      
      // 重置按钮
      const resetBtn = document.getElementById('resetBtn');
      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          resetForm();
        });
      }
    }
    
    // 保存书源
    async function saveBookSource() {
      try {
        // 获取表单数据
        const form = document.getElementById('sourceForm');
        const formData = new FormData(form);
        const isEdit = document.getElementById('editMode').value === 'edit';
        
        // 构造书源对象
        const source = {
          name: formData.get('name'),
          url: formData.get('url'),
          group: formData.get('group'),
          icon: formData.get('icon'),
          enabled: formData.get('enabled') === 'on',
          
          // 搜索规则
          searchUrl: formData.get('searchUrl'),
          searchList: formData.get('searchList'),
          searchName: formData.get('searchName'),
          searchAuthor: formData.get('searchAuthor'),
          searchDetail: formData.get('searchDetail'),
          
          // 详情页规则
          detailName: formData.get('detailName'),
          detailAuthor: formData.get('detailAuthor'),
          detailCover: formData.get('detailCover'),
          detailIntro: formData.get('detailIntro'),
          detailChapterUrl: formData.get('detailChapterUrl'),
          
          // 章节列表规则
          chapterList: formData.get('chapterList'),
          chapterName: formData.get('chapterName'),
          chapterLink: formData.get('chapterLink'),
          
          // 内容规则
          contentRule: formData.get('contentRule'),
          contentFilter: formData.get('contentFilters') ? formData.get('contentFilters').split(',').map(f => f.trim()) : []
        };
        
        // 验证必填字段
        const requiredFields = [
          { field: 'name', label: '书源名称' },
          { field: 'url', label: '书源URL' },
          { field: 'searchUrl', label: '搜索URL' },
          { field: 'searchList', label: '搜索结果列表选择器' },
          { field: 'searchName', label: '书名选择器' },
          { field: 'searchDetail', label: '详情链接选择器' },
          { field: 'detailChapterUrl', label: '章节列表URL选择器' },
          { field: 'chapterList', label: '章节列表选择器' },
          { field: 'chapterName', label: '章节名选择器' },
          { field: 'chapterLink', label: '章节链接选择器' },
          { field: 'contentRule', label: '内容选择器' }
        ];
        
        for (const field of requiredFields) {
          if (!source[field.field]) {
            alert(`请填写${field.label}`);
            return;
          }
        }
        
        // 获取认证令牌
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        
        // 构造请求
        const method = isEdit ? 'PUT' : 'POST';
        const url = isEdit ? `/api/booksource/sources/${source.name}` : '/api/booksource/sources';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(source)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `${isEdit ? '更新' : '添加'}书源失败`);
        }
        
        // 提示成功
        alert(`书源${isEdit ? '更新' : '添加'}成功`);
        
        // 重置表单
        resetForm();
        
        // 刷新书源列表并切换到列表面板
        loadBookSources();
        document.getElementById('tabSources').click();
        
      } catch (error) {
        console.error('保存书源失败:', error);
        alert(`保存书源失败: ${error.message}`);
      }
    }
    
    // 重置表单
    function resetForm() {
      const form = document.getElementById('sourceForm');
      form.reset();
      
      // 恢复为添加模式
      document.getElementById('editMode').value = 'add';
      document.getElementById('sourceName').readOnly = false;
    }
    
    // 辅助函数：格式化文件大小
    function formatFileSize(bytes) {
      if (bytes < 1024) {
        return bytes + ' B';
      } else if (bytes < 1024 * 1024) {
        return (bytes / 1024).toFixed(2) + ' KB';
      } else {
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
      }
    }
    
    // 加载书源列表
    async function loadBookSources() {
      try {
        const token = getAuthToken();
        
        // 显示加载提示
        const container = document.getElementById('sourceListContainer');
        container.innerHTML = '<div class="text-center py-8"><div class="loader"></div><p class="mt-2">加载中...</p></div>';
        
        // 获取搜索和筛选条件
        const searchInput = document.getElementById('sourceSearchInput');
        const groupFilter = document.getElementById('groupFilter');
        const searchValue = searchInput ? searchInput.value.trim() : '';
        const selectedGroup = groupFilter ? groupFilter.value : 'all';
        
        // 构建API请求路径
        let apiPath = '/api/booksource/sources';
        const params = [];
        
        if (searchValue) {
          params.push(`keyword=${encodeURIComponent(searchValue)}`);
        }
        
        if (selectedGroup && selectedGroup !== 'all') {
          params.push(`group=${encodeURIComponent(selectedGroup)}`);
        }
        
        if (params.length > 0) {
          apiPath += `?${params.join('&')}`;
        }
        
        // 发送API请求
        const response = await fetch(apiPath, {
          headers: {
            'Authorization': token ? `Bearer ${token}` : '',
          }
        });
        
        if (!response.ok) {
          throw new Error('加载书源失败');
        }
        
        const data = await response.json();
        
        // 存储所有书源数据供其他功能使用
        sourcePagination.allSources = data.data;
        
        // 渲染书源列表
        renderSourceList(data.data);
        
        // 更新分页信息
        updatePagination(data);
        
        return data;
        
      } catch (error) {
        console.error('加载书源失败:', error);
        document.getElementById('sourceListContainer').innerHTML = `
          <div class="text-center py-8 text-red-500">
            <i class="fas fa-exclamation-circle text-xl mb-2"></i>
            <p>加载失败: ${error.message}</p>
            <button class="mt-2 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" onclick="loadBookSources()">
              <i class="fas fa-sync-alt mr-1"></i> 重试
            </button>
          </div>
        `;
        return null;
      }
    }
    
    // 渲染书源列表
    function renderSourceList(sources) {
      const container = document.getElementById('sourceListContainer');
      container.innerHTML = '';

      // 如果没有书源，显示提示信息
      if (!sources || sources.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">暂无书源，请添加或导入</div>';
        return;
      }

      // 创建表格头部
      const tableHeader = document.createElement('div');
      tableHeader.className = 'grid grid-cols-12 gap-2 mb-2 px-3 py-2 bg-gray-100 rounded-md text-sm font-medium text-gray-700';
      tableHeader.innerHTML = `
        <div class="col-span-1 flex items-center">
          <input type="checkbox" id="selectAllCheckbox" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
        </div>
        <div class="col-span-3">名称</div>
        <div class="col-span-2">分组</div>
        <div class="col-span-4">URL</div>
        <div class="col-span-2">状态</div>
      `;
      container.appendChild(tableHeader);

      // 循环添加每个书源
      sources.forEach(source => {
        const isEnabled = source.enable !== false;
        const statusColor = isEnabled ? 'text-green-600' : 'text-gray-400';
        const statusText = isEnabled ? '启用' : '停用';
        
        const sourceElement = document.createElement('div');
        sourceElement.className = 'source-item grid grid-cols-12 gap-2 mb-2 px-3 py-2 border border-gray-200 rounded-md hover:bg-gray-50 cursor-pointer transition-colors';
        sourceElement.setAttribute('data-name', source.name);
        sourceElement.setAttribute('data-enabled', isEnabled.toString());
        
        sourceElement.innerHTML = `
          <div class="col-span-1 flex items-center">
            <input type="checkbox" class="source-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
          </div>
          <div class="col-span-3 truncate" title="${source.name}">${source.name}</div>
          <div class="col-span-2 truncate" title="${source.group || '未分组'}">${source.group || '未分组'}</div>
          <div class="col-span-4 truncate" title="${source.url || ''}">${source.url || ''}</div>
          <div class="col-span-2 flex items-center space-x-2">
            <span class="${statusColor}">${statusText}</span>
            <div class="flex space-x-1 ml-auto">
              <button class="edit-btn p-1 text-blue-600 hover:text-blue-800" title="编辑">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              <button class="toggle-btn p-1 ${isEnabled ? 'text-yellow-600 hover:text-yellow-800' : 'text-green-600 hover:text-green-800'}" title="${isEnabled ? '停用' : '启用'}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isEnabled ? 'M10 9v6m4-6v6M9 3h6v4H9V3z' : 'M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z'}" />
                </svg>
              </button>
              <button class="delete-btn p-1 text-red-600 hover:text-red-800" title="删除">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
              <button class="test-btn p-1 text-purple-600 hover:text-purple-800" title="测试">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
              </button>
            </div>
          </div>
        `;
        
        container.appendChild(sourceElement);
        
        // 添加选择框事件监听
        const checkbox = sourceElement.querySelector('.source-checkbox');
        checkbox.addEventListener('change', (e) => {
          // 防止事件冒泡
          e.stopPropagation();
          
          // 高亮选中的行
          if (checkbox.checked) {
            sourceElement.classList.add('bg-blue-50');
          } else {
            sourceElement.classList.remove('bg-blue-50');
          }
          
          // 更新全选框状态
          updateSelectAllCheckboxState();
          
          // 更新批量操作栏
          updateBatchOperationsBar();
        });
        
        // 添加行点击事件 - 点击行时选择/取消选择
        sourceElement.addEventListener('click', (e) => {
          // 如果点击的是按钮，不触发选择
          if (e.target.closest('.edit-btn') || e.target.closest('.delete-btn') || 
              e.target.closest('.toggle-btn') || e.target.closest('.test-btn')) {
            return;
          }
          
          // 切换复选框状态
          checkbox.checked = !checkbox.checked;
          
          // 手动触发change事件
          checkbox.dispatchEvent(new Event('change'));
        });
        
        // 添加按钮事件监听
        const editBtn = sourceElement.querySelector('.edit-btn');
        const deleteBtn = sourceElement.querySelector('.delete-btn');
        const toggleBtn = sourceElement.querySelector('.toggle-btn');
        const testBtn = sourceElement.querySelector('.test-btn');
        
        editBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          editSource(source.name);
        });
        
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteSource(source.name);
        });
        
        toggleBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleSource(source.name, !isEnabled);
        });
        
        testBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          testSource(source.name);
        });
      });
      
      // 添加全选复选框事件监听
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      selectAllCheckbox.addEventListener('change', () => {
        const isChecked = selectAllCheckbox.checked;
        document.querySelectorAll('.source-checkbox').forEach(checkbox => {
          checkbox.checked = isChecked;
          const row = checkbox.closest('.source-item');
          if (row) {
            if (isChecked) {
              row.classList.add('bg-blue-50');
            } else {
              row.classList.remove('bg-blue-50');
            }
          }
        });
        
        // 更新批量操作栏
        updateBatchOperationsBar();
      });
    }
    
    // 更新全选复选框状态
    function updateSelectAllCheckboxState() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const checkboxes = document.querySelectorAll('.source-checkbox');
      const checkedCheckboxes = document.querySelectorAll('.source-checkbox:checked');
      
      if (checkboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      } else if (checkedCheckboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      } else if (checkedCheckboxes.length === checkboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      }
    }
    
    // 加载书源分组
    async function loadSourceGroups() {
      try {
        const token = getAuthToken();
        
        // 调用获取所有书源的API
        const response = await fetch('/api/booksource/sources', {
          headers: {
            'Authorization': token ? `Bearer ${token}` : '',
          }
        });
        
        if (!response.ok) {
          throw new Error('获取书源失败');
        }
        
        const data = await response.json();
        
        // 更新分组下拉框
        updateGroupDropdown(data.data);
        
      } catch (error) {
        console.error('加载书源分组失败:', error);
      }
    }
    
    // 更新分组下拉框
    function updateGroupDropdown(sources) {
      const groupFilter = document.getElementById('groupFilter');
      if (!groupFilter) return;
      
      // 保存当前选择的值
      const currentValue = groupFilter.value;
      
      // 获取所有组
      const groups = new Set();
      sources.forEach(source => {
        if (source.group && source.group.trim() !== '') {
          groups.add(source.group.trim());
        }
      });
      
      // 创建下拉框选项
      let options = '<option value="all">所有分组</option>';
      
      // 添加未分组选项
      options += '<option value="none">未分组</option>';
      
      // 添加其他分组
      Array.from(groups).sort().forEach(group => {
        options += `<option value="${group}">${group}</option>`;
      });
      
      // 设置下拉框内容
      groupFilter.innerHTML = options;
      
      // 恢复之前的选择
      if (groups.has(currentValue) || currentValue === 'all' || currentValue === 'none') {
        groupFilter.value = currentValue;
      }
    }
    
    // 更新导出分组下拉框
    function updateExportGroups(sources) {
      const groups = new Set();
      
      sources.forEach(source => {
        if (source.group) {
          groups.add(source.group);
        }
      });
      
      const exportGroup = document.getElementById('exportGroup');
      exportGroup.innerHTML = '<option value="">选择分组...</option>';
      
      groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        exportGroup.appendChild(option);
      });
      
      // 设置导出分组选择框的启用/禁用状态
      document.getElementById('exportByGroup').addEventListener('change', function() {
        exportGroup.disabled = !this.checked;
      });
      
      // 导出按钮事件
      document.getElementById('exportBtn').addEventListener('click', exportBookSources);
    }
    
    // 导出书源
    async function exportBookSources() {
      try {
        // 获取选项
        const exportEnabled = document.getElementById('exportEnabled').checked;
        const exportByGroup = document.getElementById('exportByGroup').checked;
        const exportGroup = exportByGroup ? document.getElementById('exportGroup').value : '';
        
        if (exportByGroup && !exportGroup) {
          alert('请选择要导出的分组');
          return;
        }
        
        // 获取所有书源
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        const response = await fetch('/api/booksource/sources', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('获取书源失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '获取书源失败');
        }
        
        let sourcesToExport = data.data;
        
        // 根据选项筛选
        if (exportEnabled) {
          sourcesToExport = sourcesToExport.filter(source => source.enabled);
        }
        
        if (exportByGroup) {
          sourcesToExport = sourcesToExport.filter(source => source.group === exportGroup);
        }
        
        if (sourcesToExport.length === 0) {
          alert('没有符合条件的书源可导出');
          return;
        }
        
        // 创建并下载JSON文件
        const fileName = exportByGroup ? 
          `书源_${exportGroup}_${formatDate(new Date())}.json` : 
          `书源备份_${formatDate(new Date())}.json`;
        
        const json = JSON.stringify(sourcesToExport, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        
        // 清理
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        
      } catch (error) {
        console.error('导出书源失败:', error);
        alert(`导出书源失败: ${error.message}`);
      }
    }
    
    // 格式化日期为 YYYYMMDD 格式
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}${month}${day}`;
    }
    
    // 更新测试书源选择器
    function loadTestSourceSelect(sources) {
      const select = document.getElementById('testSourceName');
      if (!select) return;
      
      select.innerHTML = '<option value="">选择书源...</option>';
      
      // 仅添加启用的书源
      const enabledSources = sources.filter(source => source.enabled);
      
      enabledSources.forEach(source => {
        const option = document.createElement('option');
        option.value = source.name;
        option.textContent = source.name;
        select.appendChild(option);
      });
    }
    
    // 导入书源功能已移至 ../js/booksource/import.js
    
    // 格式化文件大小
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // 测试书籍详情
    async function testBookDetail(sourceName, bookUrl) {
      try {
        // 显示书籍详情区域
        document.getElementById('bookDetailSection').style.display = 'block';
        document.getElementById('bookDetailContent').innerHTML = '<div class="loader"></div>';
        
        // 滚动到书籍详情区域
        document.getElementById('bookDetailSection').scrollIntoView({ behavior: 'smooth' });
        
        // 获取认证令牌
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        
        // 发起测试请求
        const response = await fetch(`/api/booksource/sources/test`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sourceName,
            bookUrl: decodeURIComponent(bookUrl),
            type: 'detail'  // 显式指定测试类型为书籍详情
          })
        });
        
        if (!response.ok) {
          throw new Error('获取书籍详情失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '获取书籍详情失败');
        }
        
        // 显示书籍详情
        renderBookDetail(data.data, sourceName);
        
      } catch (error) {
        console.error('测试书籍详情失败:', error);
        document.getElementById('bookDetailContent').innerHTML = 
          `<div class="text-red-500 py-2">
            <i class="fas fa-exclamation-circle mr-2"></i>${error.message}
          </div>`;
      }
    }

    // 渲染书籍详情
    function renderBookDetail(book, sourceName) {
      const container = document.getElementById('bookDetailContent');
      
      if (!book) {
        container.innerHTML = 
          `<div class="text-gray-500 py-2">
            <i class="fas fa-info-circle mr-2"></i>无法获取书籍详情
          </div>`;
        return;
      }
      
      let html = `
        <div class="flex flex-col md:flex-row">
          <div class="md:w-1/4 mb-4 md:mb-0 md:mr-4">
            ${book.cover ? 
              `<img src="${book.cover}" alt="${book.name}" class="w-full rounded-md shadow">` : 
              `<div class="w-full h-40 bg-gray-200 rounded-md flex items-center justify-center">
                <i class="fas fa-book text-gray-400 text-4xl"></i>
              </div>`
            }
          </div>
          <div class="md:w-3/4">
            <h3 class="text-xl font-bold mb-2">${book.name || '未知书名'}</h3>
            <div class="space-y-2 mb-4">
              <p><span class="text-gray-600">作者：</span>${book.author || '未知'}</p>
              <p><span class="text-gray-600">更新时间：</span>${book.lastUpdate || '未知'}</p>
              <p><span class="text-gray-600">最新章节：</span>${book.lastChapter || '未知'}</p>
              <p><span class="text-gray-600">分类：</span>${book.category || '未知'}</p>
              <p><span class="text-gray-600">字数：</span>${book.wordCount || '未知'}</p>
            </div>
            <div class="mb-4">
              <h4 class="text-sm font-medium text-gray-700 mb-1">简介：</h4>
              <div class="text-sm text-gray-600 bg-gray-50 p-2 rounded">
                ${book.intro ? book.intro.replace(/\n/g, '<br>') : '暂无简介'}
              </div>
            </div>
            <div>
              <button class="px-3 py-1 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700"
                onclick="testChapterList('${sourceName}', '${encodeURIComponent(book.chapterUrl || book.url)}')">
                查看章节列表
              </button>
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    // 测试章节列表
    async function testChapterList(sourceName, chapterUrl) {
      try {
        // 显示章节列表区域
        document.getElementById('chapterListSection').style.display = 'block';
        document.getElementById('chapterListContent').innerHTML = '<div class="loader"></div>';
        
        // 隐藏章节内容区域
        document.getElementById('chapterContentSection').style.display = 'none';
        
        // 滚动到章节列表区域
        document.getElementById('chapterListSection').scrollIntoView({ behavior: 'smooth' });
        
        // 获取认证令牌
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        
        // 发起测试章节列表请求
        const response = await fetch(`/api/booksource/sources/test`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sourceName,
            chapterUrl: decodeURIComponent(chapterUrl),
            type: 'chapters'  // 显式指定测试类型为章节列表
          })
        });
        
        if (!response.ok) {
          throw new Error('获取章节列表失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '获取章节列表失败');
        }
        
        // 显示章节列表
        renderChapterList(data.data, sourceName);
        
      } catch (error) {
        console.error('测试章节列表失败:', error);
        document.getElementById('chapterListContent').innerHTML = 
          `<div class="text-red-500 py-2">
            <i class="fas fa-exclamation-circle mr-2"></i>${error.message}
          </div>`;
      }
    }

    // 渲染章节列表
    function renderChapterList(chapters, sourceName) {
      const container = document.getElementById('chapterListContent');
      
      if (!chapters || chapters.length === 0) {
        container.innerHTML = 
          `<div class="text-gray-500 py-2">
            <i class="fas fa-info-circle mr-2"></i>没有找到章节
          </div>`;
        return;
      }
      
      let html = `
        <div class="space-y-3">
          <p class="text-sm text-gray-500">共 ${chapters.length} 章</p>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
      `;
      
      chapters.forEach((chapter, index) => {
        html += `
          <div class="text-sm">
            <button class="w-full text-left px-2 py-1 hover:bg-blue-50 rounded text-blue-600 overflow-hidden overflow-ellipsis whitespace-nowrap"
              onclick="testChapterContent('${sourceName}', '${encodeURIComponent(chapter.url)}', '${encodeURIComponent(chapter.name)}')">
              ${index + 1}. ${chapter.name}
            </button>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    // 测试章节内容
    async function testChapterContent(sourceName, chapterUrl, chapterName) {
      try {
        // 显示章节内容区域
        document.getElementById('chapterContentSection').style.display = 'block';
        document.getElementById('chapterContentDisplay').innerHTML = '<div class="loader"></div>';
        document.getElementById('chapterContentInfo').textContent = `章节：${decodeURIComponent(chapterName)}`;
        
        // 滚动到章节内容区域
        document.getElementById('chapterContentSection').scrollIntoView({ behavior: 'smooth' });
        
        // 获取认证令牌
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        
        // 发起测试章节内容请求
        const response = await fetch(`/api/booksource/sources/test`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sourceName,
            chapterUrl: decodeURIComponent(chapterUrl),
            type: 'content'  // 显式指定测试类型为章节内容
          })
        });
        
        if (!response.ok) {
          throw new Error('获取章节内容失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '获取章节内容失败');
        }
        
        // 显示章节内容
        renderChapterContent(data.data);
        
      } catch (error) {
        console.error('测试章节内容失败:', error);
        document.getElementById('chapterContentDisplay').innerHTML = 
          `<div class="text-red-500 py-2">
            <i class="fas fa-exclamation-circle mr-2"></i>${error.message}
          </div>`;
      }
    }

    // 渲染章节内容
    function renderChapterContent(content) {
      const container = document.getElementById('chapterContentDisplay');
      
      if (!content) {
        container.innerHTML = 
          `<div class="text-gray-500 py-2">
            <i class="fas fa-info-circle mr-2"></i>无法获取章节内容
          </div>`;
        return;
      }
      
      // 处理内容
      const formattedContent = content
        .replace(/\n+/g, '\n')  // 合并多个换行
        .replace(/\n/g, '<br>') // 将换行转换为HTML换行
        .replace(/\s\s+/g, ' '); // 合并多个空格
      
      container.innerHTML = `
        <div class="text-gray-800 leading-relaxed">
          ${formattedContent || '章节内容为空'}
        </div>
      `;
    }

    // 测试指定书源（从书源列表点击测试按钮）
    function testSource(sourceName) {
      // 切换到测试面板
      document.getElementById('tabTest').click();
      
      // 等待书源加载完成
      setTimeout(() => {
        // 清除现有筛选
        document.getElementById('testSourceFilter').value = '';
        document.getElementById('testSourceGroupFilter').value = '';
        
        // 重置筛选条件，加载所有书源
        filterTestSources();
        
        // 取消所有选择
        deselectAllTestSources();
        
        // 找到包含该书源的页面并加载
        const allSources = testSourcePagination.allSources;
        let sourceIndex = -1;
        
        for (let i = 0; i < allSources.length; i++) {
          if (allSources[i].name === sourceName) {
            sourceIndex = i;
            break;
          }
        }
        
        if (sourceIndex !== -1) {
          // 计算该书源在哪一页
          const targetPage = Math.floor(sourceIndex / testSourcePagination.pageSize) + 1;
          testSourcePagination.currentPage = targetPage;
          
          // 渲染该页
          renderTestSourcePage();
          
          // 等待DOM更新后选中对应的书源
          setTimeout(() => {
            const sourceItems = document.querySelectorAll('.test-source-item');
            sourceItems.forEach(item => {
              if (item.dataset.name === sourceName) {
                // 选中复选框
                const checkbox = item.querySelector('.test-source-checkbox');
                if (checkbox) {
                  checkbox.checked = true;
                  
                  // 更新行状态
                  item.setAttribute('data-selected', 'true');
                  item.classList.add('bg-blue-50');
                  
                  // 确保该项可见
                  item.style.display = '';
                  
                  // 滚动到该项
                  item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  
                  // 高亮显示（临时闪烁效果）
                  item.classList.add('bg-blue-200');
                  setTimeout(() => {
                    item.classList.remove('bg-blue-200');
                  }, 1500);
                }
              }
            });
            
            // 更新选中数量
            updateSelectedSourcesCount();
          }, 100);
        }
        
        // 聚焦关键词输入框
        document.getElementById('testKeyword').focus();
      }, 300);
    }

    // 更新批量操作栏的显示状态
    function updateBatchOperationsBar() {
      const checkboxes = document.querySelectorAll('.source-checkbox:checked');
      const batchBar = document.getElementById('batchOperationsBar');
      const infoElement = document.getElementById('selectedSourcesInfo');
      
      if (checkboxes.length > 0) {
        // 显示批量操作栏
        batchBar.classList.remove('hidden');
        
        // 更新已选择的数量
        if (infoElement) {
          infoElement.textContent = `已选择 ${checkboxes.length} 个书源`;
        }
        
        // 根据选中书源的状态，禁用/启用某些按钮
        const batchEnableBtn = document.getElementById('batchEnableBtn');
        const batchDisableBtn = document.getElementById('batchDisableBtn');
        
        // 检查是否所有选中的书源都已启用/禁用
        const allEnabled = Array.from(checkboxes).every(cb => {
          const row = cb.closest('.source-item');
          return row && row.getAttribute('data-enabled') === 'true';
        });
        
        const allDisabled = Array.from(checkboxes).every(cb => {
          const row = cb.closest('.source-item');
          return row && row.getAttribute('data-enabled') === 'false';
        });
        
        if (batchEnableBtn) {
          batchEnableBtn.disabled = allEnabled;
          batchEnableBtn.classList.toggle('opacity-50', allEnabled);
          batchEnableBtn.classList.toggle('cursor-not-allowed', allEnabled);
        }
        
        if (batchDisableBtn) {
          batchDisableBtn.disabled = allDisabled;
          batchDisableBtn.classList.toggle('opacity-50', allDisabled);
          batchDisableBtn.classList.toggle('cursor-not-allowed', allDisabled);
        }
      } else {
        // 隐藏批量操作栏
        batchBar.classList.add('hidden');
      }
    }
    
    // 获取选中的书源名称
    function getSelectedSourceNames() {
      const checkboxes = document.querySelectorAll('.source-checkbox:checked');
      const sourceNames = [];
      
      checkboxes.forEach(checkbox => {
        const row = checkbox.closest('.source-item');
        if (row) {
          const sourceName = row.getAttribute('data-name');
          if (sourceName) {
            sourceNames.push(sourceName);
          }
        }
      });
      
      return sourceNames;
    }
    
    // 批量启用书源
    async function batchEnableSources() {
      const sourceNames = getSelectedSourceNames();
      if (sourceNames.length === 0) return;
      
      try {
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        
        // 显示确认对话框
        const confirmed = await showConfirmDialog(
          '批量启用书源',
          `确定要启用选中的 ${sourceNames.length} 个书源吗？`
        );
        
        if (!confirmed) return;
        
        // 显示加载提示
        showToast('正在处理...', 'info', 0);
        
        // 创建所有请求的Promise
        const promises = sourceNames.map(sourceName => 
          fetch(`/api/booksource/toggle`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: sourceName,
              enabled: true
            })
          }).then(response => {
            if (!response.ok) throw new Error(`操作失败: ${sourceName}`);
            return response.json();
          })
        );
        
        // 等待所有请求完成
        await Promise.all(promises);
        
        // 重新加载书源列表
        await loadBookSources();
        
        // 显示成功消息
        showToast(`成功启用 ${sourceNames.length} 个书源`, 'success');
        
      } catch (error) {
        console.error('批量启用书源失败:', error);
        showToast(`操作失败: ${error.message}`, 'error');
      }
    }
    
    // 批量停用书源
    async function batchDisableSources() {
      const sourceNames = getSelectedSourceNames();
      if (sourceNames.length === 0) return;
      
      try {
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        
        // 显示确认对话框
        const confirmed = await showConfirmDialog(
          '批量停用书源',
          `确定要停用选中的 ${sourceNames.length} 个书源吗？`
        );
        
        if (!confirmed) return;
        
        // 显示加载提示
        showToast('正在处理...', 'info', 0);
        
        // 创建所有请求的Promise
        const promises = sourceNames.map(sourceName => 
          fetch(`/api/booksource/toggle`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: sourceName,
              enabled: false
            })
          }).then(response => {
            if (!response.ok) throw new Error(`操作失败: ${sourceName}`);
            return response.json();
          })
        );
        
        // 等待所有请求完成
        await Promise.all(promises);
        
        // 重新加载书源列表
        await loadBookSources();
        
        // 显示成功消息
        showToast(`成功停用 ${sourceNames.length} 个书源`, 'success');
        
      } catch (error) {
        console.error('批量停用书源失败:', error);
        showToast(`操作失败: ${error.message}`, 'error');
      }
    }
    
    // 批量删除书源
    async function batchDeleteSources() {
      const sourceNames = getSelectedSourceNames();
      if (sourceNames.length === 0) return;
      
      try {
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        
        // 显示确认对话框
        const confirmed = await showConfirmDialog(
          '批量删除书源',
          `确定要删除选中的 ${sourceNames.length} 个书源吗？此操作不可恢复！`,
          'danger'
        );
        
        if (!confirmed) return;
        
        // 显示加载提示
        showToast('正在处理...', 'info', 0);
        
        // 创建所有请求的Promise
        const promises = sourceNames.map(sourceName => 
          fetch(`/api/booksource/source`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: sourceName
            })
          }).then(response => {
            if (!response.ok) throw new Error(`删除失败: ${sourceName}`);
            return response.json();
          })
        );
        
        // 等待所有请求完成
        await Promise.all(promises);
        
        // 重新加载书源列表
        await loadBookSources();
        
        // 显示成功消息
        showToast(`成功删除 ${sourceNames.length} 个书源`, 'success');
        
      } catch (error) {
        console.error('批量删除书源失败:', error);
        showToast(`操作失败: ${error.message}`, 'error');
      }
    }
    
    // 帮助函数：显示确认对话框
    function showConfirmDialog(title, message, type = 'warning') {
      return new Promise((resolve) => {
        const dialogId = 'confirmDialog';
        let dialog = document.getElementById(dialogId);
        
        // 如果对话框已存在，先移除
        if (dialog) {
          document.body.removeChild(dialog);
        }
        
        // 创建新的对话框
        dialog = document.createElement('div');
        dialog.id = dialogId;
        dialog.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
        
        const iconClass = type === 'danger' ? 'text-red-500' : 'text-yellow-500';
        const iconType = type === 'danger' ? 'exclamation-triangle' : 'exclamation-circle';
        
        dialog.innerHTML = `
          <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 flex items-center">
              <i class="fas fa-${iconType} ${iconClass} text-2xl mr-3"></i>
              <h3 class="text-lg font-medium text-gray-900">${title}</h3>
            </div>
            <div class="px-6 pb-4">
              <p class="text-sm text-gray-600">${message}</p>
            </div>
            <div class="px-6 py-3 bg-gray-50 flex justify-end space-x-2 rounded-b-lg">
              <button id="${dialogId}-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                取消
              </button>
              <button id="${dialogId}-confirm" class="px-4 py-2 text-sm font-medium text-white ${type === 'danger' ? 'bg-red-600 hover:bg-red-700' : 'bg-yellow-600 hover:bg-yellow-700'} rounded-md">
                确定
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(dialog);
        
        // 添加事件监听
        document.getElementById(`${dialogId}-cancel`).addEventListener('click', () => {
          document.body.removeChild(dialog);
          resolve(false);
        });
        
        document.getElementById(`${dialogId}-confirm`).addEventListener('click', () => {
          document.body.removeChild(dialog);
          resolve(true);
        });
      });
    }
    
    // 更新分页信息和控件
    function updatePagination(data) {
      const paginationContainer = document.getElementById('paginationContainer');
      if (!paginationContainer) return;
      
      // 重置分页容器
      paginationContainer.innerHTML = '';
      
      // 如果没有数据或数据不足一页，不显示分页
      if (!data || !data.data || data.data.length === 0) {
        paginationContainer.classList.add('hidden');
        return;
      }
      
      // 显示分页区域
      paginationContainer.classList.remove('hidden');
      
      // 获取分页信息
      const currentPage = data.page || 1;
      const totalPages = data.total_pages || 1;
      const pageSize = data.page_size || 10;
      const totalItems = data.total || 0;
      
      // 开始构建分页UI
      let paginationHTML = `
        <div class="flex flex-col sm:flex-row justify-between items-center mt-4 text-sm">
          <div class="text-gray-600 mb-2 sm:mb-0">
            共 ${totalItems} 个书源，每页 ${pageSize} 个，第 ${currentPage}/${totalPages} 页
          </div>
          <div class="flex space-x-1">
      `;
      
      // 上一页按钮
      paginationHTML += `
        <button class="pagination-btn px-3 py-1 rounded ${currentPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-100'}" 
          data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
      `;
      
      // 页码按钮
      // 确定显示哪些页码
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      
      // 调整以确保显示5个页码
      if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
      }
      
      // 第一页
      if (startPage > 1) {
        paginationHTML += `
          <button class="pagination-btn px-3 py-1 rounded bg-white text-gray-700 hover:bg-gray-100" data-page="1">1</button>
        `;
        
        // 如果第一页和开始页相差超过1，显示省略号
        if (startPage > 2) {
          paginationHTML += `
            <span class="px-3 py-1">...</span>
          `;
        }
      }
      
      // 中间页码
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
          <button class="pagination-btn px-3 py-1 rounded ${i === currentPage ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}" 
            data-page="${i}">${i}</button>
        `;
      }
      
      // 最后一页
      if (endPage < totalPages) {
        // 如果结束页和最后一页相差超过1，显示省略号
        if (endPage < totalPages - 1) {
          paginationHTML += `
            <span class="px-3 py-1">...</span>
          `;
        }
        
        paginationHTML += `
          <button class="pagination-btn px-3 py-1 rounded bg-white text-gray-700 hover:bg-gray-100" 
            data-page="${totalPages}">${totalPages}</button>
        `;
      }
      
      // 下一页按钮
      paginationHTML += `
        <button class="pagination-btn px-3 py-1 rounded ${currentPage === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-100'}" 
          data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      `;
      
      paginationHTML += `
          </div>
        </div>
      `;
      
      // 设置HTML并添加事件监听
      paginationContainer.innerHTML = paginationHTML;
      
      // 添加分页按钮点击事件
      const pageButtons = paginationContainer.querySelectorAll('.pagination-btn');
      pageButtons.forEach(button => {
        if (!button.disabled) {
          button.addEventListener('click', function() {
            const pageNumber = parseInt(this.getAttribute('data-page'));
            if (!isNaN(pageNumber)) {
              loadPage(pageNumber);
            }
          });
        }
      });
    }
    
    // 加载指定页面
    async function loadPage(pageNumber) {
      try {
        const token = getAuthToken();
        
        // 显示加载提示
        const container = document.getElementById('sourceListContainer');
        container.innerHTML = '<div class="text-center py-8"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">加载中...</p></div>';
        
        // 获取搜索和筛选条件
        const searchInput = document.getElementById('sourceSearchInput');
        const groupFilter = document.getElementById('groupFilter');
        const searchValue = searchInput ? searchInput.value.trim() : '';
        const selectedGroup = groupFilter ? groupFilter.value : 'all';
        
        // 构建API请求路径
        let apiPath = `/api/booksource/sources?page=${pageNumber}`;
        
        if (searchValue) {
          apiPath += `&keyword=${encodeURIComponent(searchValue)}`;
        }
        
        if (selectedGroup && selectedGroup !== 'all') {
          apiPath += `&group=${encodeURIComponent(selectedGroup)}`;
        }
        
        // 发送API请求
        const response = await fetch(apiPath, {
          headers: {
            'Authorization': token ? `Bearer ${token}` : '',
          }
        });
        
        if (!response.ok) {
          throw new Error('加载书源失败');
        }
        
        const data = await response.json();
        
        // 渲染书源列表
        renderSourceList(data.data);
        
        // 更新分页信息
        updatePagination(data);
        
        // 滚动到页面顶部
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
      } catch (error) {
        console.error('加载书源页面失败:', error);
        document.getElementById('sourceListContainer').innerHTML = `
          <div class="text-center py-8 text-red-500">
            <i class="fas fa-exclamation-circle text-xl mb-2"></i>
            <p>加载失败: ${error.message}</p>
            <button class="mt-2 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" onclick="loadBookSources()">
              <i class="fas fa-sync-alt mr-1"></i> 重试
            </button>
          </div>
        `;
      }
    }

    // 编辑书源
    async function editSource(sourceName) {
      try {
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        
        // 显示加载提示
        showToast('正在加载书源...', 'info');
        
        // 获取书源详情
        const response = await fetch(`/api/booksource/source?name=${encodeURIComponent(sourceName)}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('获取书源详情失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '获取书源详情失败');
        }
        
        const source = data.data;
        
        // 打开编辑面板并填充数据
        openEditPanel(source);
        
      } catch (error) {
        console.error('编辑书源失败:', error);
        showToast(`编辑失败: ${error.message}`, 'error');
      }
    }

    // 删除书源
    async function deleteSource(sourceName) {
      try {
        // 显示确认对话框
        const confirmed = await showConfirmDialog(
          '删除书源',
          `确定要删除书源「${sourceName}」吗？此操作不可恢复！`,
          'danger'
        );
        
        if (!confirmed) return;
        
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        
        // 显示加载提示
        showToast('正在删除书源...', 'info', 0);
        
        // 发送删除请求
        const response = await fetch(`/api/booksource/source`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: sourceName
          })
        });
        
        if (!response.ok) {
          throw new Error('删除书源失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '删除书源失败');
        }
        
        // 重新加载书源列表
        await loadBookSources();
        
        // 显示成功消息
        showToast(`书源「${sourceName}」已删除`, 'success');
        
      } catch (error) {
        console.error('删除书源失败:', error);
        showToast(`删除失败: ${error.message}`, 'error');
      }
    }
    
    // 切换书源状态（启用/禁用）
    async function toggleSource(sourceName, enabled) {
      try {
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        
        // 显示加载提示
        showToast(`正在${enabled ? '启用' : '禁用'}书源...`, 'info', 0);
        
        // 发送请求
        const response = await fetch(`/api/booksource/toggle`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: sourceName,
            enabled: enabled
          })
        });
        
        if (!response.ok) {
          throw new Error(`${enabled ? '启用' : '禁用'}书源失败`);
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || `${enabled ? '启用' : '禁用'}书源失败`);
        }
        
        // 重新加载书源列表
        await loadBookSources();
        
        // 显示成功消息
        showToast(`书源「${sourceName}」已${enabled ? '启用' : '禁用'}`, 'success');
        
      } catch (error) {
        console.error(`${enabled ? '启用' : '禁用'}书源失败:`, error);
        showToast(`操作失败: ${error.message}`, 'error');
      }
    }
    
    // 测试书源
    async function testSource(sourceName) {
      try {
        const token = getAuthToken();
        if (!token) {
          throw new Error('未找到认证令牌');
        }
        
        // 显示加载提示
        showToast('正在准备测试...', 'info', 0);
        
        // 跳转到测试页面，将书源名称传递过去
        window.location.href = `/book-source-testing.html?source=${encodeURIComponent(sourceName)}`;
        
      } catch (error) {
        console.error('测试书源失败:', error);
        showToast(`测试失败: ${error.message}`, 'error');
      }
    }

    // 显示提示消息
    function showToast(message, type = 'info', duration = 3000) {
      // 创建toast容器（如果不存在）
      let toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'fixed top-4 right-4 z-50 flex flex-col items-end space-y-2';
        document.body.appendChild(toastContainer);
      }
      
      // 生成唯一ID
      const toastId = 'toast-' + Date.now();
      
      // 设置toast类型样式
      let typeClass, icon;
      switch (type) {
        case 'success':
          typeClass = 'bg-green-50 text-green-800 border-green-200';
          icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
          break;
        case 'error':
          typeClass = 'bg-red-50 text-red-800 border-red-200';
          icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
          break;
        case 'warning':
          typeClass = 'bg-yellow-50 text-yellow-800 border-yellow-200';
          icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>';
          break;
        case 'info':
        default:
          typeClass = 'bg-blue-50 text-blue-800 border-blue-200';
          icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
          break;
      }
      
      // 创建toast元素
      const toast = document.createElement('div');
      toast.id = toastId;
      toast.className = `flex items-center p-3 pr-4 max-w-xs rounded shadow-lg border ${typeClass} transition-all transform translate-x-0 opacity-100`;
      toast.innerHTML = `
        <div class="flex-shrink-0 mr-2">
          ${icon}
        </div>
        <div class="text-sm font-medium">${message}</div>
        <button class="ml-auto text-gray-400 hover:text-gray-600 focus:outline-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      `;
      
      // 添加到容器
      toastContainer.appendChild(toast);
      
      // 添加关闭按钮事件
      const closeButton = toast.querySelector('button');
      closeButton.addEventListener('click', () => {
        removeToast(toastId);
      });
      
      // 如果duration为0，不自动消失
      if (duration > 0) {
        // 设置定时消失
        setTimeout(() => {
          removeToast(toastId);
        }, duration);
      }
      
      return toastId;
    }
    
    // 移除Toast
    function removeToast(toastId) {
      const toast = document.getElementById(toastId);
      if (toast) {
        // 添加淡出动画
        toast.classList.replace('translate-x-0', 'translate-x-2');
        toast.classList.replace('opacity-100', 'opacity-0');
        
        // 动画结束后移除元素
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
          
          // 检查是否还有其他toast，如果没有则移除容器
          const toastContainer = document.getElementById('toastContainer');
          if (toastContainer && toastContainer.children.length === 0) {
            document.body.removeChild(toastContainer);
          }
        }, 300);
      }
    }
    
    // 辅助函数：延迟函数执行（防抖）
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }
  </script>
</body>
</html> 