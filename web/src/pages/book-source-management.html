<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>书源管理 - 百变书屋</title>
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- 添加通用脚本 -->
  <script src="/src/js/common.js"></script>
  <style>
    .admin-only {
      background-color: #f97316;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      margin-left: 0.5rem;
    }

    .card {
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      background-color: white;
      overflow: hidden;
    }

    .card-header {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
      background-color: #f9fafb;
      font-weight: 600;
    }

    .card-body {
      padding: 1rem;
    }

    .tab-active {
      border-bottom: 2px solid #3b82f6;
      color: #3b82f6;
    }

    .source-item {
      transition: all 0.2s;
    }

    .source-item:hover {
      background-color: #f3f4f6;
    }
    
    /* 加载动画 */
    .loader {
      border: 3px solid #f3f3f3;
      border-radius: 50%;
      border-top: 3px solid #3b82f6;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 权限页面 */
    .auth-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #fff;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
    }
    
    .auth-icon {
      font-size: 4rem;
      color: #ef4444;
      margin-bottom: 1rem;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .btn-primary {
      background-color: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #2563eb;
    }
    
    .btn-outline {
      border: 1px solid #d1d5db;
      background-color: white;
    }
    
    .btn-outline:hover {
      background-color: #f9fafb;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- 管理员认证屏幕 - 默认隐藏 -->
  <div id="authScreen" class="auth-screen" style="display: none;">
    <div class="auth-icon">
      <i class="fas fa-lock"></i>
    </div>
    <h2 class="text-2xl font-bold mb-2">需要管理员权限</h2>
    <p class="mb-6 text-gray-600">抱歉，只有管理员可以访问此页面。请使用管理员账号登录。</p>
    <div class="flex space-x-4">
      <a href="login.html" class="btn btn-primary">
        <i class="fas fa-sign-in-alt mr-2"></i>登录
      </a>
      <a href="home.html" class="btn btn-outline">
        <i class="fas fa-home mr-2"></i>返回首页
      </a>
    </div>
  </div>

  <!-- 导航栏 -->
  <nav class="navbar sticky top-0 z-10 px-4 py-3 bg-white shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center">
        <img src="../images/logo.svg" alt="百变书屋" class="h-10">
        <span class="ml-2 text-lg font-bold">百变书屋</span>
      </div>
      
      <div class="hidden md:flex items-center space-x-6">
        <a href="home.html" class="nav-item font-medium">首页</a>
        <a href="search.html" class="nav-item font-medium">智能搜索</a>
        <a href="bookshelf.html" class="nav-item font-medium">我的书架</a>
        <a href="community.html" class="nav-item font-medium">阅读社区</a>
        <a href="book-source-management.html" class="nav-item active font-medium">
          书源管理
          <span class="admin-only">管理员</span>
        </a>
      </div>
      
      <div class="flex items-center space-x-4">
        <a href="profile.html" class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white">
          <i class="fas fa-user"></i>
        </a>
        <button class="menu-button md:hidden text-gray-600">
          <i class="fas fa-bars text-xl"></i>
        </button>
      </div>
    </div>
    
    <!-- 移动端菜单 -->
    <div class="nav-menu hidden md:hidden mt-2 bg-white shadow-lg rounded-lg absolute right-4 left-4 p-4 z-50">
      <div class="flex flex-col space-y-3">
        <a href="home.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">首页</a>
        <a href="search.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">智能搜索</a>
        <a href="bookshelf.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">我的书架</a>
        <a href="community.html" class="nav-item py-2 px-4 rounded hover:bg-gray-100">阅读社区</a>
        <a href="book-source-management.html" class="nav-item active py-2 px-4 rounded hover:bg-gray-100">
          书源管理
          <span class="admin-only">管理员</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- 主要内容容器 -->
  <main class="container mx-auto py-6 px-4">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">书源管理</h1>
      <div id="userInfo" class="text-sm text-gray-500">
        <span id="loadingStatus"><i class="fas fa-spinner fa-spin mr-2"></i>正在验证权限...</span>
      </div>
    </div>
    
    <!-- 功能选项卡 -->
    <div class="flex border-b border-gray-200 mb-6">
      <button id="tabSources" class="px-4 py-2 text-sm font-medium tab-active" data-tab="sourcesPanel">
        <i class="fas fa-list mr-2"></i>书源列表
      </button>
      <button id="tabAdd" class="px-4 py-2 text-sm font-medium text-gray-500" data-tab="addPanel">
        <i class="fas fa-plus mr-2"></i>添加书源
      </button>
      <button id="tabImport" class="px-4 py-2 text-sm font-medium text-gray-500" data-tab="importPanel">
        <i class="fas fa-file-import mr-2"></i>导入/导出
      </button>
      <button id="tabTest" class="px-4 py-2 text-sm font-medium text-gray-500" data-tab="testPanel">
        <i class="fas fa-vial mr-2"></i>测试书源
      </button>
    </div>
    
    <!-- 内容面板 - 书源列表（默认显示） -->
    <div id="sourcesPanel" class="card">
      <div class="card-header flex justify-between items-center">
        <div>书源列表</div>
        <div class="flex space-x-2">
          <input type="text" id="sourceSearch" placeholder="搜索书源..." class="px-3 py-1 text-sm border border-gray-300 rounded-md">
          <select id="sourceGroup" class="px-3 py-1 text-sm border border-gray-300 rounded-md">
            <option value="">所有分组</option>
          </select>
        </div>
      </div>
      <div class="card-body" id="sourceListContainer">
        <div class="flex justify-center py-8">
          <div class="loader"></div>
        </div>
      </div>
    </div>
    
    <!-- 内容面板 - 添加书源（默认隐藏） -->
    <div id="addPanel" class="card" style="display: none;">
      <div class="card-header">添加/编辑书源</div>
      <div class="card-body">
        <form id="sourceForm" class="space-y-4">
          <input type="hidden" id="editMode" value="add">
          
          <!-- 基本信息 -->
          <div class="bg-blue-50 rounded-md p-3 mb-4">
            <h3 class="text-sm font-bold text-blue-800 mb-2">基本信息</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="sourceName">
                  书源名称 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="sourceName" name="name" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="sourceUrl">
                  书源URL <span class="text-red-500">*</span>
                </label>
                <input type="url" id="sourceUrl" name="url" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="sourceGroup">
                  分组
                </label>
                <input type="text" id="sourceGroup" name="group" list="groupList"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <datalist id="groupList"></datalist>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="sourceIcon">
                  图标URL
                </label>
                <input type="url" id="sourceIcon" name="icon"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div class="flex items-center space-x-2 md:col-span-2">
                <input type="checkbox" id="sourceEnabled" name="enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                <label class="text-sm font-medium text-gray-700" for="sourceEnabled">
                  启用
                </label>
              </div>
            </div>
          </div>
          
          <!-- 搜索规则 -->
          <div class="bg-green-50 rounded-md p-3 mb-4">
            <h3 class="text-sm font-bold text-green-800 mb-2">搜索规则</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="searchUrl">
                  搜索URL <span class="text-red-500">*</span>
                  <span class="text-xs text-gray-500">（使用{keyword}作为搜索关键词占位符）</span>
                </label>
                <input type="text" id="searchUrl" name="searchUrl" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="searchList">
                  搜索结果列表选择器 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="searchList" name="searchList" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="searchName">
                    书名选择器 <span class="text-red-500">*</span>
                  </label>
                  <input type="text" id="searchName" name="searchName" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="searchAuthor">
                    作者选择器
                  </label>
                  <input type="text" id="searchAuthor" name="searchAuthor"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="searchDetail">
                    详情链接选择器 <span class="text-red-500">*</span>
                  </label>
                  <input type="text" id="searchDetail" name="searchDetail" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
              </div>
            </div>
          </div>
          
          <!-- 详情页规则 -->
          <div class="bg-purple-50 rounded-md p-3 mb-4">
            <h3 class="text-sm font-bold text-purple-800 mb-2">详情页规则</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="detailName">
                  书名选择器
                </label>
                <input type="text" id="detailName" name="detailName"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="detailAuthor">
                  作者选择器
                </label>
                <input type="text" id="detailAuthor" name="detailAuthor"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="detailCover">
                  封面图片选择器
                </label>
                <input type="text" id="detailCover" name="detailCover"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="detailIntro">
                  简介选择器
                </label>
                <input type="text" id="detailIntro" name="detailIntro"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="detailChapterUrl">
                  章节列表URL选择器 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="detailChapterUrl" name="detailChapterUrl" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>
          </div>
          
          <!-- 章节列表规则 -->
          <div class="bg-yellow-50 rounded-md p-3 mb-4">
            <h3 class="text-sm font-bold text-yellow-800 mb-2">章节列表规则</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="chapterList">
                  章节列表选择器 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="chapterList" name="chapterList" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="chapterName">
                  章节名选择器 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="chapterName" name="chapterName" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="chapterLink">
                  章节链接选择器 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="chapterLink" name="chapterLink" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>
          </div>
          
          <!-- 内容规则 -->
          <div class="bg-red-50 rounded-md p-3 mb-4">
            <h3 class="text-sm font-bold text-red-800 mb-2">内容规则</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="contentRule">
                  内容选择器 <span class="text-red-500">*</span>
                </label>
                <input type="text" id="contentRule" name="contentRule" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="contentFilters">
                  内容过滤规则
                  <span class="text-xs text-gray-500">（多个规则用逗号分隔）</span>
                </label>
                <input type="text" id="contentFilters" name="contentFilters"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>
          </div>
          
          <!-- 提交按钮 -->
          <div class="flex space-x-3 justify-end">
            <button type="button" id="resetBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
              重置
            </button>
            <button type="submit" id="saveBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">
              保存
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- 内容面板 - 导入导出（默认隐藏） -->
    <div id="importPanel" class="card" style="display: none;">
      <div class="card-header">导入/导出书源</div>
      <div class="card-body">
        <div class="space-y-6">
          <!-- 导出部分 -->
          <div class="border-b border-gray-200 pb-5">
            <h3 class="text-lg font-medium text-gray-900 mb-3">导出书源</h3>
            <p class="text-sm text-gray-500 mb-4">将当前所有书源导出为JSON文件，方便备份和分享。</p>
            
            <div class="space-y-3">
              <div class="flex items-center space-x-2">
                <input type="checkbox" id="exportAll" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                <label for="exportAll" class="text-sm font-medium text-gray-700">导出所有书源</label>
              </div>
              
              <div class="flex items-center space-x-2">
                <input type="checkbox" id="exportEnabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="exportEnabled" class="text-sm font-medium text-gray-700">仅导出已启用的书源</label>
              </div>
              
              <div class="flex items-center space-x-2">
                <input type="checkbox" id="exportByGroup" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="exportByGroup" class="text-sm font-medium text-gray-700">按分组导出</label>
                
                <select id="exportGroup" class="ml-2 px-3 py-1 text-sm border border-gray-300 rounded-md disabled:opacity-50" disabled>
                  <option value="">选择分组...</option>
                </select>
              </div>
              
              <div class="mt-4">
                <button id="exportBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">
                  <i class="fas fa-file-export mr-2"></i>导出书源
                </button>
              </div>
            </div>
          </div>
          
          <!-- 导入部分将在下一步添加 -->
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-3">导入书源</h3>
            <p class="text-sm text-gray-500 mb-4">从JSON文件导入书源，支持批量导入。</p>
            
            <!-- 导入选项 -->
            <div class="space-y-4">
              <div class="tabs flex space-x-4 border-b border-gray-200">
                <button id="fileImportTab" class="px-4 py-2 text-sm font-medium tab-active" data-import-tab="fileImport">
                  <i class="fas fa-file mr-2"></i>从文件导入
                </button>
                <button id="textImportTab" class="px-4 py-2 text-sm font-medium text-gray-500" data-import-tab="textImport">
                  <i class="fas fa-code mr-2"></i>从文本导入
                </button>
              </div>
              
              <!-- 文件导入面板 -->
              <div id="fileImport" class="p-4 bg-gray-50 rounded-md">
                <div class="space-y-4">
                  <div class="flex items-center justify-center border-2 border-dashed border-gray-300 rounded-md py-8 px-4">
                    <div class="text-center">
                      <i class="fas fa-file-upload text-gray-400 text-3xl mb-2"></i>
                      <p class="text-sm text-gray-500 mb-2">点击选择或拖放JSON文件</p>
                      <input type="file" id="fileInput" accept=".json" class="hidden">
                      <button id="fileSelectBtn" class="px-3 py-1 text-sm font-medium text-blue-600 border border-blue-600 rounded-md hover:bg-blue-50">
                        选择文件
                      </button>
                    </div>
                  </div>
                  
                  <div id="fileInfo" class="hidden">
                    <div class="flex items-center p-3 bg-blue-50 rounded-md">
                      <i class="fas fa-file-alt text-blue-500 mr-3 text-xl"></i>
                      <div class="flex-1">
                        <p id="fileName" class="font-medium"></p>
                        <p id="fileSize" class="text-sm text-gray-500"></p>
                      </div>
                      <button id="fileClearBtn" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 文本导入面板 -->
              <div id="textImport" class="p-4 bg-gray-50 rounded-md" style="display: none;">
                <div class="space-y-4">
                  <textarea id="importText" rows="8" placeholder="粘贴JSON格式的书源数据"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    
                  <div class="text-xs text-gray-500">
                    <p>
                      <i class="fas fa-info-circle mr-1"></i>
                      支持单个书源（{"name": "..."}）或书源数组（[{"name": "..."}, ...]）格式
                    </p>
                  </div>
                </div>
              </div>
              
              <!-- 导入选项 -->
              <div class="space-y-3 mt-4">
                <div class="flex items-center space-x-2">
                  <input type="checkbox" id="importOverwrite" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                  <label for="importOverwrite" class="text-sm font-medium text-gray-700">
                    覆盖同名书源
                  </label>
                </div>
                
                <div class="flex items-center space-x-2">
                  <input type="checkbox" id="importEnable" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                  <label for="importEnable" class="text-sm font-medium text-gray-700">
                    导入后自动启用
                  </label>
                </div>
              </div>
              
              <!-- 导入按钮 -->
              <div class="mt-4">
                <button id="importBtn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 border border-transparent rounded-md hover:bg-green-700">
                  <i class="fas fa-file-import mr-2"></i>导入书源
                </button>
                <div id="importStatus" class="mt-2 text-sm"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 内容面板 - 测试书源（默认隐藏） -->
    <div id="testPanel" class="card" style="display: none;">
      <div class="card-header">测试书源</div>
      <div class="card-body">
        <div class="space-y-6">
          <div class="bg-gray-50 rounded-md p-4">
            <h3 class="text-md font-medium text-gray-900 mb-3">配置测试</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="testSourceName">
                  书源
                </label>
                <select id="testSourceName" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  <option value="">选择书源...</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="testKeyword">
                  搜索关键词
                </label>
                <input type="text" id="testKeyword" placeholder="例如：武侠"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>
            
            <div class="mt-4 flex space-x-3">
              <button id="testSearchBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">
                <i class="fas fa-search mr-2"></i>测试搜索
              </button>
              <button id="testClearBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                <i class="fas fa-trash mr-2"></i>清除结果
              </button>
            </div>
          </div>
          
          <div id="testResults" class="space-y-4" style="display: none;">
            <div class="border-b border-gray-200 pb-2">
              <h3 class="text-md font-medium text-gray-900">测试结果</h3>
            </div>
            
            <!-- 搜索结果 -->
            <div id="searchResults" class="space-y-3">
              <h4 class="text-sm font-medium text-gray-700">搜索结果</h4>
              <div id="searchResultsContent" class="bg-gray-50 p-3 rounded-md overflow-x-auto">
                <div class="loader"></div>
              </div>
            </div>
            
            <!-- 书籍详情 -->
            <div id="bookDetailSection" class="space-y-3" style="display: none;">
              <h4 class="text-sm font-medium text-gray-700">书籍详情</h4>
              <div id="bookDetailContent" class="bg-gray-50 p-3 rounded-md">
                <div class="loader"></div>
              </div>
            </div>
            
            <!-- 章节列表 -->
            <div id="chapterListSection" class="space-y-3" style="display: none;">
              <h4 class="text-sm font-medium text-gray-700">章节列表</h4>
              <div id="chapterListContent" class="bg-gray-50 p-3 rounded-md max-h-60 overflow-y-auto">
                <div class="loader"></div>
              </div>
            </div>
            
            <!-- 章节内容 -->
            <div id="chapterContentSection" class="space-y-3" style="display: none;">
              <h4 class="text-sm font-medium text-gray-700">章节内容</h4>
              <div id="chapterContentInfo" class="text-sm text-gray-500 mb-1"></div>
              <div id="chapterContentDisplay" class="bg-gray-50 p-3 rounded-md max-h-96 overflow-y-auto">
                <div class="loader"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 基础脚本 -->
  <script src="../js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 移动端菜单切换
      const menuButton = document.querySelector('.menu-button');
      const navMenu = document.querySelector('.nav-menu');
      
      if (menuButton && navMenu) {
        menuButton.addEventListener('click', function() {
          navMenu.classList.toggle('hidden');
        });
      }
      
      // 选项卡切换
      const tabs = document.querySelectorAll('[data-tab]');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // 移除所有选项卡的活动状态
          tabs.forEach(t => t.classList.remove('tab-active'));
          tabs.forEach(t => t.classList.add('text-gray-500'));
          
          // 添加当前选项卡的活动状态
          this.classList.add('tab-active');
          this.classList.remove('text-gray-500');
          
          // 隐藏所有面板
          const panels = document.querySelectorAll('.card');
          panels.forEach(panel => panel.style.display = 'none');
          
          // 显示当前面板
          const panel = document.getElementById(this.dataset.tab);
          if (panel) panel.style.display = 'block';
        });
      });
      
      // 表单提交处理
      const sourceForm = document.getElementById('sourceForm');
      sourceForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
          // 收集表单数据
          const formData = new FormData(sourceForm);
          const sourceData = {
            name: formData.get('name'),
            url: formData.get('url'),
            group: formData.get('group'),
            icon: formData.get('icon'),
            enabled: formData.get('enabled') === 'on',
            
            searchUrl: formData.get('searchUrl'),
            searchList: formData.get('searchList'),
            searchName: formData.get('searchName'),
            searchAuthor: formData.get('searchAuthor'),
            searchDetail: formData.get('searchDetail'),
            
            detailName: formData.get('detailName'),
            detailAuthor: formData.get('detailAuthor'),
            detailCover: formData.get('detailCover'),
            detailIntro: formData.get('detailIntro'),
            detailChapterUrl: formData.get('detailChapterUrl'),
            
            chapterList: formData.get('chapterList'),
            chapterName: formData.get('chapterName'),
            chapterLink: formData.get('chapterLink'),
            
            contentRule: formData.get('contentRule'),
          };
          
          // 处理内容过滤规则
          const contentFilters = formData.get('contentFilters');
          if (contentFilters) {
            sourceData.contentFilter = contentFilters.split(',').map(f => f.trim()).filter(Boolean);
          }
          
          // 保存书源
          const token = localStorage.getItem('token');
          const response = await fetch('/api/booksource/sources', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(sourceData)
          });
          
          if (!response.ok) {
            throw new Error('保存书源失败');
          }
          
          const data = await response.json();
          if (!data.success) {
            throw new Error(data.message || '保存书源失败');
          }
          
          // 提示成功
          alert(data.message || '保存书源成功');
          
          // 重置表单
          resetForm();
          
          // 切换到书源列表并刷新
          document.getElementById('tabSources').click();
          loadBookSources();
          
        } catch (error) {
          console.error('保存书源失败:', error);
          alert(`保存书源失败: ${error.message}`);
        }
      });
      
      // 重置按钮
      document.getElementById('resetBtn').addEventListener('click', function() {
        resetForm();
      });
      
      // 验证管理员权限
      checkAdminAccess();
      
      // 导出功能配置
      setupExportFunctions();
      
      // 导入功能配置
      setupImportFunctions();
      
      // 测试功能配置
      setupTestFunctions();
    });
    
    // 重置表单
    function resetForm() {
      // 设置为添加模式
      document.getElementById('editMode').value = 'add';
      
      // 清空表单
      document.getElementById('sourceForm').reset();
      
      // 启用书源名称输入
      document.getElementById('sourceName').readOnly = false;
    }
    
    // 验证管理员权限
    async function checkAdminAccess() {
      try {
        // 获取当前登录的用户信息
        const token = localStorage.getItem('token');
        if (!token) {
          showAuthScreen();
          return;
        }
        
        const response = await fetch('/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('验证失败');
        }
        
        const data = await response.json();
        if (!data.user || data.user.role !== 'admin') {
          showAuthScreen();
          return;
        }
        
        // 显示管理员信息
        document.getElementById('loadingStatus').innerHTML = 
          `<i class="fas fa-check-circle text-green-500 mr-2"></i>管理员：${data.user.username}`;
          
        // 加载书源列表
        loadBookSources();
        
      } catch (error) {
        console.error('验证管理员权限失败:', error);
        showAuthScreen();
      }
    }
    
    // 显示需要管理员权限的屏幕
    function showAuthScreen() {
      document.getElementById('authScreen').style.display = 'flex';
    }
    
    // 设置导出功能
    function setupExportFunctions() {
      const exportAllCheckbox = document.getElementById('exportAll');
      const exportEnabledCheckbox = document.getElementById('exportEnabled');
      const exportByGroupCheckbox = document.getElementById('exportByGroup');
      const exportGroupSelect = document.getElementById('exportGroup');
      const exportBtn = document.getElementById('exportBtn');
      
      // 导出全部与仅导出启用的互斥
      exportAllCheckbox.addEventListener('change', function() {
        if (this.checked) {
          exportEnabledCheckbox.checked = false;
        }
      });
      
      exportEnabledCheckbox.addEventListener('change', function() {
        if (this.checked) {
          exportAllCheckbox.checked = false;
        }
      });
      
      // 按分组导出启用/禁用下拉框
      exportByGroupCheckbox.addEventListener('change', function() {
        exportGroupSelect.disabled = !this.checked;
        if (this.checked) {
          exportAllCheckbox.checked = false;
          exportEnabledCheckbox.checked = false;
        }
      });
      
      // 导出按钮点击事件
      exportBtn.addEventListener('click', exportBookSources);
    }
    
    // 导出书源
    async function exportBookSources() {
      try {
        // 获取选项
        const exportAll = document.getElementById('exportAll').checked;
        const exportEnabled = document.getElementById('exportEnabled').checked;
        const exportByGroup = document.getElementById('exportByGroup').checked;
        const exportGroup = document.getElementById('exportGroup').value;
        
        // 验证选项
        if (!exportAll && !exportEnabled && !exportByGroup) {
          alert('请选择导出方式');
          return;
        }
        
        if (exportByGroup && !exportGroup) {
          alert('请选择要导出的分组');
          return;
        }
        
        // 获取所有书源
        const token = localStorage.getItem('token');
        const response = await fetch('/api/booksource/sources', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('获取书源失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '获取书源失败');
        }
        
        let sourcesToExport = data.data;
        
        // 根据选项筛选
        if (exportEnabled) {
          sourcesToExport = sourcesToExport.filter(source => source.enabled);
        }
        
        if (exportByGroup) {
          sourcesToExport = sourcesToExport.filter(source => source.group === exportGroup);
        }
        
        if (sourcesToExport.length === 0) {
          alert('没有符合条件的书源可导出');
          return;
        }
        
        // 创建并下载JSON文件
        const fileName = exportByGroup ? 
          `书源_${exportGroup}_${formatDate(new Date())}.json` : 
          `书源备份_${formatDate(new Date())}.json`;
        
        const json = JSON.stringify(sourcesToExport, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        
        // 清理
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        
      } catch (error) {
        console.error('导出书源失败:', error);
        alert(`导出书源失败: ${error.message}`);
      }
    }
    
    // 格式化日期为 YYYYMMDD 格式
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}${month}${day}`;
    }
    
    // 加载书源列表
    async function loadBookSources() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/booksource/sources', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('获取书源失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '获取书源失败');
        }
        
        // 渲染书源列表
        renderBookSources(data.data);
        
        // 加载书源分组
        loadSourceGroups(data.data);
        
        // 更新导出分组下拉框
        updateExportGroups(data.data);
        
        // 更新测试书源选择器
        loadTestSourceSelect(data.data);
        
      } catch (error) {
        console.error('加载书源列表失败:', error);
        document.getElementById('sourceListContainer').innerHTML = 
          `<div class="text-center py-8 text-red-500">
            <i class="fas fa-exclamation-circle text-xl mb-2"></i>
            <p>加载书源失败: ${error.message}</p>
          </div>`;
      }
    }
    
    // 渲染书源列表
    function renderBookSources(sources) {
      const container = document.getElementById('sourceListContainer');
      
      if (!sources || sources.length === 0) {
        container.innerHTML = 
          `<div class="text-center py-8 text-gray-500">
            <i class="fas fa-info-circle text-xl mb-2"></i>
            <p>暂无书源，请添加新书源或导入书源</p>
          </div>`;
        return;
      }
      
      let html = `
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分组</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
      `;
      
      sources.forEach(source => {
        html += `
          <tr class="source-item">
            <td class="px-4 py-3 whitespace-nowrap">
              <div class="flex items-center">
                ${source.icon ? `<img src="${source.icon}" class="h-6 w-6 mr-2">` : 
                  `<div class="h-6 w-6 mr-2 bg-gray-200 rounded-full flex items-center justify-center">
                    <i class="fas fa-book text-xs text-gray-500"></i>
                  </div>`}
                <span class="font-medium">${source.name}</span>
              </div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
              <span class="text-sm text-gray-500">${source.group || '未分组'}</span>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
              <a href="${source.url}" target="_blank" class="text-sm text-blue-500 hover:underline truncate max-w-xs inline-block">
                ${source.url}
              </a>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
              ${source.enabled ? 
                `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  <i class="fas fa-check-circle mr-1"></i>启用
                </span>` : 
                `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                  <i class="fas fa-ban mr-1"></i>禁用
                </span>`
              }
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm">
              <div class="flex space-x-2">
                <button class="text-blue-500 hover:text-blue-700" onclick="editSource('${source.name}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="text-green-500 hover:text-green-700" onclick="testSource('${source.name}')">
                  <i class="fas fa-vial"></i>
                </button>
                <button class="text-red-500 hover:text-red-700" onclick="deleteSource('${source.name}')">
                  <i class="fas fa-trash"></i>
                </button>
                <button class="${source.enabled ? 'text-orange-500 hover:text-orange-700' : 'text-gray-500 hover:text-gray-700'}" 
                  onclick="toggleSource('${source.name}', ${!source.enabled})">
                  <i class="fas ${source.enabled ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // 加载书源分组
    function loadSourceGroups(sources) {
      if (!sources || sources.length === 0) return;
      
      // 获取所有分组
      const groups = [...new Set(sources.map(source => source.group).filter(Boolean))];
      
      // 填充分组下拉框
      const select = document.getElementById('sourceGroup');
      groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        select.appendChild(option);
      });
      
      // 添加筛选功能
      select.addEventListener('change', function() {
        const group = this.value;
        const filtered = group ? sources.filter(s => s.group === group) : sources;
        renderBookSources(filtered);
      });
      
      // 添加搜索功能
      const searchInput = document.getElementById('sourceSearch');
      searchInput.addEventListener('input', function() {
        const keyword = this.value.toLowerCase();
        const group = select.value;
        
        let filtered = sources;
        
        // 先按分组筛选
        if (group) {
          filtered = filtered.filter(s => s.group === group);
        }
        
        // 再按关键字筛选
        if (keyword) {
          filtered = filtered.filter(s => 
            s.name.toLowerCase().includes(keyword) || 
            s.url.toLowerCase().includes(keyword)
          );
        }
        
        renderBookSources(filtered);
      });
    }
    
    // 更新导出分组下拉框
    function updateExportGroups(sources) {
      if (!sources || sources.length === 0) return;
      
      // 获取所有分组
      const groups = [...new Set(sources.map(source => source.group).filter(Boolean))];
      
      // 填充分组下拉框
      const select = document.getElementById('exportGroup');
      
      // 清空旧选项（保留第一个）
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // 添加新选项
      groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        select.appendChild(option);
      });
    }
    
    // 编辑书源
    async function editSource(name) {
      try {
        // 切换到添加/编辑面板
        document.getElementById('tabAdd').click();
        
        // 获取书源详情
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/booksource/sources/${name}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('获取书源详情失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '获取书源详情失败');
        }
        
        const source = data.data;
        
        // 设置编辑模式
        document.getElementById('editMode').value = 'edit';
        
        // 填充表单
        document.getElementById('sourceName').value = source.name;
        document.getElementById('sourceName').readOnly = true; // 不允许修改书源名称
        document.getElementById('sourceUrl').value = source.url || '';
        document.getElementById('sourceGroup').value = source.group || '';
        document.getElementById('sourceIcon').value = source.icon || '';
        document.getElementById('sourceEnabled').checked = source.enabled !== false;
        
        // 搜索规则
        document.getElementById('searchUrl').value = source.searchUrl || '';
        document.getElementById('searchList').value = source.searchList || '';
        document.getElementById('searchName').value = source.searchName || '';
        document.getElementById('searchAuthor').value = source.searchAuthor || '';
        document.getElementById('searchDetail').value = source.searchDetail || '';
        
        // 详情页规则
        document.getElementById('detailName').value = source.detailName || '';
        document.getElementById('detailAuthor').value = source.detailAuthor || '';
        document.getElementById('detailCover').value = source.detailCover || '';
        document.getElementById('detailIntro').value = source.detailIntro || '';
        document.getElementById('detailChapterUrl').value = source.detailChapterUrl || '';
        
        // 章节列表规则
        document.getElementById('chapterList').value = source.chapterList || '';
        document.getElementById('chapterName').value = source.chapterName || '';
        document.getElementById('chapterLink').value = source.chapterLink || '';
        
        // 内容规则
        document.getElementById('contentRule').value = source.contentRule || '';
        document.getElementById('contentFilters').value = 
          Array.isArray(source.contentFilter) ? source.contentFilter.join(',') : source.contentFilter || '';
        
      } catch (error) {
        console.error('编辑书源失败:', error);
        alert(`编辑书源失败: ${error.message}`);
      }
    }
    
    // 测试书源
    function testSource(name) {
      // 切换到测试面板
      document.getElementById('tabTest').click();
      
      // 选中书源
      const select = document.getElementById('testSourceName');
      for (let i = 0; i < select.options.length; i++) {
        if (select.options[i].value === name) {
          select.selectedIndex = i;
          break;
        }
      }
      
      // 提示用户
      alert('已切换到测试面板，请输入搜索关键词并点击"测试搜索"按钮进行测试。');
    }
    
    // 删除书源
    async function deleteSource(name) {
      try {
        // 确认删除
        if (!confirm(`确定要删除书源"${name}"吗？`)) {
          return;
        }
        
        // 发送删除请求
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/booksource/sources/${name}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('删除书源失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '删除书源失败');
        }
        
        // 提示成功
        alert(`书源"${name}"已成功删除`);
        
        // 刷新书源列表
        loadBookSources();
        
      } catch (error) {
        console.error('删除书源失败:', error);
        alert(`删除书源失败: ${error.message}`);
      }
    }
    
    // 启用/禁用书源
    async function toggleSource(name, enabled) {
      try {
        // 发送请求
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/booksource/sources/${name}/enabled`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ enabled })
        });
        
        if (!response.ok) {
          throw new Error(`${enabled ? '启用' : '禁用'}书源失败`);
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || `${enabled ? '启用' : '禁用'}书源失败`);
        }
        
        // 提示成功
        alert(`书源"${name}"已${enabled ? '启用' : '禁用'}`);
        
        // 刷新书源列表
        loadBookSources();
        
      } catch (error) {
        console.error(`${enabled ? '启用' : '禁用'}书源失败:`, error);
        alert(`${enabled ? '启用' : '禁用'}书源失败: ${error.message}`);
      }
    }
    
    // 设置导入功能
    function setupImportFunctions() {
      // 导入方式切换
      const importTabs = document.querySelectorAll('[data-import-tab]');
      importTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // 更新标签样式
          importTabs.forEach(t => {
            t.classList.remove('tab-active');
            t.classList.add('text-gray-500');
          });
          this.classList.add('tab-active');
          this.classList.remove('text-gray-500');
          
          // 切换面板
          const tabId = this.dataset.importTab;
          document.getElementById('fileImport').style.display = tabId === 'fileImport' ? 'block' : 'none';
          document.getElementById('textImport').style.display = tabId === 'textImport' ? 'block' : 'none';
        });
      });
      
      // 文件选择按钮
      const fileSelectBtn = document.getElementById('fileSelectBtn');
      const fileInput = document.getElementById('fileInput');
      fileSelectBtn.addEventListener('click', () => {
        fileInput.click();
      });
      
      // 文件选择处理
      fileInput.addEventListener('change', handleFileSelect);
      
      // 拖放文件
      const dropZone = document.querySelector('.border-dashed');
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-blue-500');
      });
      
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-blue-500');
      });
      
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500');
        
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          handleFileSelect(e);
        }
      });
      
      // 清除文件按钮
      document.getElementById('fileClearBtn').addEventListener('click', () => {
        fileInput.value = '';
        document.getElementById('fileInfo').classList.add('hidden');
      });
      
      // 导入按钮
      document.getElementById('importBtn').addEventListener('click', importBookSources);
    }
    
    // 处理文件选择
    function handleFileSelect(e) {
      const fileInput = document.getElementById('fileInput');
      const fileInfo = document.getElementById('fileInfo');
      const fileName = document.getElementById('fileName');
      const fileSize = document.getElementById('fileSize');
      
      if (fileInput.files.length === 0) return;
      
      const file = fileInput.files[0];
      
      // 验证文件类型
      if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
        alert('请选择JSON格式的文件');
        fileInput.value = '';
        return;
      }
      
      // 显示文件信息
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      fileInfo.classList.remove('hidden');
    }
    
    // 格式化文件大小
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }
    
    // 导入书源
    async function importBookSources() {
      try {
        // 获取选项
        const overwrite = document.getElementById('importOverwrite').checked;
        const autoEnable = document.getElementById('importEnable').checked;
        
        let sourcesData;
        
        // 根据当前选中的导入方式获取数据
        const isFileImport = document.getElementById('fileImport').style.display !== 'none';
        
        if (isFileImport) {
          // 从文件导入
          const fileInput = document.getElementById('fileInput');
          if (!fileInput.files.length) {
            alert('请选择要导入的文件');
            return;
          }
          
          const file = fileInput.files[0];
          sourcesData = await readJSONFile(file);
        } else {
          // 从文本导入
          const importText = document.getElementById('importText').value.trim();
          if (!importText) {
            alert('请输入要导入的JSON数据');
            return;
          }
          
          try {
            sourcesData = JSON.parse(importText);
          } catch (error) {
            alert('JSON格式不正确，请检查输入');
            return;
          }
        }
        
        // 确保数据是数组格式
        if (!Array.isArray(sourcesData)) {
          sourcesData = [sourcesData];
        }
        
        // 验证数据
        if (sourcesData.length === 0) {
          alert('没有有效的书源数据');
          return;
        }
        
        // 确认导入
        if (!confirm(`确定要导入 ${sourcesData.length} 个书源吗？${overwrite ? '（将覆盖同名书源）' : ''}`)) {
          return;
        }
        
        // 为每个书源设置启用状态
        if (autoEnable) {
          sourcesData = sourcesData.map(source => ({
            ...source,
            enabled: true
          }));
        }
        
        // 显示状态
        const importStatus = document.getElementById('importStatus');
        importStatus.innerHTML = `<div class="text-blue-500"><i class="fas fa-spinner fa-spin mr-2"></i>正在导入...</div>`;
        
        // 提交数据
        const token = localStorage.getItem('token');
        const response = await fetch('/api/booksource/sources/import', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sources: sourcesData,
            overwrite: overwrite
          })
        });
        
        if (!response.ok) {
          throw new Error('导入书源失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '导入书源失败');
        }
        
        // 显示成功信息
        importStatus.innerHTML = `<div class="text-green-500"><i class="fas fa-check-circle mr-2"></i>成功导入 ${data.data.count} 个书源</div>`;
        
        // 重置文件输入
        if (isFileImport) {
          document.getElementById('fileInput').value = '';
          document.getElementById('fileInfo').classList.add('hidden');
        } else {
          document.getElementById('importText').value = '';
        }
        
        // 刷新书源列表
        loadBookSources();
        
      } catch (error) {
        console.error('导入书源失败:', error);
        const importStatus = document.getElementById('importStatus');
        importStatus.innerHTML = `<div class="text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>${error.message}</div>`;
      }
    }
    
    // 读取JSON文件
    function readJSONFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            resolve(data);
          } catch (error) {
            reject(new Error('无效的JSON文件'));
          }
        };
        
        reader.onerror = () => {
          reject(new Error('读取文件失败'));
        };
        
        reader.readAsText(file);
      });
    }
    
    // 测试书源功能
    function setupTestFunctions() {
      // 获取元素
      const testSourceSelect = document.getElementById('testSourceName');
      const testKeywordInput = document.getElementById('testKeyword');
      const testSearchBtn = document.getElementById('testSearchBtn');
      const testClearBtn = document.getElementById('testClearBtn');
      const testResults = document.getElementById('testResults');
      
      // 清除结果按钮
      testClearBtn.addEventListener('click', () => {
        testResults.style.display = 'none';
        document.getElementById('bookDetailSection').style.display = 'none';
        document.getElementById('chapterListSection').style.display = 'none';
        document.getElementById('chapterContentSection').style.display = 'none';
      });
      
      // 测试搜索按钮
      testSearchBtn.addEventListener('click', async () => {
        const sourceName = testSourceSelect.value;
        const keyword = testKeywordInput.value.trim();
        
        if (!sourceName) {
          alert('请选择要测试的书源');
          return;
        }
        
        if (!keyword) {
          alert('请输入搜索关键词');
          return;
        }
        
        await testSearch(sourceName, keyword);
      });
    }
    
    // 测试书源搜索功能
    async function testSearch(sourceName, keyword) {
      try {
        // 显示结果区域和加载状态
        document.getElementById('testResults').style.display = 'block';
        document.getElementById('searchResultsContent').innerHTML = '<div class="loader"></div>';
        
        // 隐藏其他结果区域
        document.getElementById('bookDetailSection').style.display = 'none';
        document.getElementById('chapterListSection').style.display = 'none';
        document.getElementById('chapterContentSection').style.display = 'none';
        
        // 发送搜索请求
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/booksource/search?keyword=${encodeURIComponent(keyword)}&source=${encodeURIComponent(sourceName)}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('搜索失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '搜索失败');
        }
        
        // 渲染搜索结果
        renderSearchResults(data.data, sourceName);
        
      } catch (error) {
        console.error('测试搜索失败:', error);
        document.getElementById('searchResultsContent').innerHTML = 
          `<div class="text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>${error.message}</div>`;
      }
    }
    
    // 渲染搜索结果
    function renderSearchResults(results, sourceName) {
      const container = document.getElementById('searchResultsContent');
      
      if (!results || results.length === 0) {
        container.innerHTML = '<div class="text-gray-500">没有找到匹配的结果</div>';
        return;
      }
      
      let html = `
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">书名</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">作者</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
      `;
      
      results.forEach((book, index) => {
        html += `
          <tr>
            <td class="px-4 py-2 whitespace-nowrap">
              <span class="font-medium">${book.name || '未知'}</span>
            </td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
              ${book.author || '未知'}
            </td>
            <td class="px-4 py-2 whitespace-nowrap text-sm">
              <button class="text-blue-500 hover:text-blue-700" 
                onclick="testBookDetail('${sourceName}', '${encodeURIComponent(book.url)}')">
                查看详情
              </button>
            </td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // 测试书籍详情
    async function testBookDetail(sourceName, bookUrl) {
      try {
        // 显示详情区域和加载状态
        const detailSection = document.getElementById('bookDetailSection');
        detailSection.style.display = 'block';
        document.getElementById('bookDetailContent').innerHTML = '<div class="loader"></div>';
        
        // 隐藏后续区域
        document.getElementById('chapterListSection').style.display = 'none';
        document.getElementById('chapterContentSection').style.display = 'none';
        
        // 解码URL
        bookUrl = decodeURIComponent(bookUrl);
        
        // 发送请求
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/booksource/book/detail?url=${encodeURIComponent(bookUrl)}&sourceName=${encodeURIComponent(sourceName)}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('获取书籍详情失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '获取书籍详情失败');
        }
        
        // 渲染书籍详情
        renderBookDetail(data.data, sourceName);
        
      } catch (error) {
        console.error('测试书籍详情失败:', error);
        document.getElementById('bookDetailContent').innerHTML = 
          `<div class="text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>${error.message}</div>`;
      }
    }
    
    // 渲染书籍详情
    function renderBookDetail(detail, sourceName) {
      const container = document.getElementById('bookDetailContent');
      
      if (!detail) {
        container.innerHTML = '<div class="text-gray-500">没有找到书籍详情</div>';
        return;
      }
      
      let html = `
        <div class="flex flex-col md:flex-row">
          <div class="md:w-1/4 mb-4 md:mb-0 md:mr-4">
            ${detail.cover ? 
              `<img src="${detail.cover}" alt="${detail.name}" class="w-full max-w-xs rounded-md shadow-sm">` : 
              `<div class="w-full h-40 bg-gray-200 rounded-md flex items-center justify-center">
                <i class="fas fa-book text-gray-400 text-4xl"></i>
              </div>`
            }
          </div>
          <div class="md:w-3/4">
            <h3 class="text-xl font-bold mb-2">${detail.name || '未知书名'}</h3>
            <div class="space-y-2 mb-4">
              <p><span class="font-medium">作者：</span>${detail.author || '未知'}</p>
              <p><span class="font-medium">最新章节：</span>${detail.latestChapter || '未知'}</p>
              <p><span class="font-medium">更新时间：</span>${detail.updateTime || '未知'}</p>
            </div>
            <div class="mb-4">
              <p class="font-medium mb-1">简介：</p>
              <p class="text-sm text-gray-700">${detail.intro || '暂无简介'}</p>
            </div>
            <div>
              <button class="px-3 py-1 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700"
                onclick="testChapterList('${sourceName}', '${encodeURIComponent(detail.chapterUrl || detail.url)}')">
                获取章节列表
              </button>
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // 测试章节列表
    async function testChapterList(sourceName, chapterUrl) {
      try {
        // 显示章节列表区域和加载状态
        const chapterSection = document.getElementById('chapterListSection');
        chapterSection.style.display = 'block';
        document.getElementById('chapterListContent').innerHTML = '<div class="loader"></div>';
        
        // 隐藏章节内容区域
        document.getElementById('chapterContentSection').style.display = 'none';
        
        // 解码URL
        chapterUrl = decodeURIComponent(chapterUrl);
        
        // 发送请求
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/booksource/book/chapters?url=${encodeURIComponent(chapterUrl)}&sourceName=${encodeURIComponent(sourceName)}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('获取章节列表失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '获取章节列表失败');
        }
        
        // 渲染章节列表
        renderChapterList(data.data, sourceName);
        
      } catch (error) {
        console.error('测试章节列表失败:', error);
        document.getElementById('chapterListContent').innerHTML = 
          `<div class="text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>${error.message}</div>`;
      }
    }
    
    // 渲染章节列表
    function renderChapterList(chapters, sourceName) {
      const container = document.getElementById('chapterListContent');
      
      if (!chapters || chapters.length === 0) {
        container.innerHTML = '<div class="text-gray-500">没有找到章节</div>';
        return;
      }
      
      let html = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">`;
      
      chapters.forEach((chapter, index) => {
        html += `
          <div class="text-sm">
            <a href="javascript:void(0)" class="hover:text-blue-500 hover:underline"
              onclick="testChapterContent('${sourceName}', '${encodeURIComponent(chapter.url)}', '${encodeURIComponent(chapter.name)}')">
              ${chapter.name || `第${index + 1}章`}
            </a>
          </div>
        `;
      });
      
      html += `</div>`;
      
      container.innerHTML = html;
    }
    
    // 测试章节内容
    async function testChapterContent(sourceName, chapterUrl, chapterName) {
      try {
        // 显示章节内容区域和加载状态
        const contentSection = document.getElementById('chapterContentSection');
        contentSection.style.display = 'block';
        document.getElementById('chapterContentInfo').textContent = decodeURIComponent(chapterName);
        document.getElementById('chapterContentDisplay').innerHTML = '<div class="loader"></div>';
        
        // 解码URL
        chapterUrl = decodeURIComponent(chapterUrl);
        
        // 发送请求
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/booksource/book/content?url=${encodeURIComponent(chapterUrl)}&sourceName=${encodeURIComponent(sourceName)}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('获取章节内容失败');
        }
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.message || '获取章节内容失败');
        }
        
        // 渲染章节内容
        renderChapterContent(data.data);
        
      } catch (error) {
        console.error('测试章节内容失败:', error);
        document.getElementById('chapterContentDisplay').innerHTML = 
          `<div class="text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>${error.message}</div>`;
      }
    }
    
    // 渲染章节内容
    function renderChapterContent(content) {
      const container = document.getElementById('chapterContentDisplay');
      
      if (!content) {
        container.innerHTML = '<div class="text-gray-500">没有找到章节内容</div>';
        return;
      }
      
      // 将内容按段落分割并格式化
      const paragraphs = content.split(/\n+/).filter(Boolean);
      
      if (paragraphs.length === 0) {
        container.innerHTML = '<div class="text-gray-500">章节内容为空</div>';
        return;
      }
      
      let html = `<div class="space-y-4">`;
      
      paragraphs.forEach(paragraph => {
        html += `<p class="text-gray-800">${paragraph}</p>`;
      });
      
      html += `</div>`;
      
      container.innerHTML = html;
    }
    
    // 加载所有书源到测试选择器
    function loadTestSourceSelect(sources) {
      if (!sources || sources.length === 0) return;
      
      const select = document.getElementById('testSourceName');
      
      // 清空选项（保留第一个）
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // 只添加启用的书源
      const enabledSources = sources.filter(source => source.enabled);
      
      // 按分组组织书源
      const sourcesByGroup = {};
      enabledSources.forEach(source => {
        const group = source.group || '未分组';
        if (!sourcesByGroup[group]) {
          sourcesByGroup[group] = [];
        }
        sourcesByGroup[group].push(source);
      });
      
      // 添加分组和选项
      Object.keys(sourcesByGroup).sort().forEach(group => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = group;
        
        sourcesByGroup[group].sort((a, b) => a.name.localeCompare(b.name)).forEach(source => {
          const option = document.createElement('option');
          option.value = source.name;
          option.textContent = source.name;
          optgroup.appendChild(option);
        });
        
        select.appendChild(optgroup);
      });
    }
  </script>
</body>
</html> 